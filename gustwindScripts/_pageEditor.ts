import{produce as T}from"https://cdn.skypack.dev/immer@9.0.6?min";import{nanoid as X}from"https://cdn.skypack.dev/nanoid@3.1.30?min";function p({element:t,handle:e,xPosition:i},r){if(!t){console.warn("drag is missing elem!");return}H(t,"touchstart","touchmove","touchend",r,e,i),H(t,"mousedown","mousemove","mouseup",r,e,i)}function H(t,e,i,r,n,o,s){n=O(n,s="left");let a=n.begin,l=n.change,c=n.end;y(o||t,e,m=>{let M=$=>h(l,t,$);function S(){P(document,i,M),P(document,r,S),h(c,t,m)}y(document,i,M),y(document,r,S),h(a,t,m)})}function y(t,e,i){let r=!1;try{let n=Object.defineProperty({},"passive",{get:function(){r=!0}});globalThis.addEventListener("testPassive",null,n),globalThis.removeEventListener("testPassive",null,n)}catch(n){console.error(n)}t.addEventListener(e,i,r?{passive:!1}:!1)}function P(t,e,i){t.removeEventListener(e,i,!1)}function O(t,e="left"){if(t)return{begin:t.begin||g,change:t.change||g,end:t.end||g};let i,r;return{begin:function(n){let o=document.body.clientWidth;i={x:e==="left"?n.elem.offsetLeft:o-n.elem.offsetLeft-n.elem.clientWidth,y:n.elem.offsetTop},r=e==="left"?n.cursor:{x:o-n.cursor.x,y:n.cursor.y}},change:function(n){if(typeof i.x!="number"||typeof n.cursor.x!="number"||typeof r.x!="number")return;let o=document.body.clientWidth;_(n.elem,e,e==="left"?i.x+n.cursor.x-r.x+"px":i.x+(o-n.cursor.x)-r.x+"px"),!(typeof i.y!="number"||typeof n.cursor.y!="number"||typeof r.y!="number")&&_(n.elem,"top",i.y+n.cursor.y-r.y+"px")},end:g}}function _(t,e,i){t.style[e]=i}function g(){}function h(t,e,i){i.preventDefault();let r=W(e),n=e.clientWidth,o=e.clientHeight,s={x:B(e,i),y:I(e,i)};if(typeof s.x!="number"||typeof s.y!="number")return;let a=(s.x-r.x)/n,l=(s.y-r.y)/o;t({x:isNaN(a)?0:a,y:isNaN(l)?0:l,cursor:s,elem:e,e:i})}function W(t){let e=t.getBoundingClientRect();return{x:e.left,y:e.top}}function B(t,e){return e instanceof TouchEvent?e.touches.item(0)?.clientX:e.clientX}function I(t,e){return e instanceof TouchEvent?e.touches.item(0)?.clientY:e.clientY}import{tw as x}from"https://cdn.skypack.dev/twind@0.16.16?min";var b=t=>typeof t=="object";function d(t,e){let i=t;return e.split(".").forEach(r=>{b(i)&&(i=i[r])}),i}async function E(t,e,i){if(!e)return Promise.resolve({content:i});if("Deno"in globalThis){let r=await import("https://deno.land/std@0.107.0/path/mod.ts");return(await Promise.all(e.map(o=>{let s=r.join(t,`${o}.ts`);return Deno.env.get("DEBUG")==="1"&&console.log("importing transform",s,t,o),import("file://"+s)}))).reduce((o,s)=>s.default(o),i)}return Promise.all(e.map(r=>import(`/transforms/${r}.js`)))}async function u(t,e,i,r){if(typeof e=="string")return e;let n=e.element&&i[e.element];if(e.__bind&&(b(e.__bind)?r={...r,__bound:e.__bind}:r={...r,__bound:d(r,e.__bind)}),n){if(Array.isArray(n))return await u(t,{element:"",children:n},i,r);e={...e,...n,class:F(e.class,n.class)}}if(e?.transformWith){let a;if(typeof e.inputText=="string")a=await E(t,e?.transformWith,e.inputText);else if(typeof e.inputProperty=="string"){let l=d(r,e.inputProperty);if(!l)throw console.error("Missing input",r,e.inputProperty),new Error("Missing input");a=await E(t,e?.transformWith,l)}r={...r,...a}}let o;if(e.__children){let a=e.__children,l=r.__bound||r;typeof a=="string"?o=d(l,a)||d(r,a):o=(await Promise.all((Array.isArray(l)?l:[l]).flatMap(c=>a.map(m=>u(t,m,i,{...r,__bound:c}))))).join("")}else if(e["==children"]){let a=e["==children"];o=C(a,r.__bound||r)}else o=Array.isArray(e.children)?(await Promise.all(e.children.map(async a=>await u(t,a,i,r)))).join(""):e.children;let s=N(e,r);return R(e.element,q(r,s?{...e.attributes,class:s}:e.attributes),o)}function N(t,e){let i=[];return t.__class&&Object.entries(t.__class).forEach(([r,n])=>{C(n,{attributes:t.attributes,context:e})&&i.push(x(r))}),t.class?x(i.concat(t.class.split(" ")).join(" ")):i.join(" ")}function F(t,e){return t?e?`${t} ${e}`:t:e||""}function R(t,e,i){return t?`<${t}${e}>${i||""}</${t}>`:typeof i=="string"?i:""}function q(t,e){if(!e)return"";let i=Object.entries(e).map(([r,n])=>r.startsWith("__")?`${r.slice(2)}="${d(t.__bound,n)||d(t,n)}"`:r.startsWith("==")?`${r.slice(2)}="${C(n,t.__bound||t)}"`:`${r}="${n}"`).filter(Boolean).join(" ");return i.length>0?" "+i:""}function C(t,e={}){try{return Function.apply(null,Object.keys(e).concat(`return ${t}`))(...Object.values(e))}catch(i){console.error("Failed to evaluate",t,e,i)}}function k(){let t=document.querySelector('meta[name="pagepath"]');if(!t){console.error("path element was not found!");return}let e=t.getAttribute("content");if(!e){console.log("pagePath was not found in path element");return}return e}var Y="document-tree-element",J="controls-element";async function z(){console.log("create editor");let[t,e,i]=await Promise.all([fetch("/components.json").then(a=>a.json()),fetch("./context.json").then(a=>a.json()),fetch("./definition.json").then(a=>a.json())]),r=G(i),n=document.createElement("div");n.setAttribute("x-label","selected"),n.setAttribute("x-state","{ componentId: undefined }"),r.appendChild(n);let o=await K(t,e);n.append(o);let s=await Q(t,e);n.append(s),document.body.appendChild(r),evaluateAllDirectives()}var v="editors";function G(t){let e=document.getElementById(v);return e?.remove(),e=document.createElement("div"),e.id=v,e.style.visibility="visible",e.setAttribute("x-state",JSON.stringify({...t,body:U(t.body)})),e.setAttribute("x-label","editor"),e}function be(){let t=document.getElementById(v);!t||(t.style.visibility=t.style.visibility==="visible"?"hidden":"visible")}function U(t){return T(t,e=>{f(e,i=>{i._id=X()})})}function V(t){let e=T(t.body,r=>{f(r,n=>{delete n._id,n.class===""&&delete n.class})}),i={path:k(),data:{...t,body:e}};window.developmentSocket.send(JSON.stringify({type:"update",payload:i}))}async function K(t,e){console.log("Creating page editor");let i=document.createElement("div");i.id=Y,i.innerHTML=await u("",t.PageEditor,t,e);let r=i.children[0],n=r.children[0];return p({element:r,handle:n}),i}async function Q(t,e){let i=document.createElement("div");i.id=J,i.innerHTML=await u("",t.ComponentEditor,t,e);let r=i.children[0],n=r.children[0];return p({element:r,handle:n,xPosition:"right"}),i}function Z(t,e){let{editor:{meta:i}}=getState(t),r=t.dataset.field;if(!r){console.error(`${r} was not found in ${t.dataset}`);return}if(r==="title"){let n=document.querySelector("title");n?n.innerHTML=e||"":console.warn("The page doesn't have a <title>!")}else{let n=document.head.querySelector("meta[name='"+r+"']");n?n.setAttribute("content",e):console.warn(`The page doesn't have a ${r} meta element!`)}setState({meta:{...i,[r]:e}},{element:t,parent:"editor"})}var w=new Set;function ee(t,e){event?.stopPropagation();let{editor:{body:i}}=getState(t),r=n=>{let o=n.target;if(!o){console.warn("inputListener - No element found");return}n.preventDefault(),A(t,o.textContent)};for(let n of w.values())n.classList.remove("border"),n.classList.remove("border-red-800"),n.removeAttribute("contenteditable"),n.removeEventListener("focusout",r),w.delete(n);f(i,(n,o)=>{if(n._id===e){let s=j(document.body,o,i);s.classList.add("border"),s.classList.add("border-red-800"),s.setAttribute("contenteditable","true"),s.addEventListener("focusout",r),w.add(s)}}),setState({componentId:e},{element:t,parent:"selected"})}function te(t,e){let{editor:{body:i},selected:{componentId:r}}=getState(t),n=L(i,r,(o,s)=>{s?.replaceWith(ne(s,e)),o.element=e});setState({body:n},{element:t,parent:"editor"})}function ne(t,e){let i=document.createElement(e),r=t.cloneNode(!0);for(;r.firstChild;)i.appendChild(r.firstChild);for(let n of r.attributes)i.setAttribute(n.name,n.value);return i}function A(t,e){let{editor:{body:i},selected:{componentId:r}}=getState(t),n=L(i,r,(o,s)=>{s&&(s.innerHTML=e),o.children=e});setState({body:n},{element:t,parent:"editor"})}function re(t,e){let{editor:{body:i},selected:{componentId:r}}=getState(t),n=L(i,r,(o,s)=>{s&&(s.setAttribute("class",e),s.classList.add("border"),s.classList.add("border-red-800")),o.class=e});setState({body:n},{element:t,parent:"editor"})}function L(t,e,i){return T(t,r=>{f(r,(n,o)=>{n._id===e&&i(n,j(document.body,o,t))})})}function j(t,e,i){let r=0;function n(o,s){if(!o)return null;if(Array.isArray(s)){let a=o;for(let l of s){let c=n(a,l);if(c)return c;a=a?.nextElementSibling}}else{if(e===r)return o;if(r++,Array.isArray(s.children)){let a=n(o.firstElementChild,s.children);if(a)return a}}return null}return n(t?.firstElementChild,i)}function ie(t,e){let i={},{componentId:r}=e;return f(t.body,n=>{n._id===r&&(i=n)}),i}function f(t,e){let i=0;function r(n,o){Array.isArray(n)?n.forEach(s=>r(s,o)):(o(n,i),i++,Array.isArray(n.children)&&r(n.children,o))}r(t,e)}"Deno"in globalThis||(console.log("Hello from the page editor"),window.createEditor=z,window.metaChanged=Z,window.classChanged=D(re),window.elementClicked=ee,window.elementChanged=te,window.contentChanged=D(A),window.getSelectedComponent=ie,window.updateFileSystem=V);function D(t,e=100){let i;return(...r)=>{clearTimeout(i),i=setTimeout(()=>{t.apply(this,r)},e)}}export{z as createEditor,be as toggleEditorVisibility};
