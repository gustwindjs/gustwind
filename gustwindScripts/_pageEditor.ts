import{produce as T}from"https://cdn.skypack.dev/immer@9.0.6?min";import{nanoid as G}from"https://cdn.skypack.dev/nanoid@3.1.30?min";function C({element:t,handle:e,xPosition:r},n){if(!t){console.warn("drag is missing elem!");return}S(t,"touchstart","touchmove","touchend",n,e,r),S(t,"mousedown","mousemove","mouseup",n,e,r)}function S(t,e,r,n,o,i,s){o=$(o,s="left");let l=o.begin,a=o.change,d=o.end;E(i||t,e,m=>{let f=R=>v(a,t,R);function b(){H(document,r,f),H(document,n,b),v(d,t,m)}E(document,r,f),E(document,n,b),v(l,t,m)})}function E(t,e,r){let n=!1;try{let o=Object.defineProperty({},"passive",{get:function(){n=!0}});globalThis.addEventListener("testPassive",null,o),globalThis.removeEventListener("testPassive",null,o)}catch(o){console.error(o)}t.addEventListener(e,r,n?{passive:!1}:!1)}function H(t,e,r){t.removeEventListener(e,r,!1)}function $(t,e="left"){if(t)return{begin:t.begin||h,change:t.change||h,end:t.end||h};let r,n;return{begin:function(o){let i=document.body.clientWidth;r={x:e==="left"?o.elem.offsetLeft:i-o.elem.offsetLeft-o.elem.clientWidth,y:o.elem.offsetTop},n=e==="left"?o.cursor:{x:i-o.cursor.x,y:o.cursor.y}},change:function(o){if(typeof r.x!="number"||typeof o.cursor.x!="number"||typeof n.x!="number")return;let i=document.body.clientWidth;k(o.elem,e,e==="left"?r.x+o.cursor.x-n.x+"px":r.x+(i-o.cursor.x)-n.x+"px"),!(typeof r.y!="number"||typeof o.cursor.y!="number"||typeof n.y!="number")&&k(o.elem,"top",r.y+o.cursor.y-n.y+"px")},end:h}}function k(t,e,r){t.style[e]=r}function h(){}function v(t,e,r){r.preventDefault();let n=W(e),o=e.clientWidth,i=e.clientHeight,s={x:B(e,r),y:F(e,r)};if(typeof s.x!="number"||typeof s.y!="number")return;let l=(s.x-n.x)/o,a=(s.y-n.y)/i;t({x:isNaN(l)?0:l,y:isNaN(a)?0:a,cursor:s,elem:e,e:r})}function W(t){let e=t.getBoundingClientRect();return{x:e.left,y:e.top}}function B(t,e){return e instanceof TouchEvent?e.touches.item(0)?.clientX:e.clientX}function F(t,e){return e instanceof TouchEvent?e.touches.item(0)?.clientY:e.clientY}import{tw as A}from"https://cdn.skypack.dev/twind@0.16.16?min";var g=t=>!Array.isArray(t)&&typeof t=="object";function c(t,e){let r=t;return e.split(".").forEach(n=>{g(r)&&(r=r[n])}),r}async function w(t,e,r,n){if(!r)return Promise.resolve(n);if("Deno"in globalThis){let o=await import("https://deno.land/std@0.107.0/path/mod.ts");return(await Promise.all(r.map(s=>{let l=o.join(e,`${s}.ts`);return Deno.env.get("DEBUG")==="1"&&console.log("importing transform",l,e,s),t==="production"?import("file://"+l):import("file://"+l+"?cache="+new Date().getTime())}))).reduce((s,l)=>l.default(s),n)}return Promise.all(r.map(o=>import(`/transforms/${o}.js`)))}function x(t,e){return!t||!e?[]:Promise.all(Object.entries(e).map(([r,n])=>N(t,r,n)))}async function N(t,e,r){if(e.startsWith("__"))return[e.slice(2),c(t.__bound,r)||c(t,r)];if(e.startsWith("==")){let n=t.__bound||t;return[e.slice(2),await y(r,g(n)?n:{data:n})]}return[e,r]}function y(t,e={},r=!0){try{return Promise.resolve(Function.apply(null,Object.keys(e).concat(`return ${t}`))(...Object.values(e)))}catch(n){r&&console.error("Failed to evaluate",t,e,n)}}async function u(t,e,r,n,o={}){if(typeof e=="string")return e;if(e.visibleIf){let a=n.__bound||n;if(!P(a[e.visibleIf])||!await y(e.visibleIf,a,!1))return Promise.resolve("")}let i=e.element&&r[e.element];if(e.__bind&&(g(e.__bind)?n={...n,__bound:{...o,...n,render:a=>u(t,a,r,n,o),...q(e.__bind,n)}}:n={...n,__bound:c(n,e.__bind)||c(n.__bound,e.__bind)}),i){if(Array.isArray(i))return await u(t,{element:"",children:i},r,n,o);e={...e,...i,element:i.element,class:Y(e.class,i.class)}}if(e?.transformWith){let a;if(typeof e.inputText=="string")a=await w("production",t,e?.transformWith,e.inputText);else if(typeof e.inputProperty=="string"){let d=c(n,e.inputProperty);if(!d)throw console.error("Missing input",n,e.inputProperty),new Error("Missing input");a=await w("production",t,e?.transformWith,d)}n={...n,...a}}let s;if(e.__children){let a=e.__children,d=n.__bound||n;typeof a=="string"?s=c(d,a)||c(n,a):s=(await Promise.all((Array.isArray(d)?d:[d]).flatMap(m=>a.map(f=>u(t,f,r,{...n,__bound:m},o))))).join("")}else if(e["==children"]){let a=e["==children"],d=n.__bound||n;s=await y(a,g(d)?{...o,...d}:{...o,data:d})}else if(e.__foreach){let[a,d]=e.__foreach,m=n.__bound||n;s=(await Promise.all(m[a].flatMap(f=>(Array.isArray(d)?d:[d]).map(b=>u(t,b,r,{...n,__bound:f,match:f},o))))).join("")}else s=Array.isArray(e.children)?(await Promise.all(e.children.map(async a=>await u(t,a,r,n,o)))).join(""):e.children;let l=await X(e,n,o);return z(e.element,await J({...o,...n},l?{...e.attributes,class:l}:e.attributes),s)}function q(t,e){let r={};return Object.entries(t).forEach(([n,o])=>{r[n]=c(e,o)||o}),r}async function X(t,e,r){let n=[];return t.__class&&await Object.entries(t.__class).forEach(async([o,i])=>{await y(i,{attributes:t.attributes,context:{...r,...e}})&&n.push(A(o))}),t.class?A(n.concat(t.class.split(" ")).join(" ")):n.join(" ")}function Y(t,e){return t?e?`${t} ${e}`:t:e||""}function z(t,e,r){return t?`<${t}${e?" "+e:""}>${r||""}</${t}>`:typeof r=="string"?r:""}async function J(t,e){return e?(await x(t,e)).map(([n,o])=>P(o)?"":`${n}="${o}"`).join(" "):""}function P(t){return typeof t=="undefined"}function j(){let t=document.querySelector('meta[name="pagepath"]');if(!t){console.error("path element was not found!");return}let e=t.getAttribute("content");if(!e){console.log("pagePath was not found in path element");return}return e}var V="document-tree-element",K="controls-element";async function Q(){console.log("create editor");let[t,e,r,n]=await Promise.all([fetch("/components.json").then(a=>a.json()),fetch("./context.json").then(a=>a.json()),fetch("./layout.json").then(a=>a.json()),fetch("./route.json").then(a=>a.json())]),o=Z(r,n),i=document.createElement("div");i.setAttribute("x-label","selected"),i.setAttribute("x-state","{ componentId: undefined }"),o.appendChild(i);let s=await te(t,e);i.append(s);let l=await ne(t,e);i.append(l),document.body.appendChild(o),evaluateAllDirectives()}var L="editors";function Z(t,e){let r=document.getElementById(L);return r?.remove(),r=document.createElement("div"),r.id=L,r.style.visibility="visible",r.setAttribute("x-state",JSON.stringify({...t,body:U(t.body),meta:e.meta})),r.setAttribute("x-label","editor"),r}function _e(){let t=document.getElementById(L);!t||(t.style.visibility=t.style.visibility==="visible"?"hidden":"visible")}function U(t){if(!t){console.error("initializeBody - missing body");return}return T(t,e=>{p(e,r=>{r._id=G()})})}function ee(t){let e=T(t.body,n=>{p(n,o=>{delete o._id,o.class===""&&delete o.class})}),r={path:j(),data:{...t,body:e}};window.developmentSocket.send(JSON.stringify({type:"update",payload:r}))}async function te(t,e){console.log("creating page editor");let r=document.createElement("div");r.id=V,r.innerHTML=await u("",t.PageEditor,t,e);let n=r.children[0],o=n.children[0];return C({element:n,handle:o}),r}async function ne(t,e){let r=document.createElement("div");r.id=K,r.innerHTML=await u("",t.ComponentEditor,t,e);let n=r.children[0],o=n.children[0];return C({element:n,handle:o,xPosition:"right"}),r}function re(t,e){let{editor:{meta:r}}=getState(t),n=t.dataset.field;if(!n){console.error(`${n} was not found in ${t.dataset}`);return}if(n==="title"){let o=document.querySelector("title");o?o.innerHTML=e||"":console.warn("The page doesn't have a <title>!")}else{let o=document.head.querySelector("meta[name='"+n+"']");o?o.setAttribute("content",e):console.warn(`The page doesn't have a ${n} meta element!`)}setState({meta:{...r,[n]:e}},{element:t,parent:"editor"})}var _=new Set;function oe(t,e){event?.stopPropagation();let{editor:{body:r}}=getState(t),n=o=>{let i=o.target;if(!i){console.warn("inputListener - No element found");return}o.preventDefault(),D(t,i.textContent)};for(let o of _.values())o.classList.remove("border"),o.classList.remove("border-red-800"),o.removeAttribute("contenteditable"),o.removeEventListener("focusout",n),_.delete(o);p(r,(o,i)=>{if(o._id===e){let s=O(document.body,i,r);s.classList.add("border"),s.classList.add("border-red-800"),_.add(s),Array.isArray(o.children)||(s.setAttribute("contenteditable","true"),s.addEventListener("focusout",n))}}),setState({componentId:e},{element:t,parent:"selected"})}function ie(t,e){let{editor:{body:r},selected:{componentId:n}}=getState(t),o=M(r,n,(i,s)=>{s?.replaceWith(se(s,e)),i.element=e});setState({body:o},{element:t,parent:"editor"})}function se(t,e){let r=document.createElement(e),n=t.cloneNode(!0);for(;n.firstChild;)r.appendChild(n.firstChild);for(let o of n.attributes)r.setAttribute(o.name,o.value);return r}function D(t,e){let{editor:{body:r},selected:{componentId:n}}=getState(t),o=M(r,n,(i,s)=>{s&&(s.innerHTML=e),i.children=e});setState({body:o},{element:t,parent:"editor"})}function ae(t,e){let{editor:{body:r},selected:{componentId:n}}=getState(t),o=M(r,n,(i,s)=>{s&&(s.setAttribute("class",e),s.classList.add("border"),s.classList.add("border-red-800")),i.class=e});setState({body:o},{element:t,parent:"editor"})}function M(t,e,r){return T(t,n=>{p(n,(o,i)=>{o._id===e&&r(o,O(document.body,i,t))})})}function O(t,e,r){let n=0;function o(i,s){if(!i)return null;if(Array.isArray(s)){let l=i;for(let a of s){let d=o(l,a);if(d)return d;l=l?.nextElementSibling}}else{if(e===n)return i;if(n++,Array.isArray(s.children)){let l=o(i.firstElementChild,s.children);if(l)return l}}return null}return o(t?.firstElementChild,r)}function le(t,e){let r={},{componentId:n}=e;return p(t.body,o=>{o._id===n&&(r=o)}),r}function p(t,e){let r=0;function n(o,i){Array.isArray(o)?o.forEach(s=>n(s,i)):(i(o,r),r++,Array.isArray(o.children)&&n(o.children,i))}n(t,e)}"Deno"in globalThis||(console.log("Hello from the page editor"),window.createEditor=Q,window.metaChanged=re,window.classChanged=I(ae),window.elementClicked=oe,window.elementChanged=ie,window.contentChanged=I(D),window.getSelectedComponent=le,window.updateFileSystem=ee);function I(t,e=100){let r;return(...n)=>{clearTimeout(r),r=setTimeout(()=>{t.apply(this,n)},e)}}export{Q as createEditor,_e as toggleEditorVisibility};
