import{produce as v}from"https://cdn.skypack.dev/immer@9.0.6?min";import{nanoid as z}from"https://cdn.skypack.dev/nanoid@3.1.30?min";function y({element:t,handle:e,xPosition:n},o){if(!t){console.warn("drag is missing elem!");return}H(t,"touchstart","touchmove","touchend",o,e,n),H(t,"mousedown","mousemove","mouseup",o,e,n)}function H(t,e,n,o,r,i,s){r=I(r,s="left");let a=r.begin,l=r.change,c=r.end;h(i||t,e,p=>{let M=$=>b(l,t,$);function S(){_(document,n,M),_(document,o,S),b(c,t,p)}h(document,n,M),h(document,o,S),b(a,t,p)})}function h(t,e,n){let o=!1;try{let r=Object.defineProperty({},"passive",{get:function(){o=!0}});globalThis.addEventListener("testPassive",null,r),globalThis.removeEventListener("testPassive",null,r)}catch(r){console.error(r)}t.addEventListener(e,n,o?{passive:!1}:!1)}function _(t,e,n){t.removeEventListener(e,n,!1)}function I(t,e="left"){if(t)return{begin:t.begin||g,change:t.change||g,end:t.end||g};let n,o;return{begin:function(r){let i=document.body.clientWidth;n={x:e==="left"?r.elem.offsetLeft:i-r.elem.offsetLeft-r.elem.clientWidth,y:r.elem.offsetTop},o=e==="left"?r.cursor:{x:i-r.cursor.x,y:r.cursor.y}},change:function(r){if(typeof n.x!="number"||typeof r.cursor.x!="number"||typeof o.x!="number")return;let i=document.body.clientWidth;x(r.elem,e,e==="left"?n.x+r.cursor.x-o.x+"px":n.x+(i-r.cursor.x)-o.x+"px"),!(typeof n.y!="number"||typeof r.cursor.y!="number"||typeof o.y!="number")&&x(r.elem,"top",n.y+r.cursor.y-o.y+"px")},end:g}}function x(t,e,n){t.style[e]=n}function g(){}function b(t,e,n){n.preventDefault();let o=W(e),r=e.clientWidth,i=e.clientHeight,s={x:B(e,n),y:F(e,n)};if(typeof s.x!="number"||typeof s.y!="number")return;let a=(s.x-o.x)/r,l=(s.y-o.y)/i;t({x:isNaN(a)?0:a,y:isNaN(l)?0:l,cursor:s,elem:e,e:n})}function W(t){let e=t.getBoundingClientRect();return{x:e.left,y:e.top}}function B(t,e){return e instanceof TouchEvent?e.touches.item(0)?.clientX:e.clientX}function F(t,e){return e instanceof TouchEvent?e.touches.item(0)?.clientY:e.clientY}import{tw as k}from"https://cdn.skypack.dev/twind@0.16.16?min";var E=t=>typeof t=="object";function d(t,e){let n=t;return e.split(".").forEach(o=>{E(n)&&(n=n[o])}),n}async function C(t,e,n,o){if(!n)return Promise.resolve({content:o});if("Deno"in globalThis){let r=await import("https://deno.land/std@0.107.0/path/mod.ts");return(await Promise.all(n.map(s=>{let a=r.join(e,`${s}.ts`);return Deno.env.get("DEBUG")==="1"&&console.log("importing transform",a,e,s),t==="production"?import("file://"+a):import("file://"+a+"?cache="+new Date().getTime())}))).reduce((s,a)=>a.default(s),o)}return Promise.all(n.map(r=>import(`/transforms/${r}.js`)))}function A(t,e){return!t||!e?[]:Object.entries(e).map(([n,o])=>N(t,n,o))}function N(t,e,n){return e.startsWith("__")?[e.slice(2),d(t.__bound,n)||d(t,n)]:e.startsWith("==")?[e.slice(2),f(n,t.__bound||t)]:[e,n]}function f(t,e={}){try{return Function.apply(null,Object.keys(e).concat(`return ${t}`))(...Object.values(e))}catch(n){console.error("Failed to evaluate",t,e,n)}}async function u(t,e,n,o){if(typeof e=="string")return e;let r=e.element&&n[e.element];if(e.__bind&&(E(e.__bind)?o={...o,__bound:e.__bind}:o={...o,__bound:d(o,e.__bind)}),e.visibleIf){let a=e.visibleIf;if(!f(a,o.__bound||o))return Promise.resolve("")}if(r){if(Array.isArray(r))return await u(t,{element:"",children:r},n,o);e={...e,...r,element:r.element,class:q(e.class,r.class)}}if(e?.transformWith){let a;if(typeof e.inputText=="string")a=await C("production",t,e?.transformWith,e.inputText);else if(typeof e.inputProperty=="string"){let l=d(o,e.inputProperty);if(!l)throw console.error("Missing input",o,e.inputProperty),new Error("Missing input");a=await C("production",t,e?.transformWith,l)}o={...o,...a}}let i;if(e.__children){let a=e.__children,l=o.__bound||o;typeof a=="string"?i=d(l,a)||d(o,a):i=(await Promise.all((Array.isArray(l)?l:[l]).flatMap(c=>a.map(p=>u(t,p,n,{...o,__bound:c}))))).join("")}else if(e["==children"]){let a=e["==children"];i=f(a,o.__bound||o)}else i=Array.isArray(e.children)?(await Promise.all(e.children.map(async a=>await u(t,a,n,o)))).join(""):e.children;let s=R(e,o);return X(e.element,Y(o,s?{...e.attributes,class:s}:e.attributes),i)}function R(t,e){let n=[];return t.__class&&Object.entries(t.__class).forEach(([o,r])=>{f(r,{attributes:t.attributes,context:e})&&n.push(k(o))}),t.class?k(n.concat(t.class.split(" ")).join(" ")):n.join(" ")}function q(t,e){return t?e?`${t} ${e}`:t:e||""}function X(t,e,n){return t?`<${t}${e?" "+e:""}>${n||""}</${t}>`:typeof n=="string"?n:""}function Y(t,e){return e?A(t,e).map(([n,o])=>`${n}="${o}"`).join(" "):""}function P(){let t=document.querySelector('meta[name="pagepath"]');if(!t){console.error("path element was not found!");return}let e=t.getAttribute("content");if(!e){console.log("pagePath was not found in path element");return}return e}var J="document-tree-element",G="controls-element";async function U(){console.log("create editor");let[t,e,n,o]=await Promise.all([fetch("/components.json").then(l=>l.json()),fetch("./context.json").then(l=>l.json()),fetch("./layout.json").then(l=>l.json()),fetch("./route.json").then(l=>l.json())]),r=V(n,o),i=document.createElement("div");i.setAttribute("x-label","selected"),i.setAttribute("x-state","{ componentId: undefined }"),r.appendChild(i);let s=await Z(t,e);i.append(s);let a=await ee(t,e);i.append(a),document.body.appendChild(r),evaluateAllDirectives()}var T="editors";function V(t,e){let n=document.getElementById(T);return n?.remove(),n=document.createElement("div"),n.id=T,n.style.visibility="visible",n.setAttribute("x-state",JSON.stringify({...t,body:K(t.body),meta:e.meta})),n.setAttribute("x-label","editor"),n}function Le(){let t=document.getElementById(T);!t||(t.style.visibility=t.style.visibility==="visible"?"hidden":"visible")}function K(t){if(!t){console.error("initializeBody - missing body");return}return v(t,e=>{m(e,n=>{n._id=z()})})}function Q(t){let e=v(t.body,o=>{m(o,r=>{delete r._id,r.class===""&&delete r.class})}),n={path:P(),data:{...t,body:e}};window.developmentSocket.send(JSON.stringify({type:"update",payload:n}))}async function Z(t,e){console.log("creating page editor");let n=document.createElement("div");n.id=J,n.innerHTML=await u("",t.PageEditor,t,e);let o=n.children[0],r=o.children[0];return y({element:o,handle:r}),n}async function ee(t,e){let n=document.createElement("div");n.id=G,n.innerHTML=await u("",t.ComponentEditor,t,e);let o=n.children[0],r=o.children[0];return y({element:o,handle:r,xPosition:"right"}),n}function te(t,e){let{editor:{meta:n}}=getState(t),o=t.dataset.field;if(!o){console.error(`${o} was not found in ${t.dataset}`);return}if(o==="title"){let r=document.querySelector("title");r?r.innerHTML=e||"":console.warn("The page doesn't have a <title>!")}else{let r=document.head.querySelector("meta[name='"+o+"']");r?r.setAttribute("content",e):console.warn(`The page doesn't have a ${o} meta element!`)}setState({meta:{...n,[o]:e}},{element:t,parent:"editor"})}var L=new Set;function ne(t,e){event?.stopPropagation();let{editor:{body:n}}=getState(t),o=r=>{let i=r.target;if(!i){console.warn("inputListener - No element found");return}r.preventDefault(),j(t,i.textContent)};for(let r of L.values())r.classList.remove("border"),r.classList.remove("border-red-800"),r.removeAttribute("contenteditable"),r.removeEventListener("focusout",o),L.delete(r);m(n,(r,i)=>{if(r._id===e){let s=D(document.body,i,n);s.classList.add("border"),s.classList.add("border-red-800"),L.add(s),Array.isArray(r.children)||(s.setAttribute("contenteditable","true"),s.addEventListener("focusout",o))}}),setState({componentId:e},{element:t,parent:"selected"})}function re(t,e){let{editor:{body:n},selected:{componentId:o}}=getState(t),r=w(n,o,(i,s)=>{s?.replaceWith(oe(s,e)),i.element=e});setState({body:r},{element:t,parent:"editor"})}function oe(t,e){let n=document.createElement(e),o=t.cloneNode(!0);for(;o.firstChild;)n.appendChild(o.firstChild);for(let r of o.attributes)n.setAttribute(r.name,r.value);return n}function j(t,e){let{editor:{body:n},selected:{componentId:o}}=getState(t),r=w(n,o,(i,s)=>{s&&(s.innerHTML=e),i.children=e});setState({body:r},{element:t,parent:"editor"})}function ie(t,e){let{editor:{body:n},selected:{componentId:o}}=getState(t),r=w(n,o,(i,s)=>{s&&(s.setAttribute("class",e),s.classList.add("border"),s.classList.add("border-red-800")),i.class=e});setState({body:r},{element:t,parent:"editor"})}function w(t,e,n){return v(t,o=>{m(o,(r,i)=>{r._id===e&&n(r,D(document.body,i,t))})})}function D(t,e,n){let o=0;function r(i,s){if(!i)return null;if(Array.isArray(s)){let a=i;for(let l of s){let c=r(a,l);if(c)return c;a=a?.nextElementSibling}}else{if(e===o)return i;if(o++,Array.isArray(s.children)){let a=r(i.firstElementChild,s.children);if(a)return a}}return null}return r(t?.firstElementChild,n)}function se(t,e){let n={},{componentId:o}=e;return m(t.body,r=>{r._id===o&&(n=r)}),n}function m(t,e){let n=0;function o(r,i){Array.isArray(r)?r.forEach(s=>o(s,i)):(i(r,n),n++,Array.isArray(r.children)&&o(r.children,i))}o(t,e)}"Deno"in globalThis||(console.log("Hello from the page editor"),window.createEditor=U,window.metaChanged=te,window.classChanged=O(ie),window.elementClicked=ne,window.elementChanged=re,window.contentChanged=O(j),window.getSelectedComponent=se,window.updateFileSystem=Q);function O(t,e=100){let n;return(...o)=>{clearTimeout(n),n=setTimeout(()=>{t.apply(this,o)},e)}}export{U as createEditor,Le as toggleEditorVisibility};
