import{produce as x}from"https://cdn.skypack.dev/immer@9.0.6?min";function S({element:e,handle:n,xPosition:t},r){if(!e){console.warn("drag is missing elem!");return}H(e,"touchstart","touchmove","touchend",r,n,t),H(e,"mousedown","mousemove","mouseup",r,n,t)}function H(e,n,t,r,o,i,s){o=$(o,s="left");let a=o.begin,l=o.change,u=o.end;C(i||e,n,f=>{let c=N=>v(l,e,N);function y(){M(document,t,c),M(document,r,y),v(u,e,f)}C(document,t,c),C(document,r,y),v(a,e,f)})}function C(e,n,t){let r=!1;try{let o=Object.defineProperty({},"passive",{get:function(){r=!0}});globalThis.addEventListener("testPassive",null,o),globalThis.removeEventListener("testPassive",null,o)}catch(o){console.error(o)}e.addEventListener(n,t,r?{passive:!1}:!1)}function M(e,n,t){e.removeEventListener(n,t,!1)}function $(e,n="left"){if(e)return{begin:e.begin||b,change:e.change||b,end:e.end||b};let t,r;return{begin:function(o){let i=document.body.clientWidth;t={x:n==="left"?o.elem.offsetLeft:i-o.elem.offsetLeft-o.elem.clientWidth,y:o.elem.offsetTop},r=n==="left"?o.cursor:{x:i-o.cursor.x,y:o.cursor.y}},change:function(o){if(typeof t.x!="number"||typeof o.cursor.x!="number"||typeof r.x!="number")return;let i=document.body.clientWidth;P(o.elem,n,n==="left"?t.x+o.cursor.x-r.x+"px":t.x+(i-o.cursor.x)-r.x+"px"),!(typeof t.y!="number"||typeof o.cursor.y!="number"||typeof r.y!="number")&&P(o.elem,"top",t.y+o.cursor.y-r.y+"px")},end:b}}function P(e,n,t){e.style[n]=t}function b(){}function v(e,n,t){t.preventDefault();let r=z(n),o=n.clientWidth,i=n.clientHeight,s={x:W(n,t),y:F(n,t)};if(typeof s.x!="number"||typeof s.y!="number")return;let a=(s.x-r.x)/o,l=(s.y-r.y)/i;e({x:isNaN(a)?0:a,y:isNaN(l)?0:l,cursor:s,elem:n,e:t})}function z(e){let n=e.getBoundingClientRect();return{x:n.left,y:n.top}}function W(e,n){return n instanceof TouchEvent?n.touches.item(0)?.clientX:n.clientX}function F(e,n){return n instanceof TouchEvent?n.touches.item(0)?.clientY:n.clientY}function L(e){return typeof e>"u"}var p=e=>!Array.isArray(e)&&typeof e=="object";function d(e,n){if(!n)return;let t=e;return n.split(".").forEach(r=>{p(t)&&(t=t[r])}),t}function m(e,n={},t=!0){try{return Promise.resolve(Function.apply(null,Object.keys(n).concat(`return ${e}`))(...Object.values(n)))}catch(r){t&&console.error("Failed to evaluate",e,n,r)}}async function h({component:e,components:n,extensions:t,context:r,props:o,utilities:i}){if(Array.isArray(e))return(await Promise.all(e.map(c=>h({component:c,components:n,extensions:t,context:r,props:o,utilities:i})))).join("");let s=e.element,a=s&&n?.[s],l=Object.fromEntries(await A(e.props||o,{context:r,props:o}));if(a)return(await Promise.all((Array.isArray(a)?a:[a]).map(c=>h({component:c,components:n,extensions:t,context:r,props:l,utilities:i})))).join("");if(t){for(let c of t)e=await c(e,{props:l,context:r,utilities:i});s=e.element}e.__element&&(s=d({context:r,props:l},e.__element)||s);let u=await B(e.attributes,typeof e.props!="string"?{props:l,context:r,utilities:i}:r);if(e.children){let c=e.children;return Array.isArray(c)&&(c=await h({component:c,props:l,components:n,extensions:t,context:r,utilities:i})),g(s,u,c)}if(e.__children)return g(s,u,d({context:r,props:l},e.__children));if(e["##children"])return g(s,u,await h({component:d({context:r,props:l},e["##children"]),components:n,extensions:t,context:r,utilities:i}));let f=e["==children"];return f?g(s,u,await m(f,{props:l,context:r,utilities:i})):s?typeof e.closingCharacter=="string"?`<${s}${u?" "+u:""} ${e.closingCharacter}>`:g(s,u):g()}function g(e,n,t=""){return e?`<${e}${n?" "+n:""}>${t}</${e}>`:t||""}async function B(e,n){return e?(await A(e,n)).map(([t,r])=>r&&r.length>0?`${t}="${r}"`:t).join(" "):""}async function A(e,n){return e?await Promise.all(Object.entries(e).map(async([t,r])=>{if(L(r))return[];let o=t,i=r;return t.startsWith("__")&&(o=t.split("__").slice(1).join("__"),i=d(n,r)),t.startsWith("==")&&typeof r=="string"&&(o=t.split("==").slice(1).join("=="),i=await m(r,n)),L(i)?[]:[o,i]})):Promise.resolve([])}var j=h;import{getStyleTag as ue,getStyleTagProperties as de,virtualSheet as fe}from"https://cdn.skypack.dev/twind@0.16.16/sheets?min";import{setup as pe}from"https://cdn.skypack.dev/twind@0.16.16?min";import{tw as _}from"https://cdn.skypack.dev/twind@0.16.16?min";async function O(e,n){let t=[];if(typeof e.class=="string"&&t.push(e.class),typeof e.__class=="string"&&t.push(d(n,e.__class)),typeof e["==class"]=="string"&&t.push(await m(e["==class"],n)),p(e.classList)){let r=(await Promise.all(Object.entries(e.classList).map(async([o,i])=>await m(i,n)&&o))).filter(Boolean).join(" ");t.push(r)}return t.length?Promise.resolve({...e,attributes:{...e.attributes,class:t.map(r=>_(r)).join(" ")}}):Promise.resolve(e)}function k(e,n){if(!n||!e.foreach)return Promise.resolve(e);let[t,r]=e.foreach,o=d(n,t);return Array.isArray(o)?Promise.resolve({...e,children:o.flatMap(i=>Array.isArray(r)?r.map(s=>({...s,props:p(i)?i:{value:i}})):{...r,props:p(i)?i:{value:i}})}):Promise.resolve(e)}async function I(e,n){return typeof e.visibleIf!="string"?Promise.resolve(e):await m(e.visibleIf,n)?e:{}}function D(){let e=document.querySelector('meta[name="pagepath"]');if(!e){console.error("path element was not found!");return}let n=e.getAttribute("content");if(!n){console.log("pagePath was not found in path element");return}return n}var V="document-tree-element";async function U(){console.log("create editor");let[e,n,t,r]=await Promise.all([fetch("/components.json").then(s=>s.json()),fetch("./context.json").then(s=>s.json()),fetch("./layout.json").then(s=>s.json()),fetch("./route.json").then(s=>s.json())]),o=Y(t,r),i=await G(e,n);o.append(i),document.body.appendChild(o),evaluateAllDirectives(),globalThis.onclick=({target:s})=>{let a=s,l=a.hasAttribute("data-id")?a:q(a,"data-id")[0];!l||(setState({selected:l.getAttribute("data-id")},{element:o.children[0],parent:"editor"}),l&&X(l,o))}}function q(e,n){let t=[],r=e.parentElement;for(;r;)r.hasAttribute(n)&&t.push(r),r=r.parentElement;return t}var E;function X(e,n){let t,r=e.dataset.id;if(!r){console.log("target doesn't have a selection id");return}let o=i=>{let s=i.target;if(!s){console.warn("inputListener - No element found");return}i.preventDefault(),e.removeAttribute("contenteditable"),e.removeEventListener("focusout",o);let a=s.textContent;if(t===a){console.log("content didn't change");return}if(typeof a!="string")return;console.log("content changed",a);let l=n.children[0],{editor:{layout:u}}=getState(l),f=x(u,c=>{w(c,y=>{y?.attributes?.["data-id"]===r&&(y.children=a)})});setState({layout:f},{element:l,parent:"editor"})};E&&(E.classList.remove("border"),E.classList.remove("border-red-800")),E=e,e.classList.add("border"),e.classList.add("border-red-800"),e.children.length===0&&e.textContent&&(t=e.textContent,e.setAttribute("contenteditable","true"),e.addEventListener("focusout",o),e.focus())}function w(e,n){let t=0;function r(o,i){Array.isArray(o)?o.forEach(s=>r(s,i)):(i(o,t),t++,Array.isArray(o.children)&&r(o.children,i),o.props&&r(Object.values(o.props),i))}r(e,n)}var T="editors";function Y(e,n){let t=document.getElementById(T);return t?.remove(),t=document.createElement("div"),t.id=T,t.style.visibility="visible",t.setAttribute("x-state",JSON.stringify({layout:e,meta:n.meta,selected:void 0})),t.setAttribute("x-label","editor"),t}function we(){let e=document.getElementById(T);!e||(e.style.visibility=e.style.visibility==="visible"?"hidden":"visible")}function J(e){let n=x(e.body,r=>{w(r,o=>{delete o._id,o.class===""&&delete o.class})}),t={path:D(),data:{...e,body:n}};window.developmentSocket.send(JSON.stringify({type:"update",payload:t}))}async function G(e,n){console.log("creating page editor");let t=document.createElement("div");t.id=V,t.innerHTML=await j({component:e.PageEditor,components:e,context:n,extensions:[O,k,I]});let r=t.children[0],o=r.children[0];return S({element:r,handle:o}),t}function K(e,n){let{editor:{meta:t}}=getState(e),r=e.dataset.field;if(!r){console.error(`${r} was not found in ${e.dataset}`);return}if(r==="title"){let o=document.querySelector("title");o?o.innerHTML=n||"":console.warn("The page doesn't have a <title>!")}else{let o=document.head.querySelector("meta[name='"+r+"']");o?o.setAttribute("content",n):console.warn(`The page doesn't have a ${r} meta element!`)}setState({meta:{...t,[r]:n}},{element:e,parent:"editor"})}function Q(e,n){let{editor:{body:t},selected:{componentId:r}}=getState(e),o=ee(t,r,(i,s)=>{s?.replaceWith(Z(s,n)),i.element=n});setState({body:o},{element:e,parent:"editor"})}function Z(e,n){let t=document.createElement(n),r=e.cloneNode(!0);for(;r.firstChild;)t.appendChild(r.firstChild);for(let o of r.attributes)t.setAttribute(o.name,o.value);return t}function ee(e,n,t){return x(e,r=>{w(r,(o,i)=>{o._id===n&&t(o,te(document.body,i,e))})})}function te(e,n,t){let r=0;function o(i,s){if(!i)return null;if(Array.isArray(s)){let a=i;for(let l of s){let u=o(a,l);if(u)return u;a=a?.nextElementSibling}}else{if(n===r)return i;if(r++,Array.isArray(s.children)){let a=o(i.firstElementChild,s.children);if(a)return a}}return null}return o(e?.firstElementChild,t)}"Deno"in globalThis||(console.log("Hello from the page editor"),window.createEditor=U,window.metaChanged=K,window.elementChanged=Q,window.updateFileSystem=J);export{U as createEditor,we as toggleEditorVisibility};
