import{produce as T}from"https://cdn.skypack.dev/immer@9.0.6?min";import{nanoid as ae}from"https://cdn.skypack.dev/nanoid@3.1.30?min";function p({element:t,handle:e,xPosition:r},i){if(!t){console.warn("drag is missing elem!");return}M(t,"touchstart","touchmove","touchend",i,e,r),M(t,"mousedown","mousemove","mouseup",i,e,r)}function M(t,e,r,i,n,s,o){n=I(n,o="left");let a=n.begin,l=n.change,d=n.end;g(s||t,e,L=>{let P=W=>h(l,t,W);function S(){x(document,r,P),x(document,i,S),h(d,t,L)}g(document,r,P),g(document,i,S),h(a,t,L)})}function g(t,e,r){let i=!1;try{let n=Object.defineProperty({},"passive",{get:function(){i=!0}});globalThis.addEventListener("testPassive",null,n),globalThis.removeEventListener("testPassive",null,n)}catch(n){console.error(n)}t.addEventListener(e,r,i?{passive:!1}:!1)}function x(t,e,r){t.removeEventListener(e,r,!1)}function I(t,e="left"){if(t)return{begin:t.begin||m,change:t.change||m,end:t.end||m};let r,i;return{begin:function(n){let s=document.body.clientWidth;r={x:e==="left"?n.elem.offsetLeft:s-n.elem.offsetLeft-n.elem.clientWidth,y:n.elem.offsetTop},i=e==="left"?n.cursor:{x:s-n.cursor.x,y:n.cursor.y}},change:function(n){if(typeof r.x!="number"||typeof n.cursor.x!="number"||typeof i.x!="number")return;let s=document.body.clientWidth;H(n.elem,e,e==="left"?r.x+n.cursor.x-i.x+"px":r.x+(s-n.cursor.x)-i.x+"px"),!(typeof r.y!="number"||typeof n.cursor.y!="number"||typeof i.y!="number")&&H(n.elem,"top",r.y+n.cursor.y-i.y+"px")},end:m}}function H(t,e,r){t.style[e]=r}function m(){}function h(t,e,r){r.preventDefault();let i=N(e),n=e.clientWidth,s=e.clientHeight,o={x:F(e,r),y:R(e,r)};if(typeof o.x!="number"||typeof o.y!="number")return;let a=(o.x-i.x)/n,l=(o.y-i.y)/s;t({x:isNaN(a)?0:a,y:isNaN(l)?0:l,cursor:o,elem:e,e:r})}function N(t){let e=t.getBoundingClientRect();return{x:e.left,y:e.top}}function F(t,e){return e instanceof TouchEvent?e.touches.item(0)?.clientX:e.clientX}function R(t,e){return e instanceof TouchEvent?e.touches.item(0)?.clientY:e.clientY}import*as y from"https://cdn.skypack.dev/twind@0.16.16?min";import*as de from"https://cdn.skypack.dev/twind@0.16.16/colors?min";import*as ce from"https://cdn.skypack.dev/twind@0.16.16/sheets?min";import*as ue from"https://cdn.skypack.dev/twind@0.16.16/shim?min";import fe from"https://cdn.skypack.dev/@twind/typography@0.0.2?min";var b=t=>typeof t=="object";function f(t,e){let r=t;return e.split(".").forEach(i=>{b(r)&&(r=r[i])}),r}var k={};function _(t){return new Promise((e,r)=>{if(k[t])return e("loadedAlready");k[t]=!0;let i=document.createElement("script");i.setAttribute("type","module"),i.setAttribute("src",t),i.onload=()=>e("loaded"),i.onerror=()=>r(),document.body.appendChild(i)})}async function E(t,e,r){if(!e)return Promise.resolve({content:r});if("Deno"in globalThis){let i=await import("https://deno.land/std@0.107.0/path/mod.ts");return(await Promise.all(e.map(s=>{let o=i.join(t,`${s}.ts`);return Deno.env.get("DEBUG")==="1"&&console.log("importing transform",o,t,s),import("file://"+o)}))).reduce((s,o)=>o.default(s),r)}return Promise.all(e.map(i=>_(`/transforms/${i}.js`)))}async function c(t,e,r,i){if(typeof e=="string")return e;let n=e.element&&r[e.element];if(e.__bind&&(b(e.__bind)?i={...i,__bound:e.__bind}:i={...i,__bound:f(i,e.__bind)}),n)return await c(t,{element:"",children:Array.isArray(n)?n:[{...e,...n,class:B(e.class,n.class)}]},r,i);if(e?.transformWith){let o;if(typeof e.inputText=="string")o=await E(t,e?.transformWith,e.inputText);else if(typeof e.inputProperty=="string"){let a=f(i,e.inputProperty);if(!a)throw console.error("Missing input",i,e.inputProperty),new Error("Missing input");o=await E(t,e?.transformWith,a)}i={...i,...o}}let s;if(e.__children){let o=e.__children,a=i.__bound||i;typeof o=="string"?s=f(a,o):s=(await Promise.all((Array.isArray(a)?a:[a]).flatMap(l=>o.map(d=>c(t,d,r,{...i,__bound:l}))))).join("")}else s=Array.isArray(e.children)?(await Promise.all(e.children.map(async o=>await c(t,o,r,i)))).join(""):e.children;return V(e.element,X({...e.attributes,class:q(e,i)},i),s)}function q(t,e){let r=[];return t.__class&&Object.entries(t.__class).forEach(([i,n])=>{A(n,{attributes:t.attributes,context:e})&&r.push(y.tw(i))}),t.class?y.tw(r.concat(t.class.split(" ")).join(" ")):r.join(" ")}function B(t,e){return t?e?`${t} ${e}`:t:e||""}function V(t,e,r){return t?`<${t}${e}>${r||""}</${t}>`:typeof r=="string"?r:""}function X(t,e){let r=Object.entries(t).map(([i,n])=>i.startsWith("__")?`${i.slice(2)}="${A(n,e.__bound)}"`:`${i}="${n}"`).filter(Boolean).join(" ");return r.length>0?" "+r:""}function A(t,e={}){try{return Function.apply(null,Object.keys(e).concat(`return ${t}`))(...Object.values(e))}catch(r){console.error("Failed to evaluate",t,e,r)}}function j(){let t=document.querySelector('meta[name="pagepath"]');if(!t){console.error("path element was not found!");return}let e=t.getAttribute("content");if(!e){console.log("pagePath was not found in path element");return}return e}function u(t,e){let r=0;function i(n,s){Array.isArray(n)?n.forEach(o=>i(o,s)):(s(n,r),r++,Array.isArray(n.children)&&i(n.children,s))}i(t,e)}var Y="document-tree-element",J="controls-element";async function z(){console.log("create editor");let[t,e,r]=await Promise.all([fetch("/components.json").then(a=>a.json()),fetch("./context.json").then(a=>a.json()),fetch("./definition.json").then(a=>a.json())]),i=G(r),n=document.createElement("div");n.setAttribute("x-label","selected"),n.setAttribute("x-state","{ componentId: undefined }"),i.appendChild(n);let s=await Z(t,e);n.append(s);let o=await ee(t,e);n.append(o),document.body.appendChild(i),evaluateAllDirectives()}var C="editors";function G(t){let e=document.getElementById(C);return e?.remove(),e=document.createElement("div"),e.id=C,e.style.visibility="visible",e.setAttribute("x-state",JSON.stringify({...t,page:K(t.page)})),e.setAttribute("x-label","editor"),e}function U(){let t=document.getElementById(C);!t||(t.style.visibility=t.style.visibility==="visible"?"hidden":"visible")}function K(t){return T(t,e=>{u(e,r=>{r._id=ae()})})}function Q(t){let e=T(t.page,i=>{u(i,n=>{delete n._id,n.class===""&&delete n.class})}),r={path:j(),data:{...t,page:e}};window.developmentSocket.send(JSON.stringify({type:"update",payload:r}))}async function Z(t,e){console.log("Creating page editor");let r=document.createElement("div");r.id=Y,r.innerHTML=await c("",t.PageEditor,t,e);let i=r.children[0],n=i.children[0];return p({element:i,handle:n}),r}async function ee(t,e){let r=document.createElement("div");r.id=J,r.innerHTML=await c("",t.ComponentEditor,t,e);let i=r.children[0],n=i.children[0];return p({element:i,handle:n,xPosition:"right"}),r}function te(t,e){let{editor:{meta:r}}=getState(t),i=t.dataset.field;if(i==="title"){let n=document.querySelector("title");n?n.innerHTML=e||"":console.warn("The page doesn't have a <title>!")}else{let n=document.head.querySelector("meta[name='"+i+"']");n?n.setAttribute("content",e):console.warn(`The page doesn't have a ${i} meta element!`)}setState({meta:{...r,[i]:e}},{element:t,parent:"editor"})}var v=new Set;function ne(t,e){event?.stopPropagation();let{editor:{page:r}}=getState(t),i=n=>{let s=n.target;if(!s){console.warn("inputListener - No element found");return}n.preventDefault(),D(t,s.textContent)};for(let n of v.values())n.classList.remove("border"),n.classList.remove("border-red-800"),n.removeAttribute("contenteditable"),n.removeEventListener("focusout",i),v.delete(n);u(r,(n,s)=>{if(n._id===e){let o=O(document.querySelector("main"),s,r);o.classList.add("border"),o.classList.add("border-red-800"),o.setAttribute("contenteditable","true"),o.addEventListener("focusout",i),v.add(o)}}),setState({componentId:e},{element:t,parent:"selected"})}function re(t,e){let{editor:{page:r},selected:{componentId:i}}=getState(t),n=w(r,i,(s,o)=>{o?.replaceWith(ie(o,e)),s.element=e});setState({page:n},{element:t,parent:"editor"})}function ie(t,e){let r=document.createElement(e),i=t.cloneNode(!0);for(;i.firstChild;)r.appendChild(i.firstChild);for(let n of i.attributes)r.setAttribute(n.name,n.value);return r}function D(t,e){let{editor:{page:r},selected:{componentId:i}}=getState(t),n=w(r,i,(s,o)=>{o&&(o.innerHTML=e),s.children=e});setState({page:n},{element:t,parent:"editor"})}function oe(t,e){let{editor:{page:r},selected:{componentId:i}}=getState(t),n=w(r,i,(s,o)=>{o&&(o.setAttribute("class",e),o.classList.add("border"),o.classList.add("border-red-800")),s.class=e});setState({page:n},{element:t,parent:"editor"})}function w(t,e,r){return T(t,i=>{u(i,(n,s)=>{n._id===e&&r(n,O(document.querySelector("main"),s,t))})})}function O(t,e,r){let i=0;function n(s,o){if(!s)return null;if(Array.isArray(o)){let a=s;for(let l of o){let d=n(a,l);if(d)return d;a=a?.nextElementSibling}}else{if(e===i)return s;if(i++,Array.isArray(o.children)){let a=n(s.firstElementChild,o.children);if(a)return a}}return null}return n(t?.firstElementChild,r)}function se(t,e){let r={},{componentId:i}=e;return u(t.page,n=>{n._id===i&&(r=n)}),r}"Deno"in globalThis||(console.log("Hello from the page editor"),window.createEditor=z,window.toggleEditorVisibility=U,window.metaChanged=te,window.classChanged=$(oe),window.elementClicked=ne,window.elementChanged=re,window.contentChanged=$(D),window.getSelectedComponent=se,window.updateFileSystem=Q);function $(t,e=100){let r;return(...i)=>{clearTimeout(r),r=setTimeout(()=>{t.apply(this,i)},e)}}
