function P(t,n){let i=[],e=t.parentElement;for(;e;)e.hasAttribute(n)&&i.push(e),e=e.parentElement;return i}function U(t,n){let i=document.createElement(n),e=t.cloneNode(!0);for(;e.firstChild;)i.appendChild(e.firstChild);for(let r of e.attributes)i.setAttribute(r.name,r.value);return i}function g(t,n){let i=0;function e(r,o){Array.isArray(r)?r.forEach(s=>e(s,o)):(o(r,i),i++,Array.isArray(r.children)&&e(r.children,o),r.props&&e(Object.values(r.props),o))}e(t,n)}function h(t){return typeof t>"u"}var m=t=>!Array.isArray(t)&&typeof t=="object";function f(t,n,i){if(!n)return;let e=t;return n.split(".").forEach(r=>{m(e)&&(e=e[r])}),h(e)?i:e}async function M(t,n,i){return Object.fromEntries(await Promise.all(Object.entries(t).map(async([e,r])=>[e,typeof r=="string"?r:await d(r,n,i)])))}async function d(t,n,i){if(!n)throw new Error("applyUtility - No utilities were provided");let e=n[t.utility];if(!e)throw console.error({utilities:n,value:t}),new Error("applyUtility - Matching utility was not found");let r=await Promise.all(Array.isArray(t.parameters)?t.parameters.map(o=>{if(typeof o!="string"){if(o.utility&&o.parameters)return d(o,n,i)}return o}):[]);return e.apply(null,[i].concat(r))}var E={concat:(t,...n)=>n.join(""),get:(t,n,i,e)=>f(f(t,n),i,e)};async function y({component:t,components:n,extensions:i,context:e,props:r,utilities:o}){let s=(c,I)=>y({component:I,components:n,extensions:i,context:e,utilities:o});if(o=m(o)?{render:s,...E,...o}:{render:s,...E},Array.isArray(t))return(await Promise.all(t.map(c=>y({component:c,components:n,extensions:i,context:e,props:r,utilities:o})))).join("");let a=t.type,l=a&&typeof a=="string"&&n?.[a];if(r=t.props||r,t.bindToProps&&(r={...await M(t.bindToProps,o,{context:e,props:r}),...r}),l)return(await Promise.all((Array.isArray(l)?l:[l]).map(c=>y({component:c,components:n,extensions:i,context:e,props:r,utilities:o})))).join("");if(i){for(let c of i)t=await c(t,{props:r,context:e},o);a=t.type}let u=await O(t.attributes,{props:r,context:e},o),p=a;if(typeof a=="string"||a?.utility&&a?.parameters&&(p=await d(a,o,{context:e,props:r})),t.children){let c=t.children;return typeof c=="string"||(Array.isArray(c)?c=await y({component:c,props:r,components:n,extensions:i,context:e,utilities:o}):c.utility&&o&&(c=await d(c,o,{context:e,props:r}))),H(p,u,c)}return a?typeof t.closingCharacter=="string"?`<${p}${u?" "+u:""} ${t.closingCharacter}>`:H(p,u):""}function H(t,n,i=""){return t?`<${t}${n?" "+n:""}>${i}</${t}>`:i||""}async function O(t,n,i){return t?(await $(t,n,i)).map(([e,r])=>r&&r.length>0?`${e}="${r}"`:e).join(" "):""}async function $(t,n,i){return t?Promise.all(await Object.entries(t).map(async([e,r])=>{if(h(r))return[];let o=r;return h(o)?[]:(o.context?o=f(f(n,o.context),o.property,o.default):o.utility&&i&&(o=await d(o,i,n)),[e,o])})):[]}var b=y;import{getStyleTag as ct,getStyleTagProperties as dt,virtualSheet as ut}from"https://cdn.skypack.dev/twind@0.16.16/sheets?min";import{draggable as w}from"https://cdn.skypack.dev/dragjs@v0.13.3?min";import{produce as L}from"https://cdn.skypack.dev/immer@9.0.6?min";import{setup as pt}from"https://cdn.skypack.dev/twind@0.16.16?min";import{tw as j}from"https://cdn.skypack.dev/twind@0.16.16?min";async function S(t,n,i){let e=[];if(typeof t.class=="string"?e.push(t.class):t.class?.utility&&t.class.parameters&&e.push(await d(t.class,i,n)),m(t.classList)){let r=(await Promise.all(await Object.entries(t.classList).map(async([o,s])=>{let a=await d(s[0],i,n);if(s.length===1)return a;let l=(await Promise.all(s.map(async u=>a===await d(u,i,n)))).filter(Boolean);return s.length===l.length&&o}))).filter(Boolean).join(" ");e.push(r)}return e.length?{...t,attributes:{...t.attributes,class:e.map(r=>j(r)).join(" ")}}:t}async function x(t,n,i){if(!n||!t.foreach)return Promise.resolve(t);let[e,r]=t.foreach,o=await d(e,i,n);return Array.isArray(o)?Promise.resolve({...t,children:o.flatMap(s=>Array.isArray(r)?r.map(a=>({...a,props:m(s)?s:{value:s}})):{...r,props:m(s)?s:{value:s}})}):Promise.resolve(t)}async function T(t,n,i){if(!Array.isArray(t.visibleIf))return Promise.resolve(t);if(t.visibleIf.length===0)return Promise.resolve({});let r=(await Promise.all(t.visibleIf.map(async o=>await d(o,i,n)))).filter(Boolean).length===t.visibleIf.length;return Promise.resolve(r?t:{})}var D="document-tree-element",N="controls-element";async function B(){console.log("create editor");let[t,n,i,e]=await Promise.all([fetch("/components.json").then(l=>l.json()),fetch("./context.json").then(l=>l.json()),fetch("./layout.json").then(l=>l.json()),fetch("./route.json").then(l=>l.json())]),r=q(i,e),o=await F(t,n);r.append(o);let s=await W(t,n);r.append(s),document.body.appendChild(r),evaluateAllDirectives();let a=R(r);globalThis.onclick=({target:l})=>a(l),globalThis.ontouchstart=({target:l})=>a(l)}function R(t){return function(i){if(!i)return;let e=i,r=e.hasAttribute("data-id")?e:P(e,"data-id")[0];if(!r)return;let o=r.getAttribute("data-id"),{editor:{layout:s}}=getState(t);setState({selectionId:o},{element:t,parent:"editor"}),r&&k(t,r,s)}}var C;function k(t,n,i){let e,r=n.dataset.id;if(!r){console.log("target doesn't have a selection id");return}let o=a=>{!a||!a.target||V(t,i,r,a.target,e)},s=a=>{if(!a.target){console.warn("inputListener - No element found");return}a.preventDefault(),n.removeAttribute("contenteditable"),n.removeEventListener("input",o),n.removeEventListener("focusout",s)};C&&(C.classList.remove("border"),C.classList.remove("border-red-800")),C=n,n.classList.add("border"),n.classList.add("border-red-800"),n.children.length===0&&n.textContent&&(e=n.textContent,n.setAttribute("contenteditable","true"),n.addEventListener("focusout",s),n.addEventListener("input",o),n.focus())}function V(t,n,i,e,r){let o=e.textContent;if(r===o){console.log("content didn't change");return}if(typeof o!="string")return;console.log("content changed",o);let s=L(n,l=>{g(l,u=>{u?.attributes?.["data-id"]===i&&(u.children=o)})}),a=t.children[0];setState({layout:s},{element:a,parent:"editor"})}var v="editors";function q(t,n){let i=document.getElementById(v),e={layout:t,meta:n.meta,selectionId:void 0};return i?.remove(),i=document.createElement("div"),i.id=v,i.style.visibility="visible",i.setAttribute("x-state",JSON.stringify(e)),i.setAttribute("x-label","editor"),i}function vt(){let t=document.getElementById(v);!t||(t.style.visibility=t.style.visibility==="visible"?"hidden":"visible")}async function F(t,n){console.log("creating page editor");let i=document.createElement("div");i.id=D,i.innerHTML=await b({component:t.PageEditor,components:t,context:n,extensions:[S,x,T]});let e=i.children[0],r=e.children[0];return w({element:e,handle:r}),i}async function W(t,n){let i=document.createElement("div");i.id=N,i.innerHTML=await b({component:t.ComponentEditor,components:t,context:n,extensions:[S,x,T]});let e=i.children[0],r=e.children[0];return w({element:e,handle:r,xPosition:"right"}),i}function _(t,n){let{editor:{meta:i}}=getState(t),e=t.dataset.field;if(!e){console.error(`${e} was not found in ${t.dataset}`);return}if(e==="title"){let r=document.querySelector("title");r?r.innerHTML=n||"":console.warn("The page doesn't have a <title>!")}else{let r=document.head.querySelector("meta[name='"+e+"']");r?r.setAttribute("content",n):console.warn(`The page doesn't have a ${e} meta element!`)}setState({meta:{...i,[e]:n}},{element:t,parent:"editor"})}function J(t,n){let{editor:{layout:i,selectionId:e}}=getState(t),r=A(i,e,(o,s)=>{s.forEach(a=>{a.innerHTML=n}),o.children=n});setState({layout:r},{element:t,parent:"editor"})}function G(t,n){let{editor:{layout:i,selectionId:e}}=getState(t),r=A(i,e,(o,s)=>{Array.isArray(o)||(s.forEach(a=>a.setAttribute("class",n)),o.class=n)});setState({layout:r},{element:t,parent:"editor"})}function K(t,n){let{editor:{layout:i,selectionId:e}}=getState(t),r=A(i,e,(o,s)=>{Array.isArray(o)||(s.forEach(a=>a.replaceWith(U(a,n))),o.type=n)});setState({layout:r},{element:t,parent:"editor"})}function A(t,n,i){return L(t,e=>{g(e,r=>{r?.attributes?.["data-id"]===n&&i(r,Array.from(document.querySelectorAll(`*[data-id="${n}"]`)))})})}function Q(t){let{layout:n,selectionId:i}=t;if(!i)return{};let e;return g(n,r=>{r?.attributes?.["data-id"]===i&&(e=r)}),e}"Deno"in globalThis||(console.log("Hello from the page editor"),window.createEditor=B,window.classChanged=G,window.contentChanged=J,window.getSelectedComponent=Q,window.metaChanged=_,window.elementChanged=K);export{B as createEditor,vt as toggleEditorVisibility};
