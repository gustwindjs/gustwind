function P(t,e){let i=[],r=t.parentElement;for(;r;)r.hasAttribute(e)&&i.push(r),r=r.parentElement;return i}function U(t,e){let i=document.createElement(e),r=t.cloneNode(!0);for(;r.firstChild;)i.appendChild(r.firstChild);for(let n of r.attributes)i.setAttribute(n.name,n.value);return i}function g(t,e){let i=0;function r(n,o){Array.isArray(n)?n.forEach(s=>r(s,o)):(o(n,i),i++,Array.isArray(n.children)&&r(n.children,o),n.props&&r(Object.values(n.props),o))}r(t,e)}function h(t){return typeof t>"u"}var m=t=>!Array.isArray(t)&&typeof t=="object";function y(t,e,i){if(!e)return;let r=t;return e.split(".").forEach(n=>{m(r)&&(r=r[n])}),h(r)?i:r}async function M(t,e,i){return Object.fromEntries(await Promise.all(Object.entries(t).map(async([r,n])=>[r,typeof n=="string"?n:await d(n,e,i)])))}async function d(t,e,i){if(!e)throw new Error("applyUtility - No utilities were provided");let r=e[t.utility];if(!r)throw console.error({utilities:e,value:t}),new Error("applyUtility - Matching utility was not found");let n=await Promise.all(Array.isArray(t.parameters)?t.parameters.map(o=>{if(typeof o!="string"){if(o.utility&&o.parameters)return d(o,e,i)}return o}):[]);return r.apply(null,[i].concat(n))}var E={concat:(t,...e)=>e.join(""),get:(t,e,i,r)=>y(y(t,e),i,r)};async function p({component:t,components:e,extensions:i,context:r,props:n,utilities:o}){let s=(c,j)=>p({component:j,components:e,extensions:i,context:r,utilities:o});if(o=m(o)?{render:s,...E,...o}:{render:s,...E},Array.isArray(t))return(await Promise.all(t.map(c=>p({component:c,components:e,extensions:i,context:r,props:n,utilities:o})))).join("");let a=t.type,l=a&&typeof a=="string"&&e?.[a];if(n=t.props||n,t.bindToProps&&(n={...await M(t.bindToProps,o,{context:r,props:n}),...n}),l)return(await Promise.all((Array.isArray(l)?l:[l]).map(c=>p({component:c,components:e,extensions:i,context:r,props:n,utilities:o})))).join("");if(i){for(let c of i)t=await c(t,{props:n,context:r},o);a=t.type}let u=await I(t.attributes,{props:n,context:r},o),f=a;if(typeof a=="string"||a?.utility&&a?.parameters&&(f=await d(a,o,{context:r,props:n})),t.children){let c=t.children;return typeof c=="string"||(Array.isArray(c)?c=await p({component:c,props:n,components:e,extensions:i,context:r,utilities:o}):c.utility&&o&&(c=await d(c,o,{context:r,props:n}))),H(f,u,c)}return a?typeof t.closingCharacter=="string"?`<${f}${u?" "+u:""} ${t.closingCharacter}>`:H(f,u):""}function H(t,e,i=""){return t?`<${t}${e?" "+e:""}>${i}</${t}>`:i||""}async function I(t,e,i){return t?(await O(t,e,i)).map(([r,n])=>n&&n.length>0?`${r}="${n}"`:r).join(" "):""}async function O(t,e,i){return t?Promise.all(await Object.entries(t).map(async([r,n])=>{if(h(n))return[];let o=n;return h(o)?[]:(o.context?o=y(y(e,o.context),o.property,o.default):o.utility&&i&&(o=await d(o,i,e)),[r,o])})):[]}var b=p;function w(t){return async function(e,i,r){let n=[];if(typeof e.class=="string"?n.push(e.class):e.class?.utility&&e.class.parameters&&n.push(await d(e.class,r,i)),m(e.classList)){let o=(await Promise.all(await Object.entries(e.classList).map(async([s,a])=>{let l=await d(a[0],r,i);if(a.length===1)return l;let u=(await Promise.all(a.map(async f=>l===await d(f,r,i)))).filter(Boolean);return a.length===u.length&&s}))).filter(Boolean).join(" ");n.push(o)}return n.length?{...e,attributes:{...e.attributes,class:n.map(o=>t(o)).join(" ")}}:e}}async function L(t,e,i){if(!e||!t.foreach)return Promise.resolve(t);let[r,n]=t.foreach,o=await d(r,i,e);return Array.isArray(o)?Promise.resolve({...t,children:o.flatMap(s=>Array.isArray(n)?n.map(a=>({...a,props:m(s)?s:{value:s}})):{...n,props:m(s)?s:{value:s}})}):Promise.resolve(t)}async function S(t,e,i){if(!Array.isArray(t.visibleIf))return Promise.resolve(t);if(t.visibleIf.length===0)return Promise.resolve({});let n=(await Promise.all(t.visibleIf.map(async o=>await d(o,i,e)))).filter(Boolean).length===t.visibleIf.length;return Promise.resolve(n?t:{})}import{getStyleTag as dt,getStyleTagProperties as ut,virtualSheet as mt}from"https://cdn.skypack.dev/twind@0.16.16/sheets?min";import{draggable as x}from"https://cdn.skypack.dev/dragjs@v0.13.3?min";import{produce as T}from"https://cdn.skypack.dev/immer@9.0.6?min";import{setup as gt}from"https://cdn.skypack.dev/twind@0.16.16?min";import{tw as Ct}from"https://cdn.skypack.dev/twind@0.16.16?min";var z="document-tree-element",D="controls-element";async function N(){console.log("create editor");let[t,e,i,r]=await Promise.all([fetch("/components.json").then(l=>l.json()),fetch("./context.json").then(l=>l.json()),fetch("./layout.json").then(l=>l.json()),fetch("./route.json").then(l=>l.json())]),n=V(i,r),o=await q(t,e);n.append(o);let s=await F(t,e);n.append(s),document.body.appendChild(n),evaluateAllDirectives();let a=B(n);globalThis.onclick=({target:l})=>a(l),globalThis.ontouchstart=({target:l})=>a(l)}function B(t){return function(i){if(!i)return;let r=i,n=r.hasAttribute("data-id")?r:P(r,"data-id")[0];if(!n)return;let o=n.getAttribute("data-id"),{editor:{layout:s}}=getState(t);setState({selectionId:o},{element:t,parent:"editor"}),n&&R(t,n,s)}}var C;function R(t,e,i){let r,n=e.dataset.id;if(!n){console.log("target doesn't have a selection id");return}let o=a=>{!a||!a.target||k(t,i,n,a.target,r)},s=a=>{if(!a.target){console.warn("inputListener - No element found");return}a.preventDefault(),e.removeAttribute("contenteditable"),e.removeEventListener("input",o),e.removeEventListener("focusout",s)};C&&(C.classList.remove("border"),C.classList.remove("border-red-800")),C=e,e.classList.add("border"),e.classList.add("border-red-800"),e.children.length===0&&e.textContent&&(r=e.textContent,e.setAttribute("contenteditable","true"),e.addEventListener("focusout",s),e.addEventListener("input",o),e.focus())}function k(t,e,i,r,n){let o=r.textContent;if(n===o){console.log("content didn't change");return}if(typeof o!="string")return;console.log("content changed",o);let s=T(e,l=>{g(l,u=>{u?.attributes?.["data-id"]===i&&(u.children=o)})}),a=t.children[0];setState({layout:s},{element:a,parent:"editor"})}var v="editors";function V(t,e){let i=document.getElementById(v),r={layout:t,meta:e.meta,selectionId:void 0};return i?.remove(),i=document.createElement("div"),i.id=v,i.style.visibility="visible",i.setAttribute("x-state",JSON.stringify(r)),i.setAttribute("x-label","editor"),i}function Tt(){let t=document.getElementById(v);!t||(t.style.visibility=t.style.visibility==="visible"?"hidden":"visible")}async function q(t,e){console.log("creating page editor");let i=document.createElement("div");i.id=z,i.innerHTML=await b({component:t.PageEditor,components:t,context:e,extensions:[w,L,S]});let r=i.children[0],n=r.children[0];return x({element:r,handle:n}),i}async function F(t,e){let i=document.createElement("div");i.id=D,i.innerHTML=await b({component:t.ComponentEditor,components:t,context:e,extensions:[w,L,S]});let r=i.children[0],n=r.children[0];return x({element:r,handle:n,xPosition:"right"}),i}function W(t,e){let{editor:{meta:i}}=getState(t),r=t.dataset.field;if(!r){console.error(`${r} was not found in ${t.dataset}`);return}if(r==="title"){let n=document.querySelector("title");n?n.innerHTML=e||"":console.warn("The page doesn't have a <title>!")}else{let n=document.head.querySelector("meta[name='"+r+"']");n?n.setAttribute("content",e):console.warn(`The page doesn't have a ${r} meta element!`)}setState({meta:{...i,[r]:e}},{element:t,parent:"editor"})}function _(t,e){let{editor:{layout:i,selectionId:r}}=getState(t),n=A(i,r,(o,s)=>{s.forEach(a=>{a.innerHTML=e}),o.children=e});setState({layout:n},{element:t,parent:"editor"})}function J(t,e){let{editor:{layout:i,selectionId:r}}=getState(t),n=A(i,r,(o,s)=>{Array.isArray(o)||(s.forEach(a=>a.setAttribute("class",e)),o.class=e)});setState({layout:n},{element:t,parent:"editor"})}function G(t,e){let{editor:{layout:i,selectionId:r}}=getState(t),n=A(i,r,(o,s)=>{Array.isArray(o)||(s.forEach(a=>a.replaceWith(U(a,e))),o.type=e)});setState({layout:n},{element:t,parent:"editor"})}function A(t,e,i){return T(t,r=>{g(r,n=>{n?.attributes?.["data-id"]===e&&i(n,Array.from(document.querySelectorAll(`*[data-id="${e}"]`)))})})}function K(t){let{layout:e,selectionId:i}=t;if(!i)return{};let r;return g(e,n=>{n?.attributes?.["data-id"]===i&&(r=n)}),r}"Deno"in globalThis||(console.log("Hello from the page editor"),window.createEditor=N,window.classChanged=J,window.contentChanged=_,window.getSelectedComponent=K,window.metaChanged=W,window.elementChanged=G);export{N as createEditor,Tt as toggleEditorVisibility};
