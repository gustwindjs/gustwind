var _=Object.defineProperty;var Q=t=>_(t,"__esModule",{value:!0});var d=(t,e)=>()=>(t&&(e=t(t=0)),e);var x=(t,e)=>{Q(t);for(var n in e)_(t,n,{get:e[n],enumerable:!0})};var j={};x(j,{registerListener:()=>ee});function Z(){let t={mode:"silent",target:document.body};Promise.all([import("https://cdn.skypack.dev/twind@0.16.16/shim?min"),import("/twindSetup.js")]).then(([{setup:e},n])=>{console.log("loaded custom twind setup",n.default),e({...t,...n.default}),import("https://cdn.skypack.dev/twind@0.16.16?min").then(({tw:r})=>{k=r,P=!0,A.forEach(i=>i(r))})})}function ee(t){console.log("registering a twind runtime listener"),P?t(k):A.push(t)}var P,k,A,D=d(()=>{P=!1,A=[];"Deno"in globalThis||Z()});function y({element:t,handle:e,xPosition:n},r){if(!t){console.warn("drag is missing elem!");return}$(t,"touchstart","touchmove","touchend",r,e,n),$(t,"mousedown","mousemove","mouseup",r,e,n)}function $(t,e,n,r,i,o,s){i=te(i,s="left");let a=i.begin,l=i.change,u=i.end;h(o||t,e,g=>{let M=K=>b(l,t,K);function H(){O(document,n,M),O(document,r,H),b(u,t,g)}h(document,n,M),h(document,r,H),b(a,t,g)})}function h(t,e,n){let r=!1;try{let i=Object.defineProperty({},"passive",{get:function(){r=!0}});globalThis.addEventListener("testPassive",null,i),globalThis.removeEventListener("testPassive",null,i)}catch(i){console.error(i)}t.addEventListener(e,n,r?{passive:!1}:!1)}function O(t,e,n){t.removeEventListener(e,n,!1)}function te(t,e="left"){if(t)return{begin:t.begin||p,change:t.change||p,end:t.end||p};let n,r;return{begin:function(i){let o=document.body.clientWidth;n={x:e==="left"?i.elem.offsetLeft:o-i.elem.offsetLeft-i.elem.clientWidth,y:i.elem.offsetTop},r=e==="left"?i.cursor:{x:o-i.cursor.x,y:i.cursor.y}},change:function(i){if(typeof n.x!="number"||typeof i.cursor.x!="number"||typeof r.x!="number")return;let o=document.body.clientWidth;W(i.elem,e,e==="left"?n.x+i.cursor.x-r.x+"px":n.x+(o-i.cursor.x)-r.x+"px"),!(typeof n.y!="number"||typeof i.cursor.y!="number"||typeof r.y!="number")&&W(i.elem,"top",n.y+i.cursor.y-r.y+"px")},end:p}}function W(t,e,n){t.style[e]=n}function p(){}function b(t,e,n){n.preventDefault();let r=ne(e),i=e.clientWidth,o=e.clientHeight,s={x:re(e,n),y:ie(e,n)};if(typeof s.x!="number"||typeof s.y!="number")return;let a=(s.x-r.x)/i,l=(s.y-r.y)/o;t({x:isNaN(a)?0:a,y:isNaN(l)?0:l,cursor:s,elem:e,e:n})}function ne(t){let e=t.getBoundingClientRect();return{x:e.left,y:e.top}}function re(t,e){return e instanceof TouchEvent?e.touches.item(0)?.clientX:e.clientX}function ie(t,e){return e instanceof TouchEvent?e.touches.item(0)?.clientY:e.clientY}var B=d(()=>{});function c(t,e){let n=t;return e.split(".").forEach(r=>{E(n)&&(n=n[r])}),n}var E,I=d(()=>{E=t=>typeof t=="object"});async function C(t,e,n){if(!e)return Promise.resolve({content:n});if("Deno"in globalThis){let r=await import("https://deno.land/std@0.107.0/path/mod.ts");return(await Promise.all(e.map(o=>{let s=r.join(t,`${o}.ts`);return Deno.env.get("DEBUG")==="1"&&console.log("importing transform",s,t,o),import("file://"+s)}))).reduce((o,s)=>s.default(o),n)}return Promise.all(e.map(r=>import(`/transforms/${r}.js`)))}var N=d(()=>{});import{tw as F}from"https://cdn.skypack.dev/twind@0.16.16?min";async function f(t,e,n,r){if(typeof e=="string")return e;let i=e.element&&n[e.element];if(e.__bind&&(E(e.__bind)?r={...r,__bound:e.__bind}:r={...r,__bound:c(r,e.__bind)}),i){if(Array.isArray(i))return await f(t,{element:"",children:i},n,r);e={...e,...i,class:se(e.class,i.class)}}if(e?.transformWith){let a;if(typeof e.inputText=="string")a=await C(t,e?.transformWith,e.inputText);else if(typeof e.inputProperty=="string"){let l=c(r,e.inputProperty);if(!l)throw console.error("Missing input",r,e.inputProperty),new Error("Missing input");a=await C(t,e?.transformWith,l)}r={...r,...a}}let o;if(e.__children){let a=e.__children,l=r.__bound||r;typeof a=="string"?o=c(l,a)||c(r,a):o=(await Promise.all((Array.isArray(l)?l:[l]).flatMap(u=>a.map(g=>f(t,g,n,{...r,__bound:u}))))).join("")}else if(e["==children"]){let a=e["==children"];o=T(a,r.__bound||r)}else o=Array.isArray(e.children)?(await Promise.all(e.children.map(async a=>await f(t,a,n,r)))).join(""):e.children;let s=oe(e,r);return ae(e.element,le(r,s?{...e.attributes,class:s}:e.attributes),o)}function oe(t,e){let n=[];return t.__class&&Object.entries(t.__class).forEach(([r,i])=>{T(i,{attributes:t.attributes,context:e})&&n.push(F(r))}),t.class?F(n.concat(t.class.split(" ")).join(" ")):n.join(" ")}function se(t,e){return t?e?`${t} ${e}`:t:e||""}function ae(t,e,n){return t?`<${t}${e}>${n||""}</${t}>`:typeof n=="string"?n:""}function le(t,e){if(!e)return"";let n=Object.entries(e).map(([r,i])=>r.startsWith("__")?`${r.slice(2)}="${c(t.__bound,i)||c(t,i)}"`:r.startsWith("==")?`${r.slice(2)}="${T(i,t.__bound||t)}"`:`${r}="${i}"`).filter(Boolean).join(" ");return n.length>0?" "+n:""}function T(t,e={}){try{return Function.apply(null,Object.keys(e).concat(`return ${t}`))(...Object.values(e))}catch(n){console.error("Failed to evaluate",t,e,n)}}var R=d(()=>{I();N()});function q(){let t=document.querySelector('meta[name="pagepath"]');if(!t){console.error("path element was not found!");return}let e=t.getAttribute("content");if(!e){console.log("pagePath was not found in path element");return}return e}var X=d(()=>{});var G={};x(G,{createEditor:()=>Y,toggleEditorVisibility:()=>me});import{produce as w}from"https://cdn.skypack.dev/immer@9.0.6?min";import{nanoid as de}from"https://cdn.skypack.dev/nanoid@3.1.30?min";async function Y(){console.log("create editor");let[t,e,n]=await Promise.all([fetch("/components.json").then(a=>a.json()),fetch("./context.json").then(a=>a.json()),fetch("./definition.json").then(a=>a.json())]),r=fe(n),i=document.createElement("div");i.setAttribute("x-label","selected"),i.setAttribute("x-state","{ componentId: undefined }"),r.appendChild(i);let o=await ye(t,e);i.append(o);let s=await he(t,e);i.append(s),document.body.appendChild(r),evaluateAllDirectives()}function fe(t){let e=document.getElementById(v);return e?.remove(),e=document.createElement("div"),e.id=v,e.style.visibility="visible",e.setAttribute("x-state",JSON.stringify({...t,body:ge(t.body)})),e.setAttribute("x-label","editor"),e}function me(){let t=document.getElementById(v);!t||(t.style.visibility=t.style.visibility==="visible"?"hidden":"visible")}function ge(t){return w(t,e=>{m(e,n=>{n._id=de()})})}function pe(t){let e=w(t.body,r=>{m(r,i=>{delete i._id,i.class===""&&delete i.class})}),n={path:q(),data:{...t,body:e}};window.developmentSocket.send(JSON.stringify({type:"update",payload:n}))}async function ye(t,e){console.log("Creating page editor");let n=document.createElement("div");n.id=ce,n.innerHTML=await f("",t.PageEditor,t,e);let r=n.children[0],i=r.children[0];return y({element:r,handle:i}),n}async function he(t,e){let n=document.createElement("div");n.id=ue,n.innerHTML=await f("",t.ComponentEditor,t,e);let r=n.children[0],i=r.children[0];return y({element:r,handle:i,xPosition:"right"}),n}function be(t,e){let{editor:{meta:n}}=getState(t),r=t.dataset.field;if(!r){console.error(`${r} was not found in ${t.dataset}`);return}if(r==="title"){let i=document.querySelector("title");i?i.innerHTML=e||"":console.warn("The page doesn't have a <title>!")}else{let i=document.head.querySelector("meta[name='"+r+"']");i?i.setAttribute("content",e):console.warn(`The page doesn't have a ${r} meta element!`)}setState({meta:{...n,[r]:e}},{element:t,parent:"editor"})}function Ee(t,e){event?.stopPropagation();let{editor:{body:n}}=getState(t),r=i=>{let o=i.target;if(!o){console.warn("inputListener - No element found");return}i.preventDefault(),z(t,o.textContent)};for(let i of L.values())i.classList.remove("border"),i.classList.remove("border-red-800"),i.removeAttribute("contenteditable"),i.removeEventListener("focusout",r),L.delete(i);m(n,(i,o)=>{if(i._id===e){let s=J(document.body,o,n);s.classList.add("border"),s.classList.add("border-red-800"),s.setAttribute("contenteditable","true"),s.addEventListener("focusout",r),L.add(s)}}),setState({componentId:e},{element:t,parent:"selected"})}function Ce(t,e){let{editor:{body:n},selected:{componentId:r}}=getState(t),i=S(n,r,(o,s)=>{s?.replaceWith(Te(s,e)),o.element=e});setState({body:i},{element:t,parent:"editor"})}function Te(t,e){let n=document.createElement(e),r=t.cloneNode(!0);for(;r.firstChild;)n.appendChild(r.firstChild);for(let i of r.attributes)n.setAttribute(i.name,i.value);return n}function z(t,e){let{editor:{body:n},selected:{componentId:r}}=getState(t),i=S(n,r,(o,s)=>{s&&(s.innerHTML=e),o.children=e});setState({body:i},{element:t,parent:"editor"})}function we(t,e){let{editor:{body:n},selected:{componentId:r}}=getState(t),i=S(n,r,(o,s)=>{s&&(s.setAttribute("class",e),s.classList.add("border"),s.classList.add("border-red-800")),o.class=e});setState({body:i},{element:t,parent:"editor"})}function S(t,e,n){return w(t,r=>{m(r,(i,o)=>{i._id===e&&n(i,J(document.body,o,t))})})}function J(t,e,n){let r=0;function i(o,s){if(!o)return null;if(Array.isArray(s)){let a=o;for(let l of s){let u=i(a,l);if(u)return u;a=a?.nextElementSibling}}else{if(e===r)return o;if(r++,Array.isArray(s.children)){let a=i(o.firstElementChild,s.children);if(a)return a}}return null}return i(t?.firstElementChild,n)}function ve(t,e){let n={},{componentId:r}=e;return m(t.body,i=>{i._id===r&&(n=i)}),n}function m(t,e){let n=0;function r(i,o){Array.isArray(i)?i.forEach(s=>r(s,o)):(o(i,n),n++,Array.isArray(i.children)&&r(i.children,o))}r(t,e)}function V(t,e=100){let n;return(...r)=>{clearTimeout(n),n=setTimeout(()=>{t.apply(this,r)},e)}}var ce,ue,v,L,U=d(()=>{B();R();X();ce="document-tree-element",ue="controls-element";v="editors";L=new Set;"Deno"in globalThis||(console.log("Hello from the page editor"),window.createEditor=Y,window.metaChanged=be,window.classChanged=V(we),window.elementClicked=Ee,window.elementChanged=Ce,window.contentChanged=V(z),window.getSelectedComponent=ve,window.updateFileSystem=pe)});"Deno"in globalThis||Promise.resolve().then(()=>(D(),j)).then(t=>{t.registerListener(Le)});function Le(t){console.log("initializing editor");let e=!1,n=document.createElement("button");n.className=t("fixed right-4 bottom-4 whitespace-nowrap text-lg"),n.innerText="\u{1F433}\u{1F4A8}",n.onclick=async()=>{let r=await Promise.resolve().then(()=>(U(),G));e?r.toggleEditorVisibility():(e=!0,r.createEditor())},document.body.appendChild(n)}
