var Z=Object.defineProperty;var u=(t,e)=>()=>(t&&(e=t(t=0)),e);var j=(t,e)=>{for(var i in e)Z(t,i,{get:e[i],enumerable:!0})};var $={};j($,{registerListener:()=>et});function tt(){let t={mode:"silent",target:document.body};Promise.all([import("https://cdn.skypack.dev/twind@0.16.16/shim?min"),import("/twindSetup.js")]).then(([{setup:e},i])=>{console.log("loaded custom twind setup",i.default),e({...t,...i.default}),import("https://cdn.skypack.dev/twind@0.16.16?min").then(({tw:n})=>{O=n,I=!0,z.forEach(o=>o(n))})})}function et(t){console.log("registering a twind runtime listener"),I?t(O):z.push(t)}var I,O,z,D=u(()=>{I=!1,z=[];"Deno"in globalThis||tt()});function N(t,e){let i=[],n=t.parentElement;for(;n;)n.hasAttribute(e)&&i.push(n),n=n.parentElement;return i}var k=u(()=>{});function B(t,e){let i=document.createElement(e),n=t.cloneNode(!0);for(;n.firstChild;)i.appendChild(n.firstChild);for(let o of n.attributes)i.setAttribute(o.name,o.value);return i}var R=u(()=>{});function h(t,e){let i=0;function n(o,r){Array.isArray(o)?o.forEach(s=>n(s,r)):(r(o,i),i++,Array.isArray(o.children)&&n(o.children,r),o.props&&n(Object.values(o.props),r))}n(t,e)}var V=u(()=>{});function C(t){return typeof t>"u"}function p(t,e,i){if(!e)return;let n=t;return e.split(".").forEach(o=>{f(n)&&(n=n[o])}),C(n)?i:n}var f,E=u(()=>{f=t=>!Array.isArray(t)&&typeof t=="object"});async function q(t,e,i){return Object.fromEntries(await Promise.all(Object.entries(t).map(async([n,o])=>[n,typeof o=="string"?o:await d(o,e,i)])))}async function d(t,e,i){if(!e)throw new Error("applyUtility - No utilities were provided");let n=e[t.utility];if(!n)throw console.error({utilities:e,value:t}),new Error("applyUtility - Matching utility was not found");let o=await Promise.all(Array.isArray(t.parameters)?t.parameters.map(r=>{if(typeof r!="string"){if(r.utility&&r.parameters)return d(r,e,i)}return r}):[]);return n.apply(null,[i].concat(o))}var w=u(()=>{});var L,F=u(()=>{E();L={concat:(t,...e)=>e.join(""),get:(t,e,i,n)=>p(p(t,e),i,n)}});async function y({component:t,components:e,extensions:i,context:n,props:o,utilities:r}){let s=(c,Y)=>y({component:Y,components:e,extensions:i,context:n,utilities:r});if(r=f(r)?{render:s,...L,...r}:{render:s,...L},Array.isArray(t))return(await Promise.all(t.map(c=>y({component:c,components:e,extensions:i,context:n,props:o,utilities:r})))).join("");let a=t.type,l=a&&typeof a=="string"&&e?.[a];if(o=t.props||o,t.bindToProps&&(o={...await q(t.bindToProps,r,{context:n,props:o}),...o}),l)return(await Promise.all((Array.isArray(l)?l:[l]).map(c=>y({component:c,components:e,extensions:i,context:n,props:o,utilities:r})))).join("");if(i){for(let c of i)t=await c(t,{props:o,context:n},r);a=t.type}let m=await nt(t.attributes,{props:o,context:n},r),g=a;if(typeof a=="string"||a?.utility&&a?.parameters&&(g=await d(a,r,{context:n,props:o})),t.children){let c=t.children;return typeof c=="string"||(Array.isArray(c)?c=await y({component:c,props:o,components:e,extensions:i,context:n,utilities:r}):c.utility&&r&&(c=await d(c,r,{context:n,props:o}))),_(g,m,c)}return a?typeof t.closingCharacter=="string"?`<${g}${m?" "+m:""} ${t.closingCharacter}>`:_(g,m):""}function _(t,e,i=""){return t?`<${t}${e?" "+e:""}>${i}</${t}>`:i||""}async function nt(t,e,i){return t?(await it(t,e,i)).map(([n,o])=>o&&o.length>0?`${n}="${o}"`:n).join(" "):""}async function it(t,e,i){return t?Promise.all(await Object.entries(t).map(async([n,o])=>{if(C(o))return[];let r=o;return C(r)?[]:(r.context?r=p(p(e,r.context),r.property,r.default):r.utility&&i&&(r=await d(r,i,e)),[n,r])})):[]}var T,W=u(()=>{E();w();F();T=y});import{getStyleTag as It,getStyleTagProperties as Ot,virtualSheet as zt}from"https://cdn.skypack.dev/twind@0.16.16/sheets?min";import{draggable as x}from"https://cdn.skypack.dev/dragjs@v0.13.3?min";import{produce as S}from"https://cdn.skypack.dev/immer@9.0.6?min";import{setup as kt}from"https://cdn.skypack.dev/twind@0.16.16?min";import{tw as J}from"https://cdn.skypack.dev/twind@0.16.16?min";var v=u(()=>{});async function A(t,e,i){let n=[];if(typeof t.class=="string"?n.push(t.class):t.class?.utility&&t.class.parameters&&n.push(await d(t.class,i,e)),f(t.classList)){let o=(await Promise.all(await Object.entries(t.classList).map(async([r,s])=>{let a=await d(s[0],i,e);if(s.length===1)return a;let l=(await Promise.all(s.map(async m=>a===await d(m,i,e)))).filter(Boolean);return s.length===l.length&&r}))).filter(Boolean).join(" ");n.push(o)}return n.length?{...t,attributes:{...t.attributes,class:n.map(o=>J(o)).join(" ")}}:t}async function P(t,e,i){if(!e||!t.foreach)return Promise.resolve(t);let[n,o]=t.foreach,r=await d(n,i,e);return Array.isArray(r)?Promise.resolve({...t,children:r.flatMap(s=>Array.isArray(o)?o.map(a=>({...a,props:f(s)?s:{value:s}})):{...o,props:f(s)?s:{value:s}})}):Promise.resolve(t)}async function U(t,e,i){if(!Array.isArray(t.visibleIf))return Promise.resolve(t);if(t.visibleIf.length===0)return Promise.resolve({});let o=(await Promise.all(t.visibleIf.map(async r=>await d(r,i,e)))).filter(Boolean).length===t.visibleIf.length;return Promise.resolve(o?t:{})}var G=u(()=>{v();E();w()});var Q={};j(Q,{createEditor:()=>K,toggleEditorVisibility:()=>ut});async function K(){console.log("create editor");let[t,e,i,n]=await Promise.all([fetch("/components.json").then(l=>l.json()),fetch("./context.json").then(l=>l.json()),fetch("./layout.json").then(l=>l.json()),fetch("./route.json").then(l=>l.json())]),o=dt(i,n),r=await mt(t,e);o.append(r);let s=await ft(t,e);o.append(s),document.body.appendChild(o),evaluateAllDirectives();let a=st(o);globalThis.onclick=({target:l})=>a(l),globalThis.ontouchstart=({target:l})=>a(l)}function st(t){return function(i){if(!i)return;let n=i,o=n.hasAttribute("data-id")?n:N(n,"data-id")[0];if(!o)return;let r=o.getAttribute("data-id"),{editor:{layout:s}}=getState(t);setState({selectionId:r},{element:t,parent:"editor"}),o&&lt(t,o,s)}}function lt(t,e,i){let n,o=e.dataset.id;if(!o){console.log("target doesn't have a selection id");return}let r=a=>{!a||!a.target||ct(t,i,o,a.target,n)},s=a=>{if(!a.target){console.warn("inputListener - No element found");return}a.preventDefault(),e.removeAttribute("contenteditable"),e.removeEventListener("input",r),e.removeEventListener("focusout",s)};b&&(b.classList.remove("border"),b.classList.remove("border-red-800")),b=e,e.classList.add("border"),e.classList.add("border-red-800"),e.children.length===0&&e.textContent&&(n=e.textContent,e.setAttribute("contenteditable","true"),e.addEventListener("focusout",s),e.addEventListener("input",r),e.focus())}function ct(t,e,i,n,o){let r=n.textContent;if(o===r){console.log("content didn't change");return}if(typeof r!="string")return;console.log("content changed",r);let s=S(e,l=>{h(l,m=>{m?.attributes?.["data-id"]===i&&(m.children=r)})}),a=t.children[0];setState({layout:s},{element:a,parent:"editor"})}function dt(t,e){let i=document.getElementById(M),n={layout:t,meta:e.meta,selectionId:void 0};return i?.remove(),i=document.createElement("div"),i.id=M,i.style.visibility="visible",i.setAttribute("x-state",JSON.stringify(n)),i.setAttribute("x-label","editor"),i}function ut(){let t=document.getElementById(M);!t||(t.style.visibility=t.style.visibility==="visible"?"hidden":"visible")}async function mt(t,e){console.log("creating page editor");let i=document.createElement("div");i.id=rt,i.innerHTML=await T({component:t.PageEditor,components:t,context:e,extensions:[A,P,U]});let n=i.children[0],o=n.children[0];return x({element:n,handle:o}),i}async function ft(t,e){let i=document.createElement("div");i.id=at,i.innerHTML=await T({component:t.ComponentEditor,components:t,context:e,extensions:[A,P,U]});let n=i.children[0],o=n.children[0];return x({element:n,handle:o,xPosition:"right"}),i}function pt(t,e){let{editor:{meta:i}}=getState(t),n=t.dataset.field;if(!n){console.error(`${n} was not found in ${t.dataset}`);return}if(n==="title"){let o=document.querySelector("title");o?o.innerHTML=e||"":console.warn("The page doesn't have a <title>!")}else{let o=document.head.querySelector("meta[name='"+n+"']");o?o.setAttribute("content",e):console.warn(`The page doesn't have a ${n} meta element!`)}setState({meta:{...i,[n]:e}},{element:t,parent:"editor"})}function yt(t,e){let{editor:{layout:i,selectionId:n}}=getState(t),o=H(i,n,(r,s)=>{s.forEach(a=>{a.innerHTML=e}),r.children=e});setState({layout:o},{element:t,parent:"editor"})}function gt(t,e){let{editor:{layout:i,selectionId:n}}=getState(t),o=H(i,n,(r,s)=>{Array.isArray(r)||(s.forEach(a=>a.setAttribute("class",e)),r.class=e)});setState({layout:o},{element:t,parent:"editor"})}function ht(t,e){let{editor:{layout:i,selectionId:n}}=getState(t),o=H(i,n,(r,s)=>{Array.isArray(r)||(s.forEach(a=>a.replaceWith(B(a,e))),r.type=e)});setState({layout:o},{element:t,parent:"editor"})}function H(t,e,i){return S(t,n=>{h(n,o=>{o?.attributes?.["data-id"]===e&&i(o,Array.from(document.querySelectorAll(`*[data-id="${e}"]`)))})})}function Ct(t){let{layout:e,selectionId:i}=t;if(!i)return{};let n;return h(e,o=>{o?.attributes?.["data-id"]===i&&(n=o)}),n}var rt,at,b,M,X=u(()=>{k();R();V();W();G();v();rt="document-tree-element",at="controls-element";M="editors";"Deno"in globalThis||(console.log("Hello from the page editor"),window.createEditor=K,window.classChanged=gt,window.contentChanged=yt,window.getSelectedComponent=Ct,window.metaChanged=pt,window.elementChanged=ht)});"Deno"in globalThis||Promise.resolve().then(()=>(D(),$)).then(t=>{t.registerListener(Et)});function Et(t){console.log("initializing editor");let e=!1,i=document.createElement("button");i.className=t("fixed right-4 bottom-4 whitespace-nowrap text-lg"),i.innerText="\u{1F433}\u{1F4A8}",i.onclick=async()=>{let n=await Promise.resolve().then(()=>(X(),Q));e?n.toggleEditorVisibility():(e=!0,n.createEditor())},document.body.appendChild(i)}
