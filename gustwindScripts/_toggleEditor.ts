var ie=Object.defineProperty;var d=(e,t)=>()=>(e&&(t=e(e=0)),t);var O=(e,t)=>{for(var n in t)ie(e,n,{get:t[n],enumerable:!0})};var z={};O(z,{registerListener:()=>ae});function se(){let e={mode:"silent",target:document.body};Promise.all([import("https://cdn.skypack.dev/twind@0.16.16/shim?min"),import("/twindSetup.js")]).then(([{setup:t},n])=>{console.log("loaded custom twind setup",n.default),t({...e,...n.default}),import("https://cdn.skypack.dev/twind@0.16.16?min").then(({tw:r})=>{D=r,k=!0,$.forEach(o=>o(r))})})}function ae(e){console.log("registering a twind runtime listener"),k?e(D):$.push(e)}var k,D,$,N=d(()=>{k=!1,$=[];"Deno"in globalThis||se()});function x({element:e,handle:t,xPosition:n},r){if(!e){console.warn("drag is missing elem!");return}W(e,"touchstart","touchmove","touchend",r,t,n),W(e,"mousedown","mousemove","mouseup",r,t,n)}function W(e,t,n,r,o,i,s){o=le(o,s="left");let l=o.begin,a=o.change,u=o.end;v(i||e,t,p=>{let c=oe=>w(a,e,oe);function y(){R(document,n,c),R(document,r,y),w(u,e,p)}v(document,n,c),v(document,r,y),w(l,e,p)})}function v(e,t,n){let r=!1;try{let o=Object.defineProperty({},"passive",{get:function(){r=!0}});globalThis.addEventListener("testPassive",null,o),globalThis.removeEventListener("testPassive",null,o)}catch(o){console.error(o)}e.addEventListener(t,n,r?{passive:!1}:!1)}function R(e,t,n){e.removeEventListener(t,n,!1)}function le(e,t="left"){if(e)return{begin:e.begin||E,change:e.change||E,end:e.end||E};let n,r;return{begin:function(o){let i=document.body.clientWidth;n={x:t==="left"?o.elem.offsetLeft:i-o.elem.offsetLeft-o.elem.clientWidth,y:o.elem.offsetTop},r=t==="left"?o.cursor:{x:i-o.cursor.x,y:o.cursor.y}},change:function(o){if(typeof n.x!="number"||typeof o.cursor.x!="number"||typeof r.x!="number")return;let i=document.body.clientWidth;V(o.elem,t,t==="left"?n.x+o.cursor.x-r.x+"px":n.x+(i-o.cursor.x)-r.x+"px"),!(typeof n.y!="number"||typeof o.cursor.y!="number"||typeof r.y!="number")&&V(o.elem,"top",n.y+o.cursor.y-r.y+"px")},end:E}}function V(e,t,n){e.style[t]=n}function E(){}function w(e,t,n){n.preventDefault();let r=ce(t),o=t.clientWidth,i=t.clientHeight,s={x:ue(t,n),y:de(t,n)};if(typeof s.x!="number"||typeof s.y!="number")return;let l=(s.x-r.x)/o,a=(s.y-r.y)/i;e({x:isNaN(l)?0:l,y:isNaN(a)?0:a,cursor:s,elem:t,e:n})}function ce(e){let t=e.getBoundingClientRect();return{x:t.left,y:t.top}}function ue(e,t){return t instanceof TouchEvent?t.touches.item(0)?.clientX:t.clientX}function de(e,t){return t instanceof TouchEvent?t.touches.item(0)?.clientY:t.clientY}var B=d(()=>{});function F(e,t){let n=[],r=e.parentElement;for(;r;)r.hasAttribute(t)&&n.push(r),r=r.parentElement;return n}var U=d(()=>{});function q(e,t){let n=document.createElement(t),r=e.cloneNode(!0);for(;r.firstChild;)n.appendChild(r.firstChild);for(let o of r.attributes)n.setAttribute(o.name,o.value);return n}var X=d(()=>{});function C(e,t){let n=0;function r(o,i){Array.isArray(o)?o.forEach(s=>r(s,i)):(i(o,n),n++,Array.isArray(o.children)&&r(o.children,i),o.props&&r(Object.values(o.props),i))}r(e,t)}var Y=d(()=>{});function S(e){return typeof e>"u"}function f(e,t){if(!t)return;let n=e;return t.split(".").forEach(r=>{g(n)&&(n=n[r])}),n}var g,L=d(()=>{g=e=>!Array.isArray(e)&&typeof e=="object"});function m(e,t={},n=!0){try{return Promise.resolve(Function.apply(null,Object.keys(t).concat(`return ${e}`))(...Object.values(t)))}catch(r){n&&console.error("Failed to evaluate",e,t,r)}}var H=d(()=>{L()});async function b({component:e,components:t,extensions:n,context:r,props:o,utilities:i}){if(Array.isArray(e))return(await Promise.all(e.map(c=>b({component:c,components:t,extensions:n,context:r,props:o,utilities:i})))).join("");let s=e.element,l=s&&t?.[s],a=Object.fromEntries(await J(e.props||o,{context:r,props:o}));if(l)return(await Promise.all((Array.isArray(l)?l:[l]).map(c=>b({component:c,components:t,extensions:n,context:r,props:a,utilities:i})))).join("");if(n){for(let c of n)e=await c(e,{props:a,context:r,utilities:i});s=e.element}e.__element&&(s=f({context:r,props:a},e.__element)||s),e["==element"]&&(s=await m(e["==element"],{props:a,context:r,utilities:i}));let u=await fe(e.attributes,typeof e.props!="string"?{props:a,context:r,utilities:i}:r);if(e.children){let c=e.children;return Array.isArray(c)&&(c=await b({component:c,props:a,components:t,extensions:n,context:r,utilities:i})),h(s,u,c)}if(e.__children)return h(s,u,f({context:r,props:a},e.__children));if(e["##children"])return h(s,u,await b({component:f({context:r,props:a},e["##children"]),components:t,extensions:n,context:r,utilities:i}));let p=e["==children"];return p?h(s,u,await m(p,{props:a,context:r,utilities:i})):s?typeof e.closingCharacter=="string"?`<${s}${u?" "+u:""} ${e.closingCharacter}>`:h(s,u):""}function h(e,t,n=""){return e?`<${e}${t?" "+t:""}>${n}</${e}>`:n||""}async function fe(e,t){return e?(await J(e,t)).map(([n,r])=>r&&r.length>0?`${n}="${r}"`:n).join(" "):""}async function J(e,t){return e?await Promise.all(Object.entries(e).map(async([n,r])=>{if(S(r))return[];let o=n,i=r;return n.startsWith("__")&&(o=n.split("__").slice(1).join("__"),i=f(t,r)),n.startsWith("==")&&typeof r=="string"&&(o=n.split("==").slice(1).join("=="),i=await m(r,t)),S(i)?[]:[o,i]})):Promise.resolve([])}var M,G=d(()=>{L();H();M=b});import{getStyleTag as We,getStyleTagProperties as Re,virtualSheet as Ve}from"https://cdn.skypack.dev/twind@0.16.16/sheets?min";import{setup as Fe}from"https://cdn.skypack.dev/twind@0.16.16?min";import{tw as K}from"https://cdn.skypack.dev/twind@0.16.16?min";var Q=d(()=>{});async function P(e,t){let n=[];if(typeof e.class=="string"&&n.push(e.class),typeof e.__class=="string"&&n.push(f(t,e.__class)),typeof e["==class"]=="string"&&n.push(await m(e["==class"],t)),g(e.classList)){let r=(await Promise.all(Object.entries(e.classList).map(async([o,i])=>await m(i,t)&&o))).filter(Boolean).join(" ");n.push(r)}return n.length?Promise.resolve({...e,attributes:{...e.attributes,class:n.map(r=>K(r)).join(" ")}}):Promise.resolve(e)}function A(e,t){if(!t||!e.foreach)return Promise.resolve(e);let[n,r]=e.foreach,o=f(t,n);return Array.isArray(o)?Promise.resolve({...e,children:o.flatMap(i=>Array.isArray(r)?r.map(s=>({...s,props:g(i)?i:{value:i}})):{...r,props:g(i)?i:{value:i}})}):Promise.resolve(e)}async function j(e,t){return typeof e.visibleIf!="string"?Promise.resolve(e):await m(e.visibleIf,t)?e:{}}var Z=d(()=>{Q();L();H()});var ne={};O(ne,{createEditor:()=>te,toggleEditorVisibility:()=>Ee});import{produce as ee}from"https://cdn.skypack.dev/immer@9.0.6?min";async function te(){console.log("create editor");let[e,t,n,r]=await Promise.all([fetch("/components.json").then(a=>a.json()),fetch("./context.json").then(a=>a.json()),fetch("./layout.json").then(a=>a.json()),fetch("./route.json").then(a=>a.json())]),o=be(n,r),i=await Ce(e,t);o.append(i);let s=await Le(e,t);o.append(s),document.body.appendChild(o),evaluateAllDirectives();let l=ye(o);globalThis.onclick=({target:a})=>l(a),globalThis.ontouchstart=({target:a})=>l(a)}function ye(e){return function(n){if(!n)return;let r=n,o=r.hasAttribute("data-id")?r:F(r,"data-id")[0];if(!o)return;let i=o.getAttribute("data-id"),{editor:{layout:s}}=getState(e);setState({selectionId:i},{element:e,parent:"editor"}),o&&he(e,o,s)}}function he(e,t,n){let r,o=t.dataset.id;if(!o){console.log("target doesn't have a selection id");return}let i=s=>{let l=s.target;if(!l){console.warn("inputListener - No element found");return}s.preventDefault(),t.removeAttribute("contenteditable"),t.removeEventListener("focusout",i);let a=l.textContent;if(r===a){console.log("content didn't change");return}if(typeof a!="string")return;console.log("content changed",a);let u=ee(n,c=>{C(c,y=>{y?.attributes?.["data-id"]===o&&(y.children=a)})}),p=e.children[0];setState({layout:u},{element:p,parent:"editor"})};T&&(T.classList.remove("border"),T.classList.remove("border-red-800")),T=t,t.classList.add("border"),t.classList.add("border-red-800"),t.children.length===0&&t.textContent&&(r=t.textContent,t.setAttribute("contenteditable","true"),t.addEventListener("focusout",i),t.focus())}function be(e,t){let n=document.getElementById(_),r={layout:e,meta:t.meta,selectionId:void 0};return n?.remove(),n=document.createElement("div"),n.id=_,n.style.visibility="visible",n.setAttribute("x-state",JSON.stringify(r)),n.setAttribute("x-label","editor"),n}function Ee(){let e=document.getElementById(_);!e||(e.style.visibility=e.style.visibility==="visible"?"hidden":"visible")}async function Ce(e,t){console.log("creating page editor");let n=document.createElement("div");n.id=pe,n.innerHTML=await M({component:e.PageEditor,components:e,context:t,extensions:[P,A,j]});let r=n.children[0],o=r.children[0];return x({element:r,handle:o}),n}async function Le(e,t){let n=document.createElement("div");n.id=ge,n.innerHTML=await M({component:e.ComponentEditor,components:e,context:t,extensions:[P,A,j]});let r=n.children[0],o=r.children[0];return x({element:r,handle:o,xPosition:"right"}),n}function Te(e,t){let{editor:{meta:n}}=getState(e),r=e.dataset.field;if(!r){console.error(`${r} was not found in ${e.dataset}`);return}if(r==="title"){let o=document.querySelector("title");o?o.innerHTML=t||"":console.warn("The page doesn't have a <title>!")}else{let o=document.head.querySelector("meta[name='"+r+"']");o?o.setAttribute("content",t):console.warn(`The page doesn't have a ${r} meta element!`)}setState({meta:{...n,[r]:t}},{element:e,parent:"editor"})}function ve(e,t){let{editor:{layout:n,selectionId:r}}=getState(e),o=I(n,r,(i,s)=>{s.forEach(l=>{l.innerHTML=t}),i.children=t});setState({layout:o},{element:e,parent:"editor"})}function we(e,t){let{editor:{layout:n,selectionId:r}}=getState(e),o=I(n,r,(i,s)=>{Array.isArray(i)||(s.forEach(l=>l.setAttribute("class",t)),i.class=t)});setState({layout:o},{element:e,parent:"editor"})}function xe(e,t){let{editor:{layout:n,selectionId:r}}=getState(e),o=I(n,r,(i,s)=>{Array.isArray(i)||(s.forEach(l=>l.replaceWith(q(l,t))),i.element=t)});setState({layout:o},{element:e,parent:"editor"})}function I(e,t,n){return ee(e,r=>{C(r,o=>{o?.attributes?.["data-id"]===t&&n(o,Array.from(document.querySelectorAll(`*[data-id="${t}"]`)))})})}function Se(e){let{layout:t,selectionId:n}=e;if(!n)return{};let r;return C(t,o=>{o?.attributes?.["data-id"]===n&&(r=o)}),r}var pe,ge,T,_,re=d(()=>{B();U();X();Y();G();Z();pe="document-tree-element",ge="controls-element";_="editors";"Deno"in globalThis||(console.log("Hello from the page editor"),window.createEditor=te,window.classChanged=we,window.contentChanged=ve,window.getSelectedComponent=Se,window.metaChanged=Te,window.elementChanged=xe)});"Deno"in globalThis||Promise.resolve().then(()=>(N(),z)).then(e=>{e.registerListener(He)});function He(e){console.log("initializing editor");let t=!1,n=document.createElement("button");n.className=e("fixed right-4 bottom-4 whitespace-nowrap text-lg"),n.innerText="\u{1F433}\u{1F4A8}",n.onclick=async()=>{let r=await Promise.resolve().then(()=>(re(),ne));t?r.toggleEditorVisibility():(t=!0,r.createEditor())},document.body.appendChild(n)}
