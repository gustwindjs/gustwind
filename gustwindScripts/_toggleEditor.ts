var H=Object.defineProperty;var ee=t=>H(t,"__esModule",{value:!0});var c=(t,e)=>()=>(t&&(e=t(t=0)),e);var k=(t,e)=>{ee(t);for(var n in e)H(t,n,{get:e[n],enumerable:!0})};var D={};k(D,{registerListener:()=>ne});function te(){let t={mode:"silent",target:document.body};Promise.all([import("https://cdn.skypack.dev/twind@0.16.16/shim?min"),import("/twindSetup.js")]).then(([{setup:e},n])=>{console.log("loaded custom twind setup",n.default),e({...t,...n.default}),import("https://cdn.skypack.dev/twind@0.16.16?min").then(({tw:i})=>{P=i,A=!0,j.forEach(r=>r(i))})})}function ne(t){console.log("registering a twind runtime listener"),A?t(P):j.push(t)}var A,P,j,O=c(()=>{A=!1,j=[];"Deno"in globalThis||te()});function b({element:t,handle:e,xPosition:n},i){if(!t){console.warn("drag is missing elem!");return}$(t,"touchstart","touchmove","touchend",i,e,n),$(t,"mousedown","mousemove","mouseup",i,e,n)}function $(t,e,n,i,r,o,s){r=ie(r,s="left");let a=r.begin,l=r.change,u=r.end;E(o||t,e,y=>{let S=Z=>C(l,t,Z);function x(){I(document,n,S),I(document,i,x),C(u,t,y)}E(document,n,S),E(document,i,x),C(a,t,y)})}function E(t,e,n){let i=!1;try{let r=Object.defineProperty({},"passive",{get:function(){i=!0}});globalThis.addEventListener("testPassive",null,r),globalThis.removeEventListener("testPassive",null,r)}catch(r){console.error(r)}t.addEventListener(e,n,i?{passive:!1}:!1)}function I(t,e,n){t.removeEventListener(e,n,!1)}function ie(t,e="left"){if(t)return{begin:t.begin||h,change:t.change||h,end:t.end||h};let n,i;return{begin:function(r){let o=document.body.clientWidth;n={x:e==="left"?r.elem.offsetLeft:o-r.elem.offsetLeft-r.elem.clientWidth,y:r.elem.offsetTop},i=e==="left"?r.cursor:{x:o-r.cursor.x,y:r.cursor.y}},change:function(r){if(typeof n.x!="number"||typeof r.cursor.x!="number"||typeof i.x!="number")return;let o=document.body.clientWidth;W(r.elem,e,e==="left"?n.x+r.cursor.x-i.x+"px":n.x+(o-r.cursor.x)-i.x+"px"),!(typeof n.y!="number"||typeof r.cursor.y!="number"||typeof i.y!="number")&&W(r.elem,"top",n.y+r.cursor.y-i.y+"px")},end:h}}function W(t,e,n){t.style[e]=n}function h(){}function C(t,e,n){n.preventDefault();let i=re(e),r=e.clientWidth,o=e.clientHeight,s={x:oe(e,n),y:se(e,n)};if(typeof s.x!="number"||typeof s.y!="number")return;let a=(s.x-i.x)/r,l=(s.y-i.y)/o;t({x:isNaN(a)?0:a,y:isNaN(l)?0:l,cursor:s,elem:e,e:n})}function re(t){let e=t.getBoundingClientRect();return{x:e.left,y:e.top}}function oe(t,e){return e instanceof TouchEvent?e.touches.item(0)?.clientX:e.clientX}function se(t,e){return e instanceof TouchEvent?e.touches.item(0)?.clientY:e.clientY}var B=c(()=>{});function d(t,e){let n=t;return e.split(".").forEach(i=>{m(n)&&(n=n[i])}),n}var m,T=c(()=>{m=t=>typeof t=="object"});async function v(t,e,n,i){if(!n)return Promise.resolve(i);if("Deno"in globalThis){let r=await import("https://deno.land/std@0.107.0/path/mod.ts");return(await Promise.all(n.map(s=>{let a=r.join(e,`${s}.ts`);return Deno.env.get("DEBUG")==="1"&&console.log("importing transform",a,e,s),t==="production"?import("file://"+a):import("file://"+a+"?cache="+new Date().getTime())}))).reduce((s,a)=>a.default(s),i)}return Promise.all(n.map(r=>import(`/transforms/${r}.js`)))}var R=c(()=>{});function F(t,e){return!t||!e?[]:Object.entries(e).map(([n,i])=>ae(t,n,i))}function ae(t,e,n){if(e.startsWith("__"))return[e.slice(2),d(t.__bound,n)||d(t,n)];if(e.startsWith("==")){let i=t.__bound||t;return[e.slice(2),p(n,m(i)?i:{data:i})]}return[e,n]}function p(t,e={}){try{return Function.apply(null,Object.keys(e).concat(`return ${t}`))(...Object.values(e))}catch(n){console.error("Failed to evaluate",t,e,n)}}var N=c(()=>{T()});import{tw as q}from"https://cdn.skypack.dev/twind@0.16.16?min";async function f(t,e,n,i){if(typeof e=="string")return e;let r=e.element&&n[e.element];if(e.__bind&&(m(e.__bind)?i={...i,__bound:e.__bind}:i={...i,__bound:d(i,e.__bind)||d(i.__bound,e.__bind)}),e.visibleIf){let a=e.visibleIf;if(!p(a,i.__bound||i))return Promise.resolve("")}if(r){if(Array.isArray(r))return await f(t,{element:"",children:r},n,i);e={...e,...r,element:r.element,class:de(e.class,r.class)}}if(e?.transformWith){let a;if(typeof e.inputText=="string")a=await v("production",t,e?.transformWith,e.inputText);else if(typeof e.inputProperty=="string"){let l=d(i,e.inputProperty);if(!l)throw console.error("Missing input",i,e.inputProperty),new Error("Missing input");a=await v("production",t,e?.transformWith,l)}i={...i,...a}}let o;if(e.__children){let a=e.__children,l=i.__bound||i;typeof a=="string"?o=d(l,a)||d(i,a):o=(await Promise.all((Array.isArray(l)?l:[l]).flatMap(u=>a.map(y=>f(t,y,n,{...i,__bound:u}))))).join("")}else if(e["==children"]){let a=e["==children"];o=p(a,i.__bound||i)}else o=Array.isArray(e.children)?(await Promise.all(e.children.map(async a=>await f(t,a,n,i)))).join(""):e.children;let s=le(e,i);return ce(e.element,ue(i,s?{...e.attributes,class:s}:e.attributes),o)}function le(t,e){let n=[];return t.__class&&Object.entries(t.__class).forEach(([i,r])=>{p(r,{attributes:t.attributes,context:e})&&n.push(q(i))}),t.class?q(n.concat(t.class.split(" ")).join(" ")):n.join(" ")}function de(t,e){return t?e?`${t} ${e}`:t:e||""}function ce(t,e,n){return t?`<${t}${e?" "+e:""}>${n||""}</${t}>`:typeof n=="string"?n:""}function ue(t,e){return e?F(t,e).map(([n,i])=>`${n}="${i}"`).join(" "):""}var z=c(()=>{T();R();N()});function X(){let t=document.querySelector('meta[name="pagepath"]');if(!t){console.error("path element was not found!");return}let e=t.getAttribute("content");if(!e){console.log("pagePath was not found in path element");return}return e}var Y=c(()=>{});var K={};k(K,{createEditor:()=>J,toggleEditorVisibility:()=>ye});import{produce as w}from"https://cdn.skypack.dev/immer@9.0.6?min";import{nanoid as fe}from"https://cdn.skypack.dev/nanoid@3.1.30?min";async function J(){console.log("create editor");let[t,e,n,i]=await Promise.all([fetch("/components.json").then(l=>l.json()),fetch("./context.json").then(l=>l.json()),fetch("./layout.json").then(l=>l.json()),fetch("./route.json").then(l=>l.json())]),r=ge(n,i),o=document.createElement("div");o.setAttribute("x-label","selected"),o.setAttribute("x-state","{ componentId: undefined }"),r.appendChild(o);let s=await Ee(t,e);o.append(s);let a=await Ce(t,e);o.append(a),document.body.appendChild(r),evaluateAllDirectives()}function ge(t,e){let n=document.getElementById(L);return n?.remove(),n=document.createElement("div"),n.id=L,n.style.visibility="visible",n.setAttribute("x-state",JSON.stringify({...t,body:he(t.body),meta:e.meta})),n.setAttribute("x-label","editor"),n}function ye(){let t=document.getElementById(L);!t||(t.style.visibility=t.style.visibility==="visible"?"hidden":"visible")}function he(t){if(!t){console.error("initializeBody - missing body");return}return w(t,e=>{g(e,n=>{n._id=fe()})})}function be(t){let e=w(t.body,i=>{g(i,r=>{delete r._id,r.class===""&&delete r.class})}),n={path:X(),data:{...t,body:e}};window.developmentSocket.send(JSON.stringify({type:"update",payload:n}))}async function Ee(t,e){console.log("creating page editor");let n=document.createElement("div");n.id=me,n.innerHTML=await f("",t.PageEditor,t,e);let i=n.children[0],r=i.children[0];return b({element:i,handle:r}),n}async function Ce(t,e){let n=document.createElement("div");n.id=pe,n.innerHTML=await f("",t.ComponentEditor,t,e);let i=n.children[0],r=i.children[0];return b({element:i,handle:r,xPosition:"right"}),n}function Te(t,e){let{editor:{meta:n}}=getState(t),i=t.dataset.field;if(!i){console.error(`${i} was not found in ${t.dataset}`);return}if(i==="title"){let r=document.querySelector("title");r?r.innerHTML=e||"":console.warn("The page doesn't have a <title>!")}else{let r=document.head.querySelector("meta[name='"+i+"']");r?r.setAttribute("content",e):console.warn(`The page doesn't have a ${i} meta element!`)}setState({meta:{...n,[i]:e}},{element:t,parent:"editor"})}function ve(t,e){event?.stopPropagation();let{editor:{body:n}}=getState(t),i=r=>{let o=r.target;if(!o){console.warn("inputListener - No element found");return}r.preventDefault(),V(t,o.textContent)};for(let r of _.values())r.classList.remove("border"),r.classList.remove("border-red-800"),r.removeAttribute("contenteditable"),r.removeEventListener("focusout",i),_.delete(r);g(n,(r,o)=>{if(r._id===e){let s=G(document.body,o,n);s.classList.add("border"),s.classList.add("border-red-800"),_.add(s),Array.isArray(r.children)||(s.setAttribute("contenteditable","true"),s.addEventListener("focusout",i))}}),setState({componentId:e},{element:t,parent:"selected"})}function we(t,e){let{editor:{body:n},selected:{componentId:i}}=getState(t),r=M(n,i,(o,s)=>{s?.replaceWith(Le(s,e)),o.element=e});setState({body:r},{element:t,parent:"editor"})}function Le(t,e){let n=document.createElement(e),i=t.cloneNode(!0);for(;i.firstChild;)n.appendChild(i.firstChild);for(let r of i.attributes)n.setAttribute(r.name,r.value);return n}function V(t,e){let{editor:{body:n},selected:{componentId:i}}=getState(t),r=M(n,i,(o,s)=>{s&&(s.innerHTML=e),o.children=e});setState({body:r},{element:t,parent:"editor"})}function _e(t,e){let{editor:{body:n},selected:{componentId:i}}=getState(t),r=M(n,i,(o,s)=>{s&&(s.setAttribute("class",e),s.classList.add("border"),s.classList.add("border-red-800")),o.class=e});setState({body:r},{element:t,parent:"editor"})}function M(t,e,n){return w(t,i=>{g(i,(r,o)=>{r._id===e&&n(r,G(document.body,o,t))})})}function G(t,e,n){let i=0;function r(o,s){if(!o)return null;if(Array.isArray(s)){let a=o;for(let l of s){let u=r(a,l);if(u)return u;a=a?.nextElementSibling}}else{if(e===i)return o;if(i++,Array.isArray(s.children)){let a=r(o.firstElementChild,s.children);if(a)return a}}return null}return r(t?.firstElementChild,n)}function Me(t,e){let n={},{componentId:i}=e;return g(t.body,r=>{r._id===i&&(n=r)}),n}function g(t,e){let n=0;function i(r,o){Array.isArray(r)?r.forEach(s=>i(s,o)):(o(r,n),n++,Array.isArray(r.children)&&i(r.children,o))}i(t,e)}function U(t,e=100){let n;return(...i)=>{clearTimeout(n),n=setTimeout(()=>{t.apply(this,i)},e)}}var me,pe,L,_,Q=c(()=>{B();z();Y();me="document-tree-element",pe="controls-element";L="editors";_=new Set;"Deno"in globalThis||(console.log("Hello from the page editor"),window.createEditor=J,window.metaChanged=Te,window.classChanged=U(_e),window.elementClicked=ve,window.elementChanged=we,window.contentChanged=U(V),window.getSelectedComponent=Me,window.updateFileSystem=be)});"Deno"in globalThis||Promise.resolve().then(()=>(O(),D)).then(t=>{t.registerListener(Se)});function Se(t){console.log("initializing editor");let e=!1,n=document.createElement("button");n.className=t("fixed right-4 bottom-4 whitespace-nowrap text-lg"),n.innerText="\u{1F433}\u{1F4A8}",n.onclick=async()=>{let i=await Promise.resolve().then(()=>(Q(),K));e?i.toggleEditorVisibility():(e=!0,i.createEditor())},document.body.appendChild(n)}
