var te=Object.defineProperty;var d=(e,n)=>()=>(e&&(n=e(e=0)),n);var S=(e,n)=>{for(var t in n)te(e,t,{get:n[t],enumerable:!0})};var O={};S(O,{registerListener:()=>re});function ne(){let e={mode:"silent",target:document.body};Promise.all([import("https://cdn.skypack.dev/twind@0.16.16/shim?min"),import("/twindSetup.js")]).then(([{setup:n},t])=>{console.log("loaded custom twind setup",t.default),n({...e,...t.default}),import("https://cdn.skypack.dev/twind@0.16.16?min").then(({tw:r})=>{j=r,A=!0,_.forEach(o=>o(r))})})}function re(e){console.log("registering a twind runtime listener"),A?e(j):_.push(e)}var A,j,_,k=d(()=>{A=!1,_=[];"Deno"in globalThis||ne()});function z({element:e,handle:n,xPosition:t},r){if(!e){console.warn("drag is missing elem!");return}D(e,"touchstart","touchmove","touchend",r,n,t),D(e,"mousedown","mousemove","mouseup",r,n,t)}function D(e,n,t,r,o,i,s){o=oe(o,s="left");let a=o.begin,l=o.change,u=o.end;L(i||e,n,f=>{let c=ee=>T(l,e,ee);function h(){I(document,t,c),I(document,r,h),T(u,e,f)}L(document,t,c),L(document,r,h),T(a,e,f)})}function L(e,n,t){let r=!1;try{let o=Object.defineProperty({},"passive",{get:function(){r=!0}});globalThis.addEventListener("testPassive",null,o),globalThis.removeEventListener("testPassive",null,o)}catch(o){console.error(o)}e.addEventListener(n,t,r?{passive:!1}:!1)}function I(e,n,t){e.removeEventListener(n,t,!1)}function oe(e,n="left"){if(e)return{begin:e.begin||E,change:e.change||E,end:e.end||E};let t,r;return{begin:function(o){let i=document.body.clientWidth;t={x:n==="left"?o.elem.offsetLeft:i-o.elem.offsetLeft-o.elem.clientWidth,y:o.elem.offsetTop},r=n==="left"?o.cursor:{x:i-o.cursor.x,y:o.cursor.y}},change:function(o){if(typeof t.x!="number"||typeof o.cursor.x!="number"||typeof r.x!="number")return;let i=document.body.clientWidth;N(o.elem,n,n==="left"?t.x+o.cursor.x-r.x+"px":t.x+(i-o.cursor.x)-r.x+"px"),!(typeof t.y!="number"||typeof o.cursor.y!="number"||typeof r.y!="number")&&N(o.elem,"top",t.y+o.cursor.y-r.y+"px")},end:E}}function N(e,n,t){e.style[n]=t}function E(){}function T(e,n,t){t.preventDefault();let r=ie(n),o=n.clientWidth,i=n.clientHeight,s={x:se(n,t),y:ae(n,t)};if(typeof s.x!="number"||typeof s.y!="number")return;let a=(s.x-r.x)/o,l=(s.y-r.y)/i;e({x:isNaN(a)?0:a,y:isNaN(l)?0:l,cursor:s,elem:n,e:t})}function ie(e){let n=e.getBoundingClientRect();return{x:n.left,y:n.top}}function se(e,n){return n instanceof TouchEvent?n.touches.item(0)?.clientX:n.clientX}function ae(e,n){return n instanceof TouchEvent?n.touches.item(0)?.clientY:n.clientY}var $=d(()=>{});function w(e){return typeof e>"u"}function m(e,n){if(!n)return;let t=e;return n.split(".").forEach(r=>{g(t)&&(t=t[r])}),t}var g,C=d(()=>{g=e=>!Array.isArray(e)&&typeof e=="object"});function p(e,n={},t=!0){try{return Promise.resolve(Function.apply(null,Object.keys(n).concat(`return ${e}`))(...Object.values(n)))}catch(r){t&&console.error("Failed to evaluate",e,n,r)}}var x=d(()=>{C()});async function b({component:e,components:n,extensions:t,context:r,props:o,utilities:i}){if(Array.isArray(e))return(await Promise.all(e.map(c=>b({component:c,components:n,extensions:t,context:r,props:o,utilities:i})))).join("");let s=e.element,a=s&&n?.[s],l=Object.fromEntries(await W(e.props||o,{context:r,props:o}));if(a)return(await Promise.all((Array.isArray(a)?a:[a]).map(c=>b({component:c,components:n,extensions:t,context:r,props:l,utilities:i})))).join("");if(t){for(let c of t)e=await c(e,{props:l,context:r,utilities:i});s=e.element}e.__element&&(s=m({context:r,props:l},e.__element)||s);let u=await le(e.attributes,typeof e.props!="string"?{props:l,context:r,utilities:i}:r);if(e.children){let c=e.children;return Array.isArray(c)&&(c=await b({component:c,props:l,components:n,extensions:t,context:r,utilities:i})),y(s,u,c)}if(e.__children)return y(s,u,m({context:r,props:l},e.__children));if(e["##children"])return y(s,u,await b({component:m({context:r,props:l},e["##children"]),components:n,extensions:t,context:r,utilities:i}));let f=e["==children"];return f?y(s,u,await p(f,{props:l,context:r,utilities:i})):s?typeof e.closingCharacter=="string"?`<${s}${u?" "+u:""} ${e.closingCharacter}>`:y(s,u):y()}function y(e,n,t=""){return e?`<${e}${n?" "+n:""}>${t}</${e}>`:t||""}async function le(e,n){return e?(await W(e,n)).map(([t,r])=>r&&r.length>0?`${t}="${r}"`:t).join(" "):""}async function W(e,n){return e?await Promise.all(Object.entries(e).map(async([t,r])=>{if(w(r))return[];let o=t,i=r;return t.startsWith("__")&&(o=t.split("__").slice(1).join("__"),i=m(n,r)),t.startsWith("==")&&typeof r=="string"&&(o=t.split("==").slice(1).join("=="),i=await p(r,n)),w(i)?[]:[o,i]})):Promise.resolve([])}var B,F=d(()=>{C();x();B=b});import{getStyleTag as _e,getStyleTagProperties as Oe,virtualSheet as ke}from"https://cdn.skypack.dev/twind@0.16.16/sheets?min";import{setup as Ie}from"https://cdn.skypack.dev/twind@0.16.16?min";import{tw as R}from"https://cdn.skypack.dev/twind@0.16.16?min";var V=d(()=>{});async function U(e,n){let t=[];if(typeof e.class=="string"&&t.push(e.class),typeof e.__class=="string"&&t.push(m(n,e.__class)),typeof e["==class"]=="string"&&t.push(await p(e["==class"],n)),g(e.classList)){let r=(await Promise.all(Object.entries(e.classList).map(async([o,i])=>await p(i,n)&&o))).filter(Boolean).join(" ");t.push(r)}return t.length?Promise.resolve({...e,attributes:{...e.attributes,class:t.map(r=>R(r)).join(" ")}}):Promise.resolve(e)}function q(e,n){if(!n||!e.foreach)return Promise.resolve(e);let[t,r]=e.foreach,o=m(n,t);return Array.isArray(o)?Promise.resolve({...e,children:o.flatMap(i=>Array.isArray(r)?r.map(s=>({...s,props:g(i)?i:{value:i}})):{...r,props:g(i)?i:{value:i}})}):Promise.resolve(e)}async function X(e,n){return typeof e.visibleIf!="string"?Promise.resolve(e):await p(e.visibleIf,n)?e:{}}var Y=d(()=>{V();C();x()});function J(){let e=document.querySelector('meta[name="pagepath"]');if(!e){console.error("path element was not found!");return}let n=e.getAttribute("content");if(!n){console.log("pagePath was not found in path element");return}return n}var G=d(()=>{});var Q={};S(Q,{createEditor:()=>K,toggleEditorVisibility:()=>pe});import{produce as M}from"https://cdn.skypack.dev/immer@9.0.6?min";async function K(){console.log("create editor");let[e,n,t,r]=await Promise.all([fetch("/components.json").then(s=>s.json()),fetch("./context.json").then(s=>s.json()),fetch("./layout.json").then(s=>s.json()),fetch("./route.json").then(s=>s.json())]),o=fe(t,r),i=await ye(e,n);o.append(i),document.body.appendChild(o),evaluateAllDirectives(),globalThis.onclick=({target:s})=>{let a=s,l=a.hasAttribute("data-id")?a:de(a,"data-id")[0];!l||(setState({selected:l.getAttribute("data-id")},{element:o.children[0],parent:"editor"}),l&&me(l,o))}}function de(e,n){let t=[],r=e.parentElement;for(;r;)r.hasAttribute(n)&&t.push(r),r=r.parentElement;return t}function me(e,n){let t,r=e.dataset.id;if(!r){console.log("target doesn't have a selection id");return}let o=i=>{let s=i.target;if(!s){console.warn("inputListener - No element found");return}i.preventDefault(),e.removeAttribute("contenteditable"),e.removeEventListener("focusout",o);let a=s.textContent;if(t===a){console.log("content didn't change");return}if(typeof a!="string")return;console.log("content changed",a);let l=n.children[0],{editor:{layout:u}}=getState(l),f=M(u,c=>{P(c,h=>{h?.attributes?.["data-id"]===r&&(h.children=a)})});setState({layout:f},{element:l,parent:"editor"})};v&&(v.classList.remove("border"),v.classList.remove("border-red-800")),v=e,e.classList.add("border"),e.classList.add("border-red-800"),e.children.length===0&&e.textContent&&(t=e.textContent,e.setAttribute("contenteditable","true"),e.addEventListener("focusout",o),e.focus())}function P(e,n){let t=0;function r(o,i){Array.isArray(o)?o.forEach(s=>r(s,i)):(i(o,t),t++,Array.isArray(o.children)&&r(o.children,i),o.props&&r(Object.values(o.props),i))}r(e,n)}function fe(e,n){let t=document.getElementById(H);return t?.remove(),t=document.createElement("div"),t.id=H,t.style.visibility="visible",t.setAttribute("x-state",JSON.stringify({layout:e,meta:n.meta,selected:void 0})),t.setAttribute("x-label","editor"),t}function pe(){let e=document.getElementById(H);!e||(e.style.visibility=e.style.visibility==="visible"?"hidden":"visible")}function ge(e){let n=M(e.body,r=>{P(r,o=>{delete o._id,o.class===""&&delete o.class})}),t={path:J(),data:{...e,body:n}};window.developmentSocket.send(JSON.stringify({type:"update",payload:t}))}async function ye(e,n){console.log("creating page editor");let t=document.createElement("div");t.id=ue,t.innerHTML=await B({component:e.PageEditor,components:e,context:n,extensions:[U,q,X]});let r=t.children[0],o=r.children[0];return z({element:r,handle:o}),t}function he(e,n){let{editor:{meta:t}}=getState(e),r=e.dataset.field;if(!r){console.error(`${r} was not found in ${e.dataset}`);return}if(r==="title"){let o=document.querySelector("title");o?o.innerHTML=n||"":console.warn("The page doesn't have a <title>!")}else{let o=document.head.querySelector("meta[name='"+r+"']");o?o.setAttribute("content",n):console.warn(`The page doesn't have a ${r} meta element!`)}setState({meta:{...t,[r]:n}},{element:e,parent:"editor"})}function be(e,n){let{editor:{body:t},selected:{componentId:r}}=getState(e),o=Ce(t,r,(i,s)=>{s?.replaceWith(Ee(s,n)),i.element=n});setState({body:o},{element:e,parent:"editor"})}function Ee(e,n){let t=document.createElement(n),r=e.cloneNode(!0);for(;r.firstChild;)t.appendChild(r.firstChild);for(let o of r.attributes)t.setAttribute(o.name,o.value);return t}function Ce(e,n,t){return M(e,r=>{P(r,(o,i)=>{o._id===n&&t(o,ve(document.body,i,e))})})}function ve(e,n,t){let r=0;function o(i,s){if(!i)return null;if(Array.isArray(s)){let a=i;for(let l of s){let u=o(a,l);if(u)return u;a=a?.nextElementSibling}}else{if(n===r)return i;if(r++,Array.isArray(s.children)){let a=o(i.firstElementChild,s.children);if(a)return a}}return null}return o(e?.firstElementChild,t)}var ue,v,H,Z=d(()=>{$();F();Y();G();ue="document-tree-element";H="editors";"Deno"in globalThis||(console.log("Hello from the page editor"),window.createEditor=K,window.metaChanged=he,window.elementChanged=be,window.updateFileSystem=ge)});"Deno"in globalThis||Promise.resolve().then(()=>(k(),O)).then(e=>{e.registerListener(Le)});function Le(e){console.log("initializing editor");let n=!1,t=document.createElement("button");t.className=e("fixed right-4 bottom-4 whitespace-nowrap text-lg"),t.innerText="\u{1F433}\u{1F4A8}",t.onclick=async()=>{let r=await Promise.resolve().then(()=>(Z(),Q));n?r.toggleEditorVisibility():(n=!0,r.createEditor())},document.body.appendChild(t)}
