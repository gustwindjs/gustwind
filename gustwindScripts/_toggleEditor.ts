var x=Object.defineProperty;var te=t=>x(t,"__esModule",{value:!0});var l=(t,e)=>()=>(t&&(e=t(t=0)),e);var M=(t,e)=>{te(t);for(var n in e)x(t,n,{get:e[n],enumerable:!0})};var H,_=l(()=>{H=t=>({mode:"silent"})});var D={};M(D,{registerListener:()=>re});import{setup as k}from"https://cdn.skypack.dev/twind@0.16.16/shim?min";function ne(){let t=H("development");k({target:document.body,...t}),import("/twindSetup.js").then(e=>{console.log("loaded custom twind setup",e.default),k({target:document.body,...e.default}),A=!0,j.forEach(n=>n())})}function re(t){console.log("registering a twind runtime listener"),A?t():j.push(t)}var A,j,O=l(()=>{_();A=!1,j=[];"Deno"in globalThis||ne()});function p({element:t,handle:e,xPosition:n},i){if(!t){console.warn("drag is missing elem!");return}$(t,"touchstart","touchmove","touchend",i,e,n),$(t,"mousedown","mousemove","mouseup",i,e,n)}function $(t,e,n,i,r,s,o){r=ie(r,o="left");let a=r.begin,d=r.change,c=r.end;h(s||t,e,L=>{let P=ee=>y(d,t,ee);function S(){W(document,n,P),W(document,i,S),y(c,t,L)}h(document,n,P),h(document,i,S),y(a,t,L)})}function h(t,e,n){let i=!1;try{let r=Object.defineProperty({},"passive",{get:function(){i=!0}});globalThis.addEventListener("testPassive",null,r),globalThis.removeEventListener("testPassive",null,r)}catch(r){console.error(r)}t.addEventListener(e,n,i?{passive:!1}:!1)}function W(t,e,n){t.removeEventListener(e,n,!1)}function ie(t,e="left"){if(t)return{begin:t.begin||f,change:t.change||f,end:t.end||f};let n,i;return{begin:function(r){let s=document.body.clientWidth;n={x:e==="left"?r.elem.offsetLeft:s-r.elem.offsetLeft-r.elem.clientWidth,y:r.elem.offsetTop},i=e==="left"?r.cursor:{x:s-r.cursor.x,y:r.cursor.y}},change:function(r){if(typeof n.x!="number"||typeof r.cursor.x!="number"||typeof i.x!="number")return;let s=document.body.clientWidth;I(r.elem,e,e==="left"?n.x+r.cursor.x-i.x+"px":n.x+(s-r.cursor.x)-i.x+"px"),!(typeof n.y!="number"||typeof r.cursor.y!="number"||typeof i.y!="number")&&I(r.elem,"top",n.y+r.cursor.y-i.y+"px")},end:f}}function I(t,e,n){t.style[e]=n}function f(){}function y(t,e,n){n.preventDefault();let i=oe(e),r=e.clientWidth,s=e.clientHeight,o={x:se(e,n),y:ae(e,n)};if(typeof o.x!="number"||typeof o.y!="number")return;let a=(o.x-i.x)/r,d=(o.y-i.y)/s;t({x:isNaN(a)?0:a,y:isNaN(d)?0:d,cursor:o,elem:e,e:n})}function oe(t){let e=t.getBoundingClientRect();return{x:e.left,y:e.top}}function se(t,e){return e instanceof TouchEvent?e.touches.item(0)?.clientX:e.clientX}function ae(t,e){return e instanceof TouchEvent?e.touches.item(0)?.clientY:e.clientY}var N=l(()=>{});function g(t,e){let n=t;return e.split(".").forEach(i=>{b(n)&&(n=n[i])}),n}var b,F=l(()=>{b=t=>typeof t=="object"});async function E(t,e,n){if(!e)return Promise.resolve({content:n});if("Deno"in globalThis){let i=await import("https://deno.land/std@0.107.0/path/mod.ts");return(await Promise.all(e.map(s=>{let o=i.join(t,`${s}.ts`);return Deno.env.get("DEBUG")==="1"&&console.log("importing transform",o,t,s),import("file://"+o)}))).reduce((s,o)=>o.default(s),n)}return Promise.all(e.map(i=>import(`/transforms/${i}.js`)))}var R=l(()=>{});import{tw as B}from"https://cdn.skypack.dev/twind@0.16.16?min";async function u(t,e,n,i){if(typeof e=="string")return e;let r=e.element&&n[e.element];if(e.__bind&&(b(e.__bind)?i={...i,__bound:e.__bind}:i={...i,__bound:g(i,e.__bind)}),r)return await u(t,{element:"",children:Array.isArray(r)?r:[{...e,...r,class:de(e.class,r.class)}]},n,i);if(e?.transformWith){let o;if(typeof e.inputText=="string")o=await E(t,e?.transformWith,e.inputText);else if(typeof e.inputProperty=="string"){let a=g(i,e.inputProperty);if(!a)throw console.error("Missing input",i,e.inputProperty),new Error("Missing input");o=await E(t,e?.transformWith,a)}i={...i,...o}}let s;if(e.__children){let o=e.__children,a=i.__bound||i;typeof o=="string"?s=g(a,o):s=(await Promise.all((Array.isArray(a)?a:[a]).flatMap(d=>o.map(c=>u(t,c,n,{...i,__bound:d}))))).join("")}else s=Array.isArray(e.children)?(await Promise.all(e.children.map(async o=>await u(t,o,n,i)))).join(""):e.children;return ce(e.element,ue({...e.attributes,class:le(e,i)},i),s)}function le(t,e){let n=[];return t.__class&&Object.entries(t.__class).forEach(([i,r])=>{q(r,{attributes:t.attributes,context:e})&&n.push(B(i))}),t.class?B(n.concat(t.class.split(" ")).join(" ")):n.join(" ")}function de(t,e){return t?e?`${t} ${e}`:t:e||""}function ce(t,e,n){return t?`<${t}${e}>${n||""}</${t}>`:typeof n=="string"?n:""}function ue(t,e){let n=Object.entries(t).map(([i,r])=>i.startsWith("__")?`${i.slice(2)}="${q(r,e.__bound)}"`:`${i}="${r}"`).filter(Boolean).join(" ");return n.length>0?" "+n:""}function q(t,e={}){try{return Function.apply(null,Object.keys(e).concat(`return ${t}`))(...Object.values(e))}catch(n){console.error("Failed to evaluate",t,e,n)}}var X=l(()=>{F();R()});function Y(){let t=document.querySelector('meta[name="pagepath"]');if(!t){console.error("path element was not found!");return}let e=t.getAttribute("content");if(!e){console.log("pagePath was not found in path element");return}return e}var z=l(()=>{});function m(t,e){let n=0;function i(r,s){Array.isArray(r)?r.forEach(o=>i(o,s)):(s(r,n),n++,Array.isArray(r.children)&&i(r.children,s))}i(t,e)}var J=l(()=>{});var Q={};M(Q,{createEditor:()=>V,toggleEditorVisibility:()=>he});import{produce as C}from"https://cdn.skypack.dev/immer@9.0.6?min";import{nanoid as me}from"https://cdn.skypack.dev/nanoid@3.1.30?min";async function V(){console.log("create editor");let[t,e,n]=await Promise.all([fetch("/components.json").then(a=>a.json()),fetch("./context.json").then(a=>a.json()),fetch("./definition.json").then(a=>a.json())]),i=pe(n),r=document.createElement("div");r.setAttribute("x-label","selected"),r.setAttribute("x-state","{ componentId: undefined }"),i.appendChild(r);let s=await Ee(t,e);r.append(s);let o=await Ce(t,e);r.append(o),document.body.appendChild(i),evaluateAllDirectives()}function pe(t){let e=document.getElementById(T);return e?.remove(),e=document.createElement("div"),e.id=T,e.style.visibility="visible",e.setAttribute("x-state",JSON.stringify({...t,page:ye(t.page)})),e.setAttribute("x-label","editor"),e}function he(){let t=document.getElementById(T);!t||(t.style.visibility=t.style.visibility==="visible"?"hidden":"visible")}function ye(t){return C(t,e=>{m(e,n=>{n._id=me()})})}function be(t){let e=C(t.page,i=>{m(i,r=>{delete r._id,r.class===""&&delete r.class})}),n={path:Y(),data:{...t,page:e}};window.developmentSocket.send(JSON.stringify({type:"update",payload:n}))}async function Ee(t,e){console.log("Creating page editor");let n=document.createElement("div");n.id=fe,n.innerHTML=await u("",t.PageEditor,t,e);let i=n.children[0],r=i.children[0];return p({element:i,handle:r}),n}async function Ce(t,e){let n=document.createElement("div");n.id=ge,n.innerHTML=await u("",t.ComponentEditor,t,e);let i=n.children[0],r=i.children[0];return p({element:i,handle:r,xPosition:"right"}),n}function Te(t,e){let{editor:{meta:n}}=getState(t),i=t.dataset.field;if(i==="title"){let r=document.querySelector("title");r?r.innerHTML=e||"":console.warn("The page doesn't have a <title>!")}else{let r=document.head.querySelector("meta[name='"+i+"']");r?r.setAttribute("content",e):console.warn(`The page doesn't have a ${i} meta element!`)}setState({meta:{...n,[i]:e}},{element:t,parent:"editor"})}function ve(t,e){event?.stopPropagation();let{editor:{page:n}}=getState(t),i=r=>{let s=r.target;if(!s){console.warn("inputListener - No element found");return}r.preventDefault(),G(t,s.textContent)};for(let r of v.values())r.classList.remove("border"),r.classList.remove("border-red-800"),r.removeAttribute("contenteditable"),r.removeEventListener("focusout",i),v.delete(r);m(n,(r,s)=>{if(r._id===e){let o=U(document.body,s,n);o.classList.add("border"),o.classList.add("border-red-800"),o.setAttribute("contenteditable","true"),o.addEventListener("focusout",i),v.add(o)}}),setState({componentId:e},{element:t,parent:"selected"})}function we(t,e){let{editor:{page:n},selected:{componentId:i}}=getState(t),r=w(n,i,(s,o)=>{o?.replaceWith(Le(o,e)),s.element=e});setState({page:r},{element:t,parent:"editor"})}function Le(t,e){let n=document.createElement(e),i=t.cloneNode(!0);for(;i.firstChild;)n.appendChild(i.firstChild);for(let r of i.attributes)n.setAttribute(r.name,r.value);return n}function G(t,e){let{editor:{page:n},selected:{componentId:i}}=getState(t),r=w(n,i,(s,o)=>{o&&(o.innerHTML=e),s.children=e});setState({page:r},{element:t,parent:"editor"})}function Pe(t,e){let{editor:{page:n},selected:{componentId:i}}=getState(t),r=w(n,i,(s,o)=>{o&&(o.setAttribute("class",e),o.classList.add("border"),o.classList.add("border-red-800")),s.class=e});setState({page:r},{element:t,parent:"editor"})}function w(t,e,n){return C(t,i=>{m(i,(r,s)=>{r._id===e&&n(r,U(document.body,s,t))})})}function U(t,e,n){let i=0;function r(s,o){if(!s)return null;if(Array.isArray(o)){let a=s;for(let d of o){let c=r(a,d);if(c)return c;a=a?.nextElementSibling}}else{if(e===i)return s;if(i++,Array.isArray(o.children)){let a=r(s.firstElementChild,o.children);if(a)return a}}return null}return r(t?.firstElementChild,n)}function Se(t,e){let n={},{componentId:i}=e;return m(t.page,r=>{r._id===i&&(n=r)}),n}function K(t,e=100){let n;return(...i)=>{clearTimeout(n),n=setTimeout(()=>{t.apply(this,i)},e)}}var fe,ge,T,v,Z=l(()=>{N();X();z();J();fe="document-tree-element",ge="controls-element";T="editors";v=new Set;"Deno"in globalThis||(console.log("Hello from the page editor"),window.createEditor=V,window.metaChanged=Te,window.classChanged=K(Pe),window.elementClicked=ve,window.elementChanged=we,window.contentChanged=K(G),window.getSelectedComponent=Se,window.updateFileSystem=be)});import{tw as xe}from"https://cdn.skypack.dev/twind@0.16.16?min";"Deno"in globalThis||Promise.resolve().then(()=>(O(),D)).then(t=>{t.registerListener(Me)});function Me(){console.log("initializing editor");let t=!1,e=document.createElement("button");e.className=xe("fixed right-4 bottom-4 whitespace-nowrap text-lg"),e.innerText="\u{1F433}\u{1F4A8}",e.onclick=async()=>{let n=await Promise.resolve().then(()=>(Z(),Q));t?n.toggleEditorVisibility():(t=!0,n.createEditor())},document.body.appendChild(e)}
