var X=Object.defineProperty;var d=(e,r)=>()=>(e&&(r=e(e=0)),r);var I=(e,r)=>{for(var t in r)X(e,t,{get:r[t],enumerable:!0})};var D={};I(D,{registerListener:()=>Z});function Y(){let e={mode:"silent",target:document.body};Promise.all([import("https://cdn.skypack.dev/twind@0.16.16/shim?min"),import("/twindSetup.js")]).then(([{setup:r},t])=>{console.log("loaded custom twind setup",t.default),r({...e,...t.default}),import("https://cdn.skypack.dev/twind@0.16.16?min").then(({tw:n})=>{$=n,O=!0,z.forEach(o=>o(n))})})}function Z(e){console.log("registering a twind runtime listener"),O?e($):z.push(e)}var O,$,z,R=d(()=>{O=!1,z=[];"Deno"in globalThis||Y()});function N(e,r){let t=[],n=e.parentElement;for(;n;)n.hasAttribute(r)&&t.push(n),n=n.parentElement;return t}var V=d(()=>{});function F(e,r){let t=document.createElement(r),n=e.cloneNode(!0);for(;n.firstChild;)t.appendChild(n.firstChild);for(let o of n.attributes)t.setAttribute(o.name,o.value);return t}var B=d(()=>{});function C(e,r){let t=0;function n(o,i){Array.isArray(o)?o.forEach(s=>n(s,i)):(i(o,t),t++,Array.isArray(o.children)&&n(o.children,i),o.props&&n(Object.values(o.props),i))}n(e,r)}var W=d(()=>{});function w(e){return typeof e>"u"}function m(e,r){if(!r)return;let t=e;return r.split(".").forEach(n=>{p(t)&&(t=t[n])}),t}var p,E=d(()=>{p=e=>!Array.isArray(e)&&typeof e=="object"});function f(e,r={},t=!0){try{return Promise.resolve(Function.apply(null,Object.keys(r).concat(`return ${e}`))(...Object.values(r)))}catch(n){t&&console.error("Failed to evaluate",e,r,n)}}var L=d(()=>{E()});async function y({component:e,components:r,extensions:t,context:n,props:o,utilities:i}){if(Array.isArray(e))return(await Promise.all(e.map(c=>y({component:c,components:r,extensions:t,context:n,props:o,utilities:i})))).join("");let s=e.element,l=s&&r?.[s],a=Object.fromEntries(await U(e.props||o,{context:n,props:o}));if(l)return(await Promise.all((Array.isArray(l)?l:[l]).map(c=>y({component:c,components:r,extensions:t,context:n,props:a,utilities:i})))).join("");if(t){for(let c of t)e=await c(e,{props:a,context:n,utilities:i});s=e.element}e.__element&&(s=m({context:n,props:a},e.__element)||s),e["==element"]&&(s=await f(e["==element"],{props:a,context:n,utilities:i}));let u=await ee(e.attributes,typeof e.props!="string"?{props:a,context:n,utilities:i}:n);if(e.children){let c=e.children;return Array.isArray(c)&&(c=await y({component:c,props:a,components:r,extensions:t,context:n,utilities:i})),g(s,u,c)}if(e.__children)return g(s,u,m({context:n,props:a},e.__children));if(e["##children"])return g(s,u,await y({component:m({context:n,props:a},e["##children"]),components:r,extensions:t,context:n,utilities:i}));let h=e["==children"];return h?g(s,u,await f(h,{props:a,context:n,utilities:i})):s?typeof e.closingCharacter=="string"?`<${s}${u?" "+u:""} ${e.closingCharacter}>`:g(s,u):""}function g(e,r,t=""){return e?`<${e}${r?" "+r:""}>${t}</${e}>`:t||""}async function ee(e,r){return e?(await U(e,r)).map(([t,n])=>n&&n.length>0?`${t}="${n}"`:t).join(" "):""}async function U(e,r){return e?await Promise.all(Object.entries(e).map(async([t,n])=>{if(w(n))return[];let o=t,i=n;return t.startsWith("__")&&(o=t.split("__").slice(1).join("__"),i=m(r,n)),t.startsWith("==")&&typeof n=="string"&&(o=t.split("==").slice(1).join("=="),i=await f(n,r)),w(i)?[]:[o,i]})):Promise.resolve([])}var T,q=d(()=>{E();L();T=y});import{getStyleTag as Ae,getStyleTagProperties as Pe,virtualSheet as je}from"https://cdn.skypack.dev/twind@0.16.16/sheets?min";import{draggable as S}from"https://cdn.skypack.dev/dragjs@v0.13.3?min";import{produce as v}from"https://cdn.skypack.dev/immer@9.0.6?min";import{setup as Ie}from"https://cdn.skypack.dev/twind@0.16.16?min";import{tw as k}from"https://cdn.skypack.dev/twind@0.16.16?min";var x=d(()=>{});async function A(e,r){let t=[];if(typeof e.class=="string"&&t.push(e.class),typeof e.__class=="string"&&t.push(m(r,e.__class)),typeof e["==class"]=="string"&&t.push(await f(e["==class"],r)),p(e.classList)){let n=(await Promise.all(Object.entries(e.classList).map(async([o,i])=>await f(i,r)&&o))).filter(Boolean).join(" ");t.push(n)}return t.length?Promise.resolve({...e,attributes:{...e.attributes,class:t.map(n=>k(n)).join(" ")}}):Promise.resolve(e)}function P(e,r){if(!r||!e.foreach)return Promise.resolve(e);let[t,n]=e.foreach,o=m(r,t);return Array.isArray(o)?Promise.resolve({...e,children:o.flatMap(i=>Array.isArray(n)?n.map(s=>({...s,props:p(i)?i:{value:i}})):{...n,props:p(i)?i:{value:i}})}):Promise.resolve(e)}async function j(e,r){return typeof e.visibleIf!="string"?Promise.resolve(e):await f(e.visibleIf,r)?e:{}}var J=d(()=>{x();E();L()});var K={};I(K,{createEditor:()=>G,toggleEditorVisibility:()=>ae});async function G(){console.log("create editor");let[e,r,t,n]=await Promise.all([fetch("/components.json").then(a=>a.json()),fetch("./context.json").then(a=>a.json()),fetch("./layout.json").then(a=>a.json()),fetch("./route.json").then(a=>a.json())]),o=se(t,n),i=await le(e,r);o.append(i);let s=await ce(e,r);o.append(s),document.body.appendChild(o),evaluateAllDirectives();let l=oe(o);globalThis.onclick=({target:a})=>l(a),globalThis.ontouchstart=({target:a})=>l(a)}function oe(e){return function(t){if(!t)return;let n=t,o=n.hasAttribute("data-id")?n:N(n,"data-id")[0];if(!o)return;let i=o.getAttribute("data-id"),{editor:{layout:s}}=getState(e);setState({selectionId:i},{element:e,parent:"editor"}),o&&ie(e,o,s)}}function ie(e,r,t){let n,o=r.dataset.id;if(!o){console.log("target doesn't have a selection id");return}let i=s=>{let l=s.target;if(!l){console.warn("inputListener - No element found");return}s.preventDefault(),r.removeAttribute("contenteditable"),r.removeEventListener("focusout",i);let a=l.textContent;if(n===a){console.log("content didn't change");return}if(typeof a!="string")return;console.log("content changed",a);let u=v(t,c=>{C(c,_=>{_?.attributes?.["data-id"]===o&&(_.children=a)})}),h=e.children[0];setState({layout:u},{element:h,parent:"editor"})};b&&(b.classList.remove("border"),b.classList.remove("border-red-800")),b=r,r.classList.add("border"),r.classList.add("border-red-800"),r.children.length===0&&r.textContent&&(n=r.textContent,r.setAttribute("contenteditable","true"),r.addEventListener("focusout",i),r.focus())}function se(e,r){let t=document.getElementById(H),n={layout:e,meta:r.meta,selectionId:void 0};return t?.remove(),t=document.createElement("div"),t.id=H,t.style.visibility="visible",t.setAttribute("x-state",JSON.stringify(n)),t.setAttribute("x-label","editor"),t}function ae(){let e=document.getElementById(H);!e||(e.style.visibility=e.style.visibility==="visible"?"hidden":"visible")}async function le(e,r){console.log("creating page editor");let t=document.createElement("div");t.id=ne,t.innerHTML=await T({component:e.PageEditor,components:e,context:r,extensions:[A,P,j]});let n=t.children[0],o=n.children[0];return S({element:n,handle:o}),t}async function ce(e,r){let t=document.createElement("div");t.id=re,t.innerHTML=await T({component:e.ComponentEditor,components:e,context:r,extensions:[A,P,j]});let n=t.children[0],o=n.children[0];return S({element:n,handle:o,xPosition:"right"}),t}function de(e,r){let{editor:{meta:t}}=getState(e),n=e.dataset.field;if(!n){console.error(`${n} was not found in ${e.dataset}`);return}if(n==="title"){let o=document.querySelector("title");o?o.innerHTML=r||"":console.warn("The page doesn't have a <title>!")}else{let o=document.head.querySelector("meta[name='"+n+"']");o?o.setAttribute("content",r):console.warn(`The page doesn't have a ${n} meta element!`)}setState({meta:{...t,[n]:r}},{element:e,parent:"editor"})}function ue(e,r){let{editor:{layout:t,selectionId:n}}=getState(e),o=M(t,n,(i,s)=>{s.forEach(l=>{l.innerHTML=r}),i.children=r});setState({layout:o},{element:e,parent:"editor"})}function me(e,r){let{editor:{layout:t,selectionId:n}}=getState(e),o=M(t,n,(i,s)=>{Array.isArray(i)||(s.forEach(l=>l.setAttribute("class",r)),i.class=r)});setState({layout:o},{element:e,parent:"editor"})}function fe(e,r){let{editor:{layout:t,selectionId:n}}=getState(e),o=M(t,n,(i,s)=>{Array.isArray(i)||(s.forEach(l=>l.replaceWith(F(l,r))),i.element=r)});setState({layout:o},{element:e,parent:"editor"})}function M(e,r,t){return v(e,n=>{C(n,o=>{o?.attributes?.["data-id"]===r&&t(o,Array.from(document.querySelectorAll(`*[data-id="${r}"]`)))})})}function pe(e){let{layout:r,selectionId:t}=e;if(!t)return{};let n;return C(r,o=>{o?.attributes?.["data-id"]===t&&(n=o)}),n}var ne,re,b,H,Q=d(()=>{V();B();W();q();J();x();ne="document-tree-element",re="controls-element";H="editors";"Deno"in globalThis||(console.log("Hello from the page editor"),window.createEditor=G,window.classChanged=me,window.contentChanged=ue,window.getSelectedComponent=pe,window.metaChanged=de,window.elementChanged=fe)});"Deno"in globalThis||Promise.resolve().then(()=>(R(),D)).then(e=>{e.registerListener(ge)});function ge(e){console.log("initializing editor");let r=!1,t=document.createElement("button");t.className=e("fixed right-4 bottom-4 whitespace-nowrap text-lg"),t.innerText="\u{1F433}\u{1F4A8}",t.onclick=async()=>{let n=await Promise.resolve().then(()=>(Q(),K));r?n.toggleEditorVisibility():(r=!0,n.createEditor())},document.body.appendChild(t)}
