var Q=Object.defineProperty;var u=(e,r)=>()=>(e&&(r=e(e=0)),r);var I=(e,r)=>{for(var t in r)Q(e,t,{get:r[t],enumerable:!0})};var z={};I(z,{registerListener:()=>Y});function X(){let e={mode:"silent",target:document.body};Promise.all([import("https://cdn.skypack.dev/twind@0.16.16/shim?min"),import("/twindSetup.js")]).then(([{setup:r},t])=>{console.log("loaded custom twind setup",t.default),r({...e,...t.default}),import("https://cdn.skypack.dev/twind@0.16.16?min").then(({tw:n})=>{O=n,_=!0,$.forEach(i=>i(n))})})}function Y(e){console.log("registering a twind runtime listener"),_?e(O):$.push(e)}var _,O,$,D=u(()=>{_=!1,$=[];"Deno"in globalThis||X()});function R(e,r){let t=[],n=e.parentElement;for(;n;)n.hasAttribute(r)&&t.push(n),n=n.parentElement;return t}var N=u(()=>{});function V(e,r){let t=document.createElement(r),n=e.cloneNode(!0);for(;n.firstChild;)t.appendChild(n.firstChild);for(let i of n.attributes)t.setAttribute(i.name,i.value);return t}var F=u(()=>{});function h(e,r){let t=0;function n(i,o){Array.isArray(i)?i.forEach(s=>n(s,o)):(o(i,t),t++,Array.isArray(i.children)&&n(i.children,o),i.props&&n(Object.values(i.props),o))}n(e,r)}var B=u(()=>{});function b(e){return typeof e>"u"}function m(e,r){if(!r)return;let t=e;return r.split(".").forEach(n=>{p(t)&&(t=t[n])}),t}var p,E=u(()=>{p=e=>!Array.isArray(e)&&typeof e=="object"});function f(e,r={},t=!0){try{return Promise.resolve(Function.apply(null,Object.keys(r).concat(`return ${e}`))(...Object.values(r)))}catch(n){t&&console.error("Failed to evaluate",e,r,n)}}var w=u(()=>{E()});async function y({component:e,components:r,extensions:t,context:n,props:i,utilities:o}){if(Array.isArray(e))return(await Promise.all(e.map(d=>y({component:d,components:r,extensions:t,context:n,props:i,utilities:o})))).join("");let s=e.element,l=s&&r?.[s],a=Object.fromEntries(await W(e.props||i,{context:n,props:i}));if(l)return(await Promise.all((Array.isArray(l)?l:[l]).map(d=>y({component:d,components:r,extensions:t,context:n,props:a,utilities:o})))).join("");if(t){for(let d of t)e=await d(e,{props:a,context:n,utilities:o});s=e.element}e.__element&&(s=m({context:n,props:a},e.__element)||s),e["==element"]&&(s=await f(e["==element"],{props:a,context:n,utilities:o}));let c=await Z(e.attributes,typeof e.props!="string"?{props:a,context:n,utilities:o}:n);if(e.children){let d=e.children;return Array.isArray(d)&&(d=await y({component:d,props:a,components:r,extensions:t,context:n,utilities:o})),g(s,c,d)}if(e.__children)return g(s,c,m({context:n,props:a},e.__children));if(e["##children"])return g(s,c,await y({component:m({context:n,props:a},e["##children"]),components:r,extensions:t,context:n,utilities:o}));let M=e["==children"];return M?g(s,c,await f(M,{props:a,context:n,utilities:o})):s?typeof e.closingCharacter=="string"?`<${s}${c?" "+c:""} ${e.closingCharacter}>`:g(s,c):""}function g(e,r,t=""){return e?`<${e}${r?" "+r:""}>${t}</${e}>`:t||""}async function Z(e,r){return e?(await W(e,r)).map(([t,n])=>n&&n.length>0?`${t}="${n}"`:t).join(" "):""}async function W(e,r){return e?await Promise.all(Object.entries(e).map(async([t,n])=>{if(b(n))return[];let i=t,o=n;return t.startsWith("__")&&(i=t.split("__").slice(1).join("__"),o=m(r,n)),t.startsWith("==")&&typeof n=="string"&&(i=t.split("==").slice(1).join("=="),o=await f(n,r)),b(o)?[]:[i,o]})):Promise.resolve([])}var L,U=u(()=>{E();w();L=y});import{getStyleTag as Ae,getStyleTagProperties as Pe,virtualSheet as je}from"https://cdn.skypack.dev/twind@0.16.16/sheets?min";import{draggable as T}from"https://cdn.skypack.dev/dragjs@v0.13.3?min";import{produce as v}from"https://cdn.skypack.dev/immer@9.0.6?min";import{setup as _e}from"https://cdn.skypack.dev/twind@0.16.16?min";import{tw as q}from"https://cdn.skypack.dev/twind@0.16.16?min";var S=u(()=>{});async function x(e,r){let t=[];if(typeof e.class=="string"&&t.push(e.class),typeof e.__class=="string"&&t.push(m(r,e.__class)),typeof e["==class"]=="string"&&t.push(await f(e["==class"],r)),p(e.classList)){let n=(await Promise.all(Object.entries(e.classList).map(async([i,o])=>await f(o,r)&&i))).filter(Boolean).join(" ");t.push(n)}return t.length?Promise.resolve({...e,attributes:{...e.attributes,class:t.map(n=>q(n)).join(" ")}}):Promise.resolve(e)}function A(e,r){if(!r||!e.foreach)return Promise.resolve(e);let[t,n]=e.foreach,i=m(r,t);return Array.isArray(i)?Promise.resolve({...e,children:i.flatMap(o=>Array.isArray(n)?n.map(s=>({...s,props:p(o)?o:{value:o}})):{...n,props:p(o)?o:{value:o}})}):Promise.resolve(e)}async function P(e,r){return typeof e.visibleIf!="string"?Promise.resolve(e):await f(e.visibleIf,r)?e:{}}var k=u(()=>{S();E();w()});var G={};I(G,{createEditor:()=>J,toggleEditorVisibility:()=>ae});async function J(){console.log("create editor");let[e,r,t,n]=await Promise.all([fetch("/components.json").then(a=>a.json()),fetch("./context.json").then(a=>a.json()),fetch("./layout.json").then(a=>a.json()),fetch("./route.json").then(a=>a.json())]),i=se(t,n),o=await le(e,r);i.append(o);let s=await ce(e,r);i.append(s),document.body.appendChild(i),evaluateAllDirectives();let l=re(i);globalThis.onclick=({target:a})=>l(a),globalThis.ontouchstart=({target:a})=>l(a)}function re(e){return function(t){if(!t)return;let n=t,i=n.hasAttribute("data-id")?n:R(n,"data-id")[0];if(!i)return;let o=i.getAttribute("data-id"),{editor:{layout:s}}=getState(e);setState({selectionId:o},{element:e,parent:"editor"}),i&&ie(e,i,s)}}function ie(e,r,t){let n,i=r.dataset.id;if(!i){console.log("target doesn't have a selection id");return}let o=l=>{!l||!l.target||oe(e,t,i,l.target,n)},s=l=>{if(!l.target){console.warn("inputListener - No element found");return}l.preventDefault(),r.removeAttribute("contenteditable"),r.removeEventListener("input",o),r.removeEventListener("focusout",s)};C&&(C.classList.remove("border"),C.classList.remove("border-red-800")),C=r,r.classList.add("border"),r.classList.add("border-red-800"),r.children.length===0&&r.textContent&&(n=r.textContent,r.setAttribute("contenteditable","true"),r.addEventListener("focusout",s),r.addEventListener("input",o),r.focus())}function oe(e,r,t,n,i){let o=n.textContent;if(i===o){console.log("content didn't change");return}if(typeof o!="string")return;console.log("content changed",o);let s=v(r,a=>{h(a,c=>{c?.attributes?.["data-id"]===t&&(c.children=o)})}),l=e.children[0];setState({layout:s},{element:l,parent:"editor"})}function se(e,r){let t=document.getElementById(j),n={layout:e,meta:r.meta,selectionId:void 0};return t?.remove(),t=document.createElement("div"),t.id=j,t.style.visibility="visible",t.setAttribute("x-state",JSON.stringify(n)),t.setAttribute("x-label","editor"),t}function ae(){let e=document.getElementById(j);!e||(e.style.visibility=e.style.visibility==="visible"?"hidden":"visible")}async function le(e,r){console.log("creating page editor");let t=document.createElement("div");t.id=te,t.innerHTML=await L({component:e.PageEditor,components:e,context:r,extensions:[x,A,P]});let n=t.children[0],i=n.children[0];return T({element:n,handle:i}),t}async function ce(e,r){let t=document.createElement("div");t.id=ne,t.innerHTML=await L({component:e.ComponentEditor,components:e,context:r,extensions:[x,A,P]});let n=t.children[0],i=n.children[0];return T({element:n,handle:i,xPosition:"right"}),t}function de(e,r){let{editor:{meta:t}}=getState(e),n=e.dataset.field;if(!n){console.error(`${n} was not found in ${e.dataset}`);return}if(n==="title"){let i=document.querySelector("title");i?i.innerHTML=r||"":console.warn("The page doesn't have a <title>!")}else{let i=document.head.querySelector("meta[name='"+n+"']");i?i.setAttribute("content",r):console.warn(`The page doesn't have a ${n} meta element!`)}setState({meta:{...t,[n]:r}},{element:e,parent:"editor"})}function ue(e,r){let{editor:{layout:t,selectionId:n}}=getState(e),i=H(t,n,(o,s)=>{s.forEach(l=>{l.innerHTML=r}),o.children=r});setState({layout:i},{element:e,parent:"editor"})}function me(e,r){let{editor:{layout:t,selectionId:n}}=getState(e),i=H(t,n,(o,s)=>{Array.isArray(o)||(s.forEach(l=>l.setAttribute("class",r)),o.class=r)});setState({layout:i},{element:e,parent:"editor"})}function fe(e,r){let{editor:{layout:t,selectionId:n}}=getState(e),i=H(t,n,(o,s)=>{Array.isArray(o)||(s.forEach(l=>l.replaceWith(V(l,r))),o.element=r)});setState({layout:i},{element:e,parent:"editor"})}function H(e,r,t){return v(e,n=>{h(n,i=>{i?.attributes?.["data-id"]===r&&t(i,Array.from(document.querySelectorAll(`*[data-id="${r}"]`)))})})}function pe(e){let{layout:r,selectionId:t}=e;if(!t)return{};let n;return h(r,i=>{i?.attributes?.["data-id"]===t&&(n=i)}),n}var te,ne,C,j,K=u(()=>{N();F();B();U();k();S();te="document-tree-element",ne="controls-element";j="editors";"Deno"in globalThis||(console.log("Hello from the page editor"),window.createEditor=J,window.classChanged=me,window.contentChanged=ue,window.getSelectedComponent=pe,window.metaChanged=de,window.elementChanged=fe)});"Deno"in globalThis||Promise.resolve().then(()=>(D(),z)).then(e=>{e.registerListener(ge)});function ge(e){console.log("initializing editor");let r=!1,t=document.createElement("button");t.className=e("fixed right-4 bottom-4 whitespace-nowrap text-lg"),t.innerText="\u{1F433}\u{1F4A8}",t.onclick=async()=>{let n=await Promise.resolve().then(()=>(K(),G));r?n.toggleEditorVisibility():(r=!0,n.createEditor())},document.body.appendChild(t)}
