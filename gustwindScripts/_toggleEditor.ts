var te=Object.defineProperty;var c=(t,e)=>()=>(t&&(e=t(t=0)),e);var P=(t,e)=>{for(var n in e)te(t,n,{get:e[n],enumerable:!0})};var O={};P(O,{registerListener:()=>re});function ne(){let t={mode:"silent",target:document.body};Promise.all([import("https://cdn.skypack.dev/twind@0.16.16/shim?min"),import("/twindSetup.js")]).then(([{setup:e},n])=>{console.log("loaded custom twind setup",n.default),e({...t,...n.default}),import("https://cdn.skypack.dev/twind@0.16.16?min").then(({tw:r})=>{j=r,k=!0,D.forEach(o=>o(r))})})}function re(t){console.log("registering a twind runtime listener"),k?t(j):D.push(t)}var k,j,D,R=c(()=>{k=!1,D=[];"Deno"in globalThis||ne()});function T({element:t,handle:e,xPosition:n},r){if(!t){console.warn("drag is missing elem!");return}I(t,"touchstart","touchmove","touchend",r,e,n),I(t,"mousedown","mousemove","mouseup",r,e,n)}function I(t,e,n,r,o,i,s){o=oe(o,s="left");let l=o.begin,a=o.change,d=o.end;C(i||t,e,g=>{let m=ee=>w(a,t,ee);function h(){$(document,n,m),$(document,r,h),w(d,t,g)}C(document,n,m),C(document,r,h),w(l,t,g)})}function C(t,e,n){let r=!1;try{let o=Object.defineProperty({},"passive",{get:function(){r=!0}});globalThis.addEventListener("testPassive",null,o),globalThis.removeEventListener("testPassive",null,o)}catch(o){console.error(o)}t.addEventListener(e,n,r?{passive:!1}:!1)}function $(t,e,n){t.removeEventListener(e,n,!1)}function oe(t,e="left"){if(t)return{begin:t.begin||E,change:t.change||E,end:t.end||E};let n,r;return{begin:function(o){let i=document.body.clientWidth;n={x:e==="left"?o.elem.offsetLeft:i-o.elem.offsetLeft-o.elem.clientWidth,y:o.elem.offsetTop},r=e==="left"?o.cursor:{x:i-o.cursor.x,y:o.cursor.y}},change:function(o){if(typeof n.x!="number"||typeof o.cursor.x!="number"||typeof r.x!="number")return;let i=document.body.clientWidth;W(o.elem,e,e==="left"?n.x+o.cursor.x-r.x+"px":n.x+(i-o.cursor.x)-r.x+"px"),!(typeof n.y!="number"||typeof o.cursor.y!="number"||typeof r.y!="number")&&W(o.elem,"top",n.y+o.cursor.y-r.y+"px")},end:E}}function W(t,e,n){t.style[e]=n}function E(){}function w(t,e,n){n.preventDefault();let r=ie(e),o=e.clientWidth,i=e.clientHeight,s={x:se(e,n),y:ae(e,n)};if(typeof s.x!="number"||typeof s.y!="number")return;let l=(s.x-r.x)/o,a=(s.y-r.y)/i;t({x:isNaN(l)?0:l,y:isNaN(a)?0:a,cursor:s,elem:e,e:n})}function ie(t){let e=t.getBoundingClientRect();return{x:e.left,y:e.top}}function se(t,e){return e instanceof TouchEvent?e.touches.item(0)?.clientX:e.clientX}function ae(t,e){return e instanceof TouchEvent?e.touches.item(0)?.clientY:e.clientY}var B=c(()=>{});import{getStyleTag as je,getStyleTagProperties as De,virtualSheet as Oe}from"https://cdn.skypack.dev/twind@0.16.16/sheets?min";import{tw as v}from"https://cdn.skypack.dev/twind@0.16.16?min";var F=c(()=>{});function u(t,e){let n=t;return e.split(".").forEach(r=>{p(n)&&(n=n[r])}),n}var p,L=c(()=>{p=t=>!Array.isArray(t)&&typeof t=="object"});async function _(t,e,n,r){if(!n)return Promise.resolve(r);if("Deno"in globalThis){let o=await import("https://deno.land/std@0.142.0/path/mod.ts");return(await Promise.all(n.map(s=>{let l=o.join(e,`${s}.ts`);return Deno.env.get("DEBUG")==="1"&&console.log("importing transform",l,e,s),t==="production"?import("file://"+l):import("file://"+l+"?cache="+new Date().getTime())}))).reduce((s,l)=>l.default(s),r)}return Promise.all(n.map(o=>import(`/transforms/${o}.js`)))}var N=c(()=>{});function M(t,e){return!t||!e?[]:Promise.all(Object.entries(e).map(([n,r])=>le(t,n,r)))}async function le(t,e,n){if(e.startsWith("__"))return[e.slice(2),u(t.__bound,n)||u(t,n)];if(e.startsWith("==")){let r=t.__bound||t;return[e.slice(2),await y(n,p(r)?r:{data:r})]}return[e,n]}function y(t,e={},n=!0){try{return Promise.resolve(Function.apply(null,Object.keys(e).concat(`return ${t}`))(...Object.values(e)))}catch(r){n&&console.error("Failed to evaluate",t,e,r)}}var q=c(()=>{L()});async function f(t,e,n,r,o={}){if(typeof e=="string")return e;if(e.visibleIf){let a=r.__bound||r;if(!z(a[e.visibleIf])||!await y(e.visibleIf,a,!1))return Promise.resolve("")}let i=e.element&&n[e.element];if(e.__bind&&(p(e.__bind)?r={...r,attributes:e.attributes,__bound:{...o,...r,render:a=>f(t,a,n,r,o),...await de(e.__bind,r)}}:r={...r,attributes:e.attributes,__bound:u(r,e.__bind)||u(r.__bound,e.__bind)}),i){if(Array.isArray(i))return await f(t,{element:"",children:i},n,r,o);e={...e,...i,element:i.element,class:ce(e.class,i.class)}}if(e?.transformWith){let a;if(typeof e.inputText=="string")a=await _("production",t,e?.transformWith,e.inputText);else if(typeof e.inputProperty=="string"){let d=u(r,e.inputProperty);if(!d)throw console.error("Missing input",r,e.inputProperty),new Error("Missing input");a=await _("production",t,e?.transformWith,d)}r={...r,...a}}let s;if(e.__children){let a=e.__children,d=r.__bound||r;typeof a=="string"?s=u(d,a)||u(r,a):s=(await Promise.all((Array.isArray(d)?d:[d]).flatMap(g=>a.map(m=>f(t,m,n,{...r,__bound:g},o))))).join("")}else if(e["==children"]){let a=e["==children"],d=r.__bound||r;s=await y(a,p(d)?{...o,...d}:{...o,data:d})}else if(e.__foreach){let[a,d]=e.__foreach,g=r.__bound||r;s=(await Promise.all(g[a].flatMap(m=>(Array.isArray(d)?d:[d]).map(h=>f(t,h,n,{...r,__bound:m,match:m},o))))).join("")}else s=Array.isArray(e.children)?(await Promise.all(e.children.map(async a=>await f(t,a,n,r,o)))).join(""):e.children;let l=await ue(e,r,o);return fe(e.element,await me({...o,attributes:e.attributes,...r},l?{...e.attributes,class:l}:e.attributes),s)}async function de(t,e){let n={};return(await M(e,t)).forEach(([o,i])=>{n[o]=u(e,i)||i}),n}async function ue(t,e,n){let r=[];return t.__class&&await Object.entries(t.__class).forEach(async([o,i])=>{await y(i,{attributes:t.attributes,context:{...n,...e,...e.__bound}})&&r.push(v(o))}),t.class?v(r.concat(t.class.split(" ")).join(" ")):r.join(" ")}function ce(t,e){return t?e?`${t} ${e}`:t:e||""}function fe(t,e,n){return t?`<${t}${e?" "+e:""}>${n||""}</${t}>`:typeof n=="string"?n:""}async function me(t,e){return e?(await M(t,e)).map(([r,o])=>z(o)?"":`${r}="${o}"`).join(" "):""}function z(t){return typeof t>"u"}var X=c(()=>{F();L();N();q()});function Y(){let t=document.querySelector('meta[name="pagepath"]');if(!t){console.error("path element was not found!");return}let e=t.getAttribute("content");if(!e){console.log("pagePath was not found in path element");return}return e}var J=c(()=>{});var Z={};P(Z,{createEditor:()=>G,toggleEditorVisibility:()=>he});import{produce as x}from"https://cdn.skypack.dev/immer@9.0.6?min";import{nanoid as ge}from"https://cdn.skypack.dev/nanoid@3.1.30?min";async function G(){console.log("create editor");let[t,e,n,r]=await Promise.all([fetch("/components.json").then(a=>a.json()),fetch("./context.json").then(a=>a.json()),fetch("./layout.json").then(a=>a.json()),fetch("./route.json").then(a=>a.json())]),o=be(n,r),i=document.createElement("div");i.setAttribute("x-label","selected"),i.setAttribute("x-state","{ componentId: undefined }"),o.appendChild(i);let s=await we(t,e);i.append(s);let l=await Te(t,e);i.append(l),document.body.appendChild(o),evaluateAllDirectives()}function be(t,e){let n=document.getElementById(H);return n?.remove(),n=document.createElement("div"),n.id=H,n.style.visibility="visible",n.setAttribute("x-state",JSON.stringify({...t,body:Ee(t.body),meta:e.meta})),n.setAttribute("x-label","editor"),n}function he(){let t=document.getElementById(H);!t||(t.style.visibility=t.style.visibility==="visible"?"hidden":"visible")}function Ee(t){if(!t){console.error("initializeBody - missing body");return}return x(t,e=>{b(e,n=>{n._id=ge()})})}function Ce(t){let e=x(t.body,r=>{b(r,o=>{delete o._id,o.class===""&&delete o.class})}),n={path:Y(),data:{...t,body:e}};window.developmentSocket.send(JSON.stringify({type:"update",payload:n}))}async function we(t,e){console.log("creating page editor");let n=document.createElement("div");n.id=pe,n.innerHTML=await f("",t.PageEditor,t,e);let r=n.children[0],o=r.children[0];return T({element:r,handle:o}),n}async function Te(t,e){let n=document.createElement("div");n.id=ye,n.innerHTML=await f("",t.ComponentEditor,t,e);let r=n.children[0],o=r.children[0];return T({element:r,handle:o,xPosition:"right"}),n}function ve(t,e){let{editor:{meta:n}}=getState(t),r=t.dataset.field;if(!r){console.error(`${r} was not found in ${t.dataset}`);return}if(r==="title"){let o=document.querySelector("title");o?o.innerHTML=e||"":console.warn("The page doesn't have a <title>!")}else{let o=document.head.querySelector("meta[name='"+r+"']");o?o.setAttribute("content",e):console.warn(`The page doesn't have a ${r} meta element!`)}setState({meta:{...n,[r]:e}},{element:t,parent:"editor"})}function Le(t,e){event?.stopPropagation();let{editor:{body:n}}=getState(t),r=o=>{let i=o.target;if(!i){console.warn("inputListener - No element found");return}o.preventDefault(),K(t,i.textContent)};for(let o of S.values())o.classList.remove("border"),o.classList.remove("border-red-800"),o.removeAttribute("contenteditable"),o.removeEventListener("focusout",r),S.delete(o);b(n,(o,i)=>{if(o._id===e){let s=Q(document.body,i,n);s.classList.add("border"),s.classList.add("border-red-800"),S.add(s),Array.isArray(o.children)||(s.setAttribute("contenteditable","true"),s.addEventListener("focusout",r))}}),setState({componentId:e},{element:t,parent:"selected"})}function _e(t,e){let{editor:{body:n},selected:{componentId:r}}=getState(t),o=A(n,r,(i,s)=>{s?.replaceWith(Me(s,e)),i.element=e});setState({body:o},{element:t,parent:"editor"})}function Me(t,e){let n=document.createElement(e),r=t.cloneNode(!0);for(;r.firstChild;)n.appendChild(r.firstChild);for(let o of r.attributes)n.setAttribute(o.name,o.value);return n}function K(t,e){let{editor:{body:n},selected:{componentId:r}}=getState(t),o=A(n,r,(i,s)=>{s&&(s.innerHTML=e),i.children=e});setState({body:o},{element:t,parent:"editor"})}function Se(t,e){let{editor:{body:n},selected:{componentId:r}}=getState(t),o=A(n,r,(i,s)=>{s&&(s.setAttribute("class",e),s.classList.add("border"),s.classList.add("border-red-800")),i.class=e});setState({body:o},{element:t,parent:"editor"})}function A(t,e,n){return x(t,r=>{b(r,(o,i)=>{o._id===e&&n(o,Q(document.body,i,t))})})}function Q(t,e,n){let r=0;function o(i,s){if(!i)return null;if(Array.isArray(s)){let l=i;for(let a of s){let d=o(l,a);if(d)return d;l=l?.nextElementSibling}}else{if(e===r)return i;if(r++,Array.isArray(s.children)){let l=o(i.firstElementChild,s.children);if(l)return l}}return null}return o(t?.firstElementChild,n)}function He(t,e){let n={},{componentId:r}=e;return b(t.body,o=>{o._id===r&&(n=o)}),n}function b(t,e){let n=0;function r(o,i){Array.isArray(o)?o.forEach(s=>r(s,i)):(i(o,n),n++,Array.isArray(o.children)&&r(o.children,i))}r(t,e)}function V(t,e=100){let n;return(...r)=>{clearTimeout(n),n=setTimeout(()=>{t.apply(this,r)},e)}}var pe,ye,H,S,U=c(()=>{B();X();J();pe="document-tree-element",ye="controls-element";H="editors";S=new Set;"Deno"in globalThis||(console.log("Hello from the page editor"),window.createEditor=G,window.metaChanged=ve,window.classChanged=V(Se),window.elementClicked=Le,window.elementChanged=_e,window.contentChanged=V(K),window.getSelectedComponent=He,window.updateFileSystem=Ce)});"Deno"in globalThis||Promise.resolve().then(()=>(R(),O)).then(t=>{t.registerListener(xe)});function xe(t){console.log("initializing editor");let e=!1,n=document.createElement("button");n.className=t("fixed right-4 bottom-4 whitespace-nowrap text-lg"),n.innerText="\u{1F433}\u{1F4A8}",n.onclick=async()=>{let r=await Promise.resolve().then(()=>(U(),Z));e?r.toggleEditorVisibility():(e=!0,r.createEditor())},document.body.appendChild(n)}
