var Y=Object.defineProperty;var u=(t,e)=>()=>(t&&(e=t(t=0)),e);var H=(t,e)=>{for(var n in e)Y(t,n,{get:e[n],enumerable:!0})};var z={};H(z,{registerListener:()=>tt});function Z(){let t={mode:"silent",target:document.body};Promise.all([import("https://cdn.skypack.dev/twind@0.16.16/shim?min"),import("/twindSetup.js")]).then(([{setup:e},n])=>{console.log("loaded custom twind setup",n.default),e({...t,...n.default}),import("https://cdn.skypack.dev/twind@0.16.16?min").then(({tw:i})=>{I=i,j=!0,O.forEach(r=>r(i))})})}function tt(t){console.log("registering a twind runtime listener"),j?t(I):O.push(t)}var j,I,O,$=u(()=>{j=!1,O=[];"Deno"in globalThis||Z()});function D(t,e){let n=[],i=t.parentElement;for(;i;)i.hasAttribute(e)&&n.push(i),i=i.parentElement;return n}var B=u(()=>{});function N(t,e){let n=document.createElement(e),i=t.cloneNode(!0);for(;i.firstChild;)n.appendChild(i.firstChild);for(let r of i.attributes)n.setAttribute(r.name,r.value);return n}var k=u(()=>{});function C(t,e){let n=0;function i(r,o){Array.isArray(r)?r.forEach(a=>i(a,o)):(o(r,n),n++,Array.isArray(r.children)&&i(r.children,o),r.props&&i(Object.values(r.props),o))}i(t,e)}var R=u(()=>{});function g(t){return typeof t>"u"}function y(t,e,n){if(!e)return;let i=t,r=e.split(".");return r.length===1?t?t[e]:n:(r.forEach(o=>{f(i)&&(i=i[o])}),g(i)?n:i)}var f,E=u(()=>{f=t=>!Array.isArray(t)&&typeof t=="object"});async function V(t,e,n){return Object.fromEntries(await Promise.all(Object.entries(t).map(async([i,r])=>[i,typeof r=="string"?r:await d(r,e,n)])))}async function d(t,e,n){if(!e)throw new Error("applyUtility - No utilities were provided");let i=e[t.utility];if(!i)throw console.error({utilities:e,value:t}),new Error("applyUtility - Matching utility was not found");let r=await Promise.all(Array.isArray(t.parameters)?t.parameters.map(o=>{if(typeof o!="string"){if(o.utility&&o.parameters)return d(o,e,n)}return o}):[]);return i.apply(null,[n].concat(r))}var w=u(()=>{});var L,q=u(()=>{E();L={concat:(t,...e)=>e.join(""),get:(t,e,n,i)=>y(y(t,e),n,i)}});async function h({component:t,components:e,extensions:n,context:i,props:r,utilities:o}){let a=(c,X)=>h({component:X,components:e,extensions:n,context:i,utilities:o});if(o=f(o)?{render:a,...L,...o}:{render:a,...L},Array.isArray(t))return(await Promise.all(t.map(c=>h({component:c,components:e,extensions:n,context:i,props:r,utilities:o})))).join("");let s=t.type,l=s&&typeof s=="string"&&e?.[s];if(r=t.props||r,t.bindToProps&&(r={...await V(t.bindToProps,o,{context:i,props:r}),...r}),l)return(await Promise.all((Array.isArray(l)?l:[l]).map(c=>h({component:c,components:e,extensions:n,context:i,props:r,utilities:o})))).join("");if(n){for(let c of n)t=await c(t,{props:r,context:i},o);s=t.type}let m=await et(t.attributes,{props:r,context:i},o),p=s;if(typeof s=="string"||s?.utility&&s?.parameters&&(p=await d(s,o,{context:i,props:r})),t.children){let c=t.children;return typeof c=="string"||(Array.isArray(c)?c=await h({component:c,props:r,components:e,extensions:n,context:i,utilities:o}):c.utility&&o&&(c=await d(c,o,{context:i,props:r}))),F(p,m,c)}return s?typeof t.closingCharacter=="string"?`<${p}${m?" "+m:""} ${t.closingCharacter}>`:F(p,m):""}function F(t,e,n=""){return t?`<${t}${e?" "+e:""}>${n}</${t}>`:n||""}async function et(t,e,n){return t?(await nt(t,e,n)).map(([i,r])=>r&&r.length>0?`${i}="${r}"`:i).join(" "):""}async function nt(t,e,n){return t?(await Promise.all(await Object.entries(t).map(async([i,r])=>{if(g(r))return[];let o=r;if(g(o))return[];if(o.context?o=y(y(e,o.context),o.property,o.default):o.utility&&n&&(o=await d(o,n,e)),!g(o))return[i,o]}))).filter(Boolean):[]}var T,_=u(()=>{E();w();q();T=h});function x(t){return async function(e,n,i){let r=[];if(typeof e.class=="string"?r.push(e.class):e.class?.utility&&e.class.parameters&&r.push(await d(e.class,i,n)),f(e.classList)){let o=(await Promise.all(await Object.entries(e.classList).map(async([a,s])=>{let l=await d(s[0],i,n);if(s.length===1)return l;let m=(await Promise.all(s.map(async p=>l===await d(p,i,n)))).filter(Boolean);return s.length===m.length&&a}))).filter(Boolean).join(" ");r.push(o)}return r.length?{...e,attributes:{...e.attributes,class:r.map(o=>t(o)).join(" ")}}:e}}async function S(t,e,n){if(!e||!t.foreach)return Promise.resolve(t);let[i,r]=t.foreach,o=await d(i,n,e);return Array.isArray(o)?Promise.resolve({...t,children:o.flatMap(a=>Array.isArray(r)?r.map(s=>({...s,props:f(a)?a:{value:a}})):{...r,props:f(a)?a:{value:a}})}):Promise.resolve(t)}async function v(t,e,n){if(!Array.isArray(t.visibleIf))return Promise.resolve(t);if(t.visibleIf.length===0)return Promise.resolve({});let r=(await Promise.all(t.visibleIf.map(async o=>await d(o,n,e)))).filter(Boolean).length===t.visibleIf.length;return Promise.resolve(r?t:{})}var W=u(()=>{E();w()});import{getStyleTag as Ot,getStyleTagProperties as zt,virtualSheet as $t}from"https://cdn.skypack.dev/twind@0.16.16/sheets?min";import{draggable as A}from"https://cdn.skypack.dev/dragjs@v0.13.3?min";import{produce as P}from"https://cdn.skypack.dev/immer@9.0.6?min";import{setup as kt}from"https://cdn.skypack.dev/twind@0.16.16?min";import{tw as Vt}from"https://cdn.skypack.dev/twind@0.16.16?min";var J=u(()=>{});var K={};H(K,{createEditor:()=>G,toggleEditorVisibility:()=>dt});async function G(){console.log("create editor");let[t,e,n,i]=await Promise.all([fetch("/components.json").then(l=>l.json()),fetch("./context.json").then(l=>l.json()),fetch("./layout.json").then(l=>l.json()),fetch("./route.json").then(l=>l.json())]),r=ct(n,i),o=await ut(t,e);r.append(o);let a=await mt(t,e);r.append(a),document.body.appendChild(r),evaluateAllDirectives();let s=st(r);globalThis.onclick=({target:l})=>s(l),globalThis.ontouchstart=({target:l})=>s(l)}function st(t){return function(n){if(!n)return;let i=n,r=i.hasAttribute("data-id")?i:D(i,"data-id")[0];if(!r)return;let o=r.getAttribute("data-id"),{editor:{layout:a}}=getState(t);setState({selectionId:o},{element:t,parent:"editor"}),r&&at(t,r,a)}}function at(t,e,n){let i,r=e.dataset.id;if(!r){console.log("target doesn't have a selection id");return}let o=s=>{!s||!s.target||lt(t,n,r,s.target,i)},a=s=>{if(!s.target){console.warn("inputListener - No element found");return}s.preventDefault(),e.removeAttribute("contenteditable"),e.removeEventListener("input",o),e.removeEventListener("focusout",a)};b&&(b.classList.remove("border"),b.classList.remove("border-red-800")),b=e,e.classList.add("border"),e.classList.add("border-red-800"),e.children.length===0&&e.textContent&&(i=e.textContent,e.setAttribute("contenteditable","true"),e.addEventListener("focusout",a),e.addEventListener("input",o),e.focus())}function lt(t,e,n,i,r){let o=i.textContent;if(r===o){console.log("content didn't change");return}if(typeof o!="string")return;console.log("content changed",o);let a=P(e,l=>{C(l,m=>{m?.attributes?.["data-id"]===n&&(m.children=o)})}),s=t.children[0];setState({layout:a},{element:s,parent:"editor"})}function ct(t,e){let n=document.getElementById(U),i={layout:t,meta:e.meta,selectionId:void 0};return n?.remove(),n=document.createElement("div"),n.id=U,n.style.visibility="visible",n.setAttribute("x-state",JSON.stringify(i)),n.setAttribute("x-label","editor"),n}function dt(){let t=document.getElementById(U);!t||(t.style.visibility=t.style.visibility==="visible"?"hidden":"visible")}async function ut(t,e){console.log("creating page editor");let n=document.createElement("div");n.id=rt,n.innerHTML=await T({component:t.PageEditor,components:t,context:e,extensions:[x,S,v]});let i=n.children[0],r=i.children[0];return A({element:i,handle:r}),n}async function mt(t,e){let n=document.createElement("div");n.id=ot,n.innerHTML=await T({component:t.ComponentEditor,components:t,context:e,extensions:[x,S,v]});let i=n.children[0],r=i.children[0];return A({element:i,handle:r,xPosition:"right"}),n}function ft(t,e){let{editor:{meta:n}}=getState(t),i=t.dataset.field;if(!i){console.error(`${i} was not found in ${t.dataset}`);return}if(i==="title"){let r=document.querySelector("title");r?r.innerHTML=e||"":console.warn("The page doesn't have a <title>!")}else{let r=document.head.querySelector("meta[name='"+i+"']");r?r.setAttribute("content",e):console.warn(`The page doesn't have a ${i} meta element!`)}setState({meta:{...n,[i]:e}},{element:t,parent:"editor"})}function pt(t,e){let{editor:{layout:n,selectionId:i}}=getState(t),r=M(n,i,(o,a)=>{a.forEach(s=>{s.innerHTML=e}),o.children=e});setState({layout:r},{element:t,parent:"editor"})}function yt(t,e){let{editor:{layout:n,selectionId:i}}=getState(t),r=M(n,i,(o,a)=>{Array.isArray(o)||(a.forEach(s=>s.setAttribute("class",e)),o.class=e)});setState({layout:r},{element:t,parent:"editor"})}function gt(t,e){let{editor:{layout:n,selectionId:i}}=getState(t),r=M(n,i,(o,a)=>{Array.isArray(o)||(a.forEach(s=>s.replaceWith(N(s,e))),o.type=e)});setState({layout:r},{element:t,parent:"editor"})}function M(t,e,n){return P(t,i=>{C(i,r=>{r?.attributes?.["data-id"]===e&&n(r,Array.from(document.querySelectorAll(`*[data-id="${e}"]`)))})})}function ht(t){let{layout:e,selectionId:n}=t;if(!n)return{};let i;return C(e,r=>{r?.attributes?.["data-id"]===n&&(i=r)}),i}var rt,ot,b,U,Q=u(()=>{B();k();R();_();W();J();rt="document-tree-element",ot="controls-element";U="editors";"Deno"in globalThis||(console.log("Hello from the page editor"),window.createEditor=G,window.classChanged=yt,window.contentChanged=pt,window.getSelectedComponent=ht,window.metaChanged=ft,window.elementChanged=gt)});"Deno"in globalThis||Promise.resolve().then(()=>($(),z)).then(t=>{t.registerListener(Ct)});function Ct(t){console.log("initializing editor");let e=!1,n=document.createElement("button");n.className=t("fixed right-4 bottom-4 whitespace-nowrap text-lg"),n.innerText="\u{1F433}\u{1F4A8}",n.onclick=async()=>{let i=await Promise.resolve().then(()=>(Q(),K));e?i.toggleEditorVisibility():(e=!0,i.createEditor())},document.body.appendChild(n)}
