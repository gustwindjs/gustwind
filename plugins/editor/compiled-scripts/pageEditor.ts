import{draggable as D}from"https://cdn.skypack.dev/dragjs@v0.13.4?min";import{produce as B}from"https://cdn.skypack.dev/immer@9.0.16?min";function H(t,e){let r=[],n=t.parentElement;for(;n;)n.hasAttribute(e)&&r.push(n),n=n.parentElement;return r}function M(t,e){let r=document.createElement(e),n=t.cloneNode(!0);for(;n.firstChild;)r.appendChild(n.firstChild);for(let i of n.attributes)r.setAttribute(i.name,i.value);return r}function w(t,e){let r=0;function n(i,o){Array.isArray(i)?i.forEach(s=>n(s,o)):(o(i,r),r++,Array.isArray(i.children)&&n(i.children,o),i.props&&n(Object.values(i.props),o))}n(t,e)}function k(t){return typeof t=="boolean"}function I(t){return t===null}function b(t){return typeof t>"u"}var f=t=>t!==null&&!Array.isArray(t)&&typeof t=="object";function y(t,e,r){if(!f(t))throw console.error(t),new Error("get - data context is not an object!");if(!e)return r;let n=t,i=e.split(".");if(i.length===1){if(t){let o=t[e];return b(o)||I(o)?r:o}return r}return i.forEach(o=>{f(n)&&(n=n[o])}),b(n)||I(n)?r:n}function O(t,e){if(!t)return{};let r={...t};return delete r[e],r}async function $(t,e,r){return Object.fromEntries(await Promise.all(Object.entries(t).map(async([n,i])=>[n,typeof i=="string"?i:await m(i,e,r)])))}async function m(t,e,r){if(!e)throw new Error("applyUtility - No utilities were provided");if(!t||typeof t.utility!="string")return;let n=e[t.utility];if(!n)throw console.error({utilities:e,value:t}),new Error("applyUtility - Matching utility was not found");let i=await Promise.all(Array.isArray(t.parameters)?t.parameters.map(o=>{if(typeof o!="string"){if(o.utility&&o.parameters)return m(o,e,r)}return o}):[]);return n.apply({context:r},i)}function R(t,e){return e==="]"&&(e="\\]"),e==="^"&&(e="\\^"),e==="\\"&&(e="\\\\"),t?.replace(new RegExp("^["+e+"]+|["+e+"]+$","g"),"")}var S={id:t=>t,equals:(t,e)=>t===e,pick:function(e,r){return e?r:""},or:(...t)=>t.some(e=>!!e),and:(...t)=>t.every(e=>!!e),concat:(...t)=>t.join(""),get:function(e,r,n){let{context:i}=this,o=y(i,e);if(!f(o))throw console.error(i,e),new Error("get - Found context is not an object");return y(o,r,n)},stringify:t=>JSON.stringify(t,null,2),trim:R};async function q(t){let{context:e={},globalUtilities:r}=t;r?._onRenderStart&&r._onRenderStart(e);let n=await h(t);return r?._onRenderEnd&&r._onRenderEnd(e),n}async function h({component:t,components:e,extensions:r,context:n,props:i,globalUtilities:o,componentUtilities:s}){if(typeof t=="string")return t;let a=c=>z(c)?h({component:c,components:e,extensions:r,context:n,globalUtilities:o,componentUtilities:s}):c;if(o=f(o)?{render:a,...S,...o}:{render:a,...S},Array.isArray(t))return(await Promise.all(t.map(c=>h({component:c,components:e,extensions:r,context:n,props:{children:c.children,...i},globalUtilities:o,componentUtilities:s})))).join("");if(!f(t))return"";let l=t.type,p=l&&typeof l=="string"&&e?.[l]&&f(e?.[l])?{...O(t,"type"),...e?.[l]}:e?.[l],u={...i,...t.props},d={};if(t.bindToProps&&(d=await $(t.bindToProps,o,{context:n,props:u}),u={...u,...d}),p){let c={...o,...s?.[l]};return(await Promise.all((Array.isArray(p)?p:[p]).map(L=>h({component:L,components:e,extensions:r,context:n,props:{...u,children:t.children,...d},globalUtilities:c,componentUtilities:s})))).join("")}if(r){for(let c of r)t=await c(t,{props:u,context:n},o);l=t.type}let C=await F(t.attributes,{props:u,context:n},o),E=l;if(typeof l=="string"||l?.utility&&l?.parameters&&(E=await m(l,o,{context:n,props:u})),t.children){let c=t.children;if(typeof c!="string")if(Array.isArray(c)){let L=await Promise.all(c.map(g=>typeof g=="string"?g:g.utility?m(g,o,{context:n,props:u}):g));c=await h({component:L,props:u,components:e,extensions:r,context:n,globalUtilities:o,componentUtilities:s})}else c.utility&&o&&(c=await m(c,o,{context:n,props:u}));return N(E,C,c)}return l?typeof t.closingCharacter=="string"?`<${E}${C?" "+C:""} ${t.closingCharacter}>`:N(E,C):""}function z(t){return Array.isArray(t)?t.every(z):!!(f(t)&&(t.children||t.type))}function N(t,e,r=""){return t?`<${t}${e?" "+e:""}>${r}</${t}>`:r||""}async function F(t,e,r){return t?(await V(t,e,r)).map(([n,i])=>i&&!k(i)&&i.toString().length>0?`${n}="${i}"`:n).join(" "):""}function V(t,e,r){return Promise.all(Object.entries(t).map(async([n,i])=>{if(b(i))return[];let o=i;return f(o)&&y(o,"context")?o=y(y(e,o.context),o.property,o.default):o.utility&&r&&(o=await m(o,r,e)),[n,o]}))}var A=q;function T(t){return async function(e,r,n){let i=[];if(typeof e.class=="string"?i.push(e.class):typeof e.attributes?.class=="string"?i.push(e.attributes.class):e.class?.utility&&e.class.parameters&&i.push(await m(e.class,n,r)),f(e.classList)){let o=(await Promise.all(await Object.entries(e.classList).map(async([s,a])=>{let l=await m(a[0],n,r);if(a.length===1)return l;let p=(await Promise.all(a.map(async u=>l===await m(u,n,r)))).filter(Boolean);return a.length===p.length&&s}))).filter(Boolean).join(" ");i.push(o)}return i.length?{...e,attributes:{...e.attributes,class:t?i.map(o=>t(o)).join(" "):i.join(" ")}}:e}}async function v(t,e,r){if(!e||!t.foreach)return Promise.resolve(t);let[n,i]=t.foreach,o=await m(n,r,e);return Array.isArray(o)?Promise.resolve({...t,children:o.flatMap(s=>Array.isArray(i)?i.map(a=>({...a,props:f(s)?s:{value:s}})):{...i,props:f(s)?s:{value:s}})}):Promise.resolve(t)}async function P(t,e,r){if(!t.visibleIf)return t;if(!t.visibleIf.utility)return{};let n=await m(t.visibleIf,r,e);return Array.isArray(n)?n.filter(Boolean).length>0?t:{}:n?t:{}}var W="document-tree-element",J="controls-element";async function Y(t,e,r){console.log("create editor");let[n,i,o,s]=await Promise.all([fetch("/components.json").then(d=>d.json()),fetch("./context.json").then(d=>d.json()),fetch("./layout.json").then(d=>d.json()),fetch("./route.json").then(d=>d.json())]),a=X(o,s),l=await Z(n,i,t,e,r);a.append(l);let p=await tt(n,i,t);a.append(p),document.body.appendChild(a),evaluateAllDirectives();let u=G(a);globalThis.onclick=({target:d})=>u(d),globalThis.ontouchstart=({target:d})=>u(d)}function G(t){return function(r){if(!r)return;let n=r,i=n.hasAttribute("data-id")?n:H(n,"data-id")[0];if(!i||i.nodeName==="BODY")return;let o=i.getAttribute("data-id"),{editor:{layout:s}}=getState(t);setState({selectionId:o},{element:t,parent:"editor"}),i&&K(t,i,s)}}var x;function K(t,e,r){let n,i=e.dataset.id;if(!i){console.log("target doesn't have a selection id");return}let o=a=>{!a||!a.target||Q(t,r,i,a.target,n)},s=a=>{if(!a.target){console.warn("inputListener - No element found");return}a.preventDefault(),e.removeAttribute("contenteditable"),e.removeEventListener("input",o),e.removeEventListener("focusout",s)};x&&(x.classList.remove("border"),x.classList.remove("border-red-800")),x=e,e.classList.add("border"),e.classList.add("border-red-800"),e.children.length===0&&e.textContent&&(n=e.textContent,e.setAttribute("contenteditable","true"),e.addEventListener("focusout",s),e.addEventListener("input",o),e.focus())}function Q(t,e,r,n,i){let o=n.textContent;if(i===o){console.log("content didn't change");return}if(typeof o!="string")return;let s=B(e,l=>{w(l,p=>{p?.attributes?.["data-id"]===r&&(p.children=o)})}),a=t.children[0];setState({layout:s},{element:a,parent:"editor"})}var U="editors";function X(t,e){let r=document.getElementById(U),n={layout:t,meta:e.meta,selectionId:void 0};return r?.remove(),r=document.createElement("div"),r.id=U,r.style.visibility="visible",r.setAttribute("x-state",JSON.stringify(n)),r.setAttribute("x-label","editor"),r}function vt(){let t=document.getElementById(U);t&&(t.style.visibility=t.style.visibility==="visible"?"hidden":"visible")}async function Z(t,e,r,n,i){console.log("creating page editor");let o=document.createElement("div");o.id=W,o.innerHTML=await A({component:t.PageEditor,components:t,context:e,extensions:[P,T(r),v],globalUtilities:n,componentUtilities:i});let s=o.children[0],a=s.children[0];return D({element:s,handle:a}),o}async function tt(t,e,r){let n=document.createElement("div");n.id=J,n.innerHTML=await A({component:t.ComponentEditor,components:t,context:e,extensions:[P,T(r),v]});let i=n.children[0],o=i.children[0];return D({element:i,handle:o,xPosition:"right"}),n}function et(t,e){let{editor:{meta:r}}=getState(t),n=t.dataset.field;if(!n){console.error(`${n} was not found in ${t.dataset}`);return}if(n==="title"){let i=document.querySelector("title");i?i.innerHTML=e||"":console.warn("The page doesn't have a <title>!")}else{let i=document.head.querySelector("meta[name='"+n+"']");i?i.setAttribute("content",e):console.warn(`The page doesn't have a ${n} meta element!`)}setState({meta:{...r,[n]:e}},{element:t,parent:"editor"})}function nt(t,e){let{editor:{layout:r,selectionId:n}}=getState(t),i=j(r,n,(o,s)=>{s.forEach(a=>{a.innerHTML=e}),o.children=e});setState({layout:i},{element:t,parent:"editor"})}function rt(t,e){let{editor:{layout:r,selectionId:n}}=getState(t),i=j(r,n,(o,s)=>{Array.isArray(o)||(s.forEach(a=>a.setAttribute("class",e)),o.class=e)});setState({layout:i},{element:t,parent:"editor"})}function it(t,e){let{editor:{layout:r,selectionId:n}}=getState(t),i=j(r,n,(o,s)=>{Array.isArray(o)||(s.forEach(a=>a.replaceWith(M(a,e))),o.type=e)});setState({layout:i},{element:t,parent:"editor"})}function j(t,e,r){return B(t,n=>{w(n,i=>{i?.attributes?.["data-id"]===e&&r(i,Array.from(document.querySelectorAll(`*[data-id="${e}"]`)))})})}function ot(t){let{layout:e,selectionId:r}=t;if(!r)return{};let n;return w(e,i=>{i?.attributes?.["data-id"]===r&&(n=i)}),n}"Deno"in globalThis||(console.log("Hello from the page editor"),window.createEditor=Y,window.classChanged=rt,window.contentChanged=nt,window.getSelectedComponent=ot,window.metaChanged=et,window.elementChanged=it);export{Y as createEditor,vt as toggleEditorVisibility};
