var et=Object.defineProperty;var m=(t,e)=>()=>(t&&(e=t(t=0)),e);var H=(t,e)=>{for(var n in e)et(t,n,{get:e[n],enumerable:!0})};var R={};H(R,{registerListener:()=>k});function nt(){Promise.all([import("https://esm.sh/@twind/core@1.1.1"),import("/twindSetup.js")]).then(([{install:t,tw:e},n])=>{console.log("loaded custom twind setup",n.default),t(n.default),window.tw=e,I=e,M=!0,O.forEach(r=>r(e))})}function k(t){console.log("Registering a twind runtime listener"),M?t(I):O.push(t)}var M,I,O,$=m(()=>{M=!1,O=[];"Deno"in globalThis||(nt(),window.registerTwListener=k)});function z(t,e){let n=[],r=t.parentElement;for(;r;)r.hasAttribute(e)&&n.push(r),r=r.parentElement;return n}var D=m(()=>{});function N(t,e){let n=document.createElement(e),r=t.cloneNode(!0);for(;r.firstChild;)n.appendChild(r.firstChild);for(let i of r.attributes)n.setAttribute(i.name,i.value);return n}var B=m(()=>{});function E(t,e){let n=0;function r(i,o){Array.isArray(i)?i.forEach(a=>r(a,o)):(o(i,n),n++,Array.isArray(i.children)&&r(i.children,o),i.props&&r(Object.values(i.props),o))}r(t,e)}var _=m(()=>{});function y(t){return typeof t>"u"}function g(t,e,n){if(!f(t))throw console.error(t),new Error("get - data context is not an object!");if(!e)return n;let r=t,i=e.split(".");if(i.length===1){if(t){let o=t[e];return y(o)?n:o}return n}return i.forEach(o=>{f(r)&&(r=r[o])}),y(r)?n:r}var f,w=m(()=>{f=t=>!Array.isArray(t)&&typeof t=="object"});async function F(t,e,n){return Object.fromEntries(await Promise.all(Object.entries(t).map(async([r,i])=>[r,typeof i=="string"?i:await u(i,e,n)])))}async function u(t,e,n){if(!e)throw new Error("applyUtility - No utilities were provided");if(typeof t.utility!="string")return;let r=e[t.utility];if(!r)throw console.error({utilities:e,value:t}),new Error("applyUtility - Matching utility was not found");let i=await Promise.all(Array.isArray(t.parameters)?t.parameters.map(o=>{if(typeof o!="string"){if(o.utility&&o.parameters)return u(o,e,n)}return o}):[]);return r.apply(void 0,[n].concat(i))}var x=m(()=>{});var T,q=m(()=>{w();T={concat:(t,...e)=>e.join(""),get:(t,e,n,r)=>{let i=g(t,e);if(!f(i))throw console.error(t,e),new Error("get - Found context is not an object");return g(i,n,r)},stringify:(t,e)=>JSON.stringify(e,null,2)}});async function rt(t){let{context:e={},utilities:n}=t;n?._onRenderStart&&n._onRenderStart(e);let r=await h(t);return n?._onRenderEnd&&n._onRenderEnd(e),r}async function h({component:t,components:e,extensions:n,context:r,props:i,utilities:o}){let a=(c,L)=>W(L)?h({component:L,components:e,extensions:n,context:r,utilities:o}):L;if(o=f(o)?{render:a,...T,...o}:{render:a,...T},Array.isArray(t))return(await Promise.all(t.map(c=>h({component:c,components:e,extensions:n,context:r,props:i,utilities:o})))).join("");let s=t.type,l=s&&typeof s=="string"&&e?.[s],d={...i,...t.props};if(t.bindToProps){let c=await F(t.bindToProps,o,{context:r,props:d});d={...d,...c}}if(l)return(await Promise.all((Array.isArray(l)?l:[l]).map(c=>h({component:c,components:e,extensions:n,context:r,props:d,utilities:o})))).join("");if(n){for(let c of n)t=await c(t,{props:d,context:r},o);s=t.type}let p=await it(t.attributes,{props:d,context:r},o),C=s;if(typeof s=="string"||s?.utility&&s?.parameters&&(C=await u(s,o,{context:r,props:d})),t.children){let c=t.children;return typeof c=="string"||(Array.isArray(c)?c=await h({component:c,props:d,components:e,extensions:n,context:r,utilities:o}):c.utility&&o&&(c=await u(c,o,{context:r,props:d}))),V(C,p,c)}return s?typeof t.closingCharacter=="string"?`<${C}${p?" "+p:""} ${t.closingCharacter}>`:V(C,p):""}function W(t){return Array.isArray(t)?t.every(W):!!(f(t)&&t.children)}function V(t,e,n=""){return t?`<${t}${e?" "+e:""}>${n}</${t}>`:n||""}async function it(t,e,n){return t?(await ot(t,e,n)).map(([r,i])=>i&&i.length>0?`${r}="${i}"`:r).join(" "):""}async function ot(t,e,n){return t?(await Promise.all(await Object.entries(t).map(async([r,i])=>{if(y(i))return[];let o=i;if(y(o))return[];if(o.context?o=g(g(e,o.context),o.property,o.default):o.utility&&n&&(o=await u(o,n,e)),!y(o))return[r,o]}))).filter(Boolean):[]}var S,J=m(()=>{w();x();q();S=rt});function A(t){return async function(e,n,r){let i=[];if(typeof e.class=="string"?i.push(e.class):e.class?.utility&&e.class.parameters&&i.push(await u(e.class,r,n)),f(e.classList)){let o=(await Promise.all(await Object.entries(e.classList).map(async([a,s])=>{let l=await u(s[0],r,n);if(s.length===1)return l;let d=(await Promise.all(s.map(async p=>l===await u(p,r,n)))).filter(Boolean);return s.length===d.length&&a}))).filter(Boolean).join(" ");i.push(o)}return i.length?{...e,attributes:{...e.attributes,class:t?i.map(o=>t(o)).join(" "):i.join(" ")}}:e}}async function v(t,e,n){if(!e||!t.foreach)return Promise.resolve(t);let[r,i]=t.foreach,o=await u(r,n,e);return Array.isArray(o)?Promise.resolve({...t,children:o.flatMap(a=>Array.isArray(i)?i.map(s=>({...s,props:f(a)?a:{value:a}})):{...i,props:f(a)?a:{value:a}})}):Promise.resolve(t)}async function P(t,e,n){if(!Array.isArray(t.visibleIf))return Promise.resolve(t);if(t.visibleIf.length===0)return Promise.resolve({});let i=(await Promise.all(t.visibleIf.map(async o=>{let a=await u(o,n,e);return Array.isArray(a)?a.length>0:a}))).filter(Boolean).length===t.visibleIf.length;return Promise.resolve(i?t:{})}var G=m(()=>{w();x()});var Z={};H(Z,{createEditor:()=>Y,toggleEditorVisibility:()=>mt});import{draggable as K}from"https://cdn.skypack.dev/dragjs@v0.13.3?min";import{produce as Q}from"https://cdn.skypack.dev/immer@9.0.16?min";import{tw as X}from"https://esm.sh/@twind/core@1.1.1";async function Y(){console.log("create editor");let[t,e,n,r]=await Promise.all([fetch("/components.json").then(l=>l.json()),fetch("./context.json").then(l=>l.json()),fetch("./layout.json").then(l=>l.json()),fetch("./route.json").then(l=>l.json())]),i=ft(n,r),o=await pt(t,e);i.append(o);let a=await yt(t,e);i.append(a),document.body.appendChild(i),evaluateAllDirectives();let s=ct(i);globalThis.onclick=({target:l})=>s(l),globalThis.ontouchstart=({target:l})=>s(l)}function ct(t){return function(n){if(!n)return;let r=n,i=r.hasAttribute("data-id")?r:z(r,"data-id")[0];if(!i)return;let o=i.getAttribute("data-id"),{editor:{layout:a}}=getState(t);setState({selectionId:o},{element:t,parent:"editor"}),i&&dt(t,i,a)}}function dt(t,e,n){let r,i=e.dataset.id;if(!i){console.log("target doesn't have a selection id");return}let o=s=>{!s||!s.target||ut(t,n,i,s.target,r)},a=s=>{if(!s.target){console.warn("inputListener - No element found");return}s.preventDefault(),e.removeAttribute("contenteditable"),e.removeEventListener("input",o),e.removeEventListener("focusout",a)};b&&(b.classList.remove("border"),b.classList.remove("border-red-800")),b=e,e.classList.add("border"),e.classList.add("border-red-800"),e.children.length===0&&e.textContent&&(r=e.textContent,e.setAttribute("contenteditable","true"),e.addEventListener("focusout",a),e.addEventListener("input",o),e.focus())}function ut(t,e,n,r,i){let o=r.textContent;if(i===o){console.log("content didn't change");return}if(typeof o!="string")return;let a=Q(e,l=>{E(l,d=>{d?.attributes?.["data-id"]===n&&(d.children=o)})}),s=t.children[0];setState({layout:a},{element:s,parent:"editor"})}function ft(t,e){let n=document.getElementById(U),r={layout:t,meta:e.meta,selectionId:void 0};return n?.remove(),n=document.createElement("div"),n.id=U,n.style.visibility="visible",n.setAttribute("x-state",JSON.stringify(r)),n.setAttribute("x-label","editor"),n}function mt(){let t=document.getElementById(U);t&&(t.style.visibility=t.style.visibility==="visible"?"hidden":"visible")}async function pt(t,e){console.log("creating page editor");let n=document.createElement("div");n.id=at,n.innerHTML=await S({component:t.PageEditor,components:t,context:e,extensions:[P,A(X),v]});let r=n.children[0],i=r.children[0];return K({element:r,handle:i}),n}async function yt(t,e){let n=document.createElement("div");n.id=lt,n.innerHTML=await S({component:t.ComponentEditor,components:t,context:e,extensions:[P,A(X),v]});let r=n.children[0],i=r.children[0];return K({element:r,handle:i,xPosition:"right"}),n}function gt(t,e){let{editor:{meta:n}}=getState(t),r=t.dataset.field;if(!r){console.error(`${r} was not found in ${t.dataset}`);return}if(r==="title"){let i=document.querySelector("title");i?i.innerHTML=e||"":console.warn("The page doesn't have a <title>!")}else{let i=document.head.querySelector("meta[name='"+r+"']");i?i.setAttribute("content",e):console.warn(`The page doesn't have a ${r} meta element!`)}setState({meta:{...n,[r]:e}},{element:t,parent:"editor"})}function ht(t,e){let{editor:{layout:n,selectionId:r}}=getState(t),i=j(n,r,(o,a)=>{a.forEach(s=>{s.innerHTML=e}),o.children=e});setState({layout:i},{element:t,parent:"editor"})}function Ct(t,e){let{editor:{layout:n,selectionId:r}}=getState(t),i=j(n,r,(o,a)=>{Array.isArray(o)||(a.forEach(s=>s.setAttribute("class",e)),o.class=e)});setState({layout:i},{element:t,parent:"editor"})}function Et(t,e){let{editor:{layout:n,selectionId:r}}=getState(t),i=j(n,r,(o,a)=>{Array.isArray(o)||(a.forEach(s=>s.replaceWith(N(s,e))),o.type=e)});setState({layout:i},{element:t,parent:"editor"})}function j(t,e,n){return Q(t,r=>{E(r,i=>{i?.attributes?.["data-id"]===e&&n(i,Array.from(document.querySelectorAll(`*[data-id="${e}"]`)))})})}function wt(t){let{layout:e,selectionId:n}=t;if(!n)return{};let r;return E(e,i=>{i?.attributes?.["data-id"]===n&&(r=i)}),r}var at,lt,b,U,tt=m(()=>{D();B();_();J();G();at="document-tree-element",lt="controls-element";U="editors";"Deno"in globalThis||(console.log("Hello from the page editor"),window.createEditor=Y,window.classChanged=Ct,window.contentChanged=ht,window.getSelectedComponent=wt,window.metaChanged=gt,window.elementChanged=Et)});"Deno"in globalThis||Promise.resolve().then(()=>($(),R)).then(t=>{t.registerListener(bt)});function bt(t){console.log("Initializing editor");let e=!1,n=document.createElement("button");n.className=t("fixed right-4 bottom-4 whitespace-nowrap text-lg"),n.innerText="\u{1F433}\u{1F4A8}",n.onclick=async()=>{let r=await Promise.resolve().then(()=>(tt(),Z));e?r.toggleEditorVisibility():(e=!0,r.createEditor())},document.body.appendChild(n)}
